<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.2/font/bootstrap-icons.css">

    <title>Nethermind Optimism Plugin Integration</title>

    <link rel="icon" type="image/x-icon" href="nethermind_logo.png">

    <style>
        .line-stat {
            width: 14rem;
            float: right;
        }
        .line-stat div {
            width: 50%;
        }
        .text-add-ignored {
            color: #93ad93;
            font-style: italic;
        }
        .text-delete-ignored {
            color: #c47777;
            font-style: italic;
        }
        .toplevelstat {
            margin-left: 0 !important;
            width: 15rem;
        }
    </style>

    
<style>
    .term-container {
        background: #171717;
        border-radius: 5px;
        color: white;
        word-break: break-word;
        overflow-wrap: break-word;
        font-family: "SFMono-Regular", Monaco, Menlo, Consolas, "Liberation Mono", Courier, monospace;
        font-size: 12px;
        line-height: 20px;
        padding: 14px 18px;
        white-space: pre-wrap;
    }

    .term-container img { max-width: 100%; }

    .term a { color: inherit; text-decoration: underline; text-decoration-style: dashed; }
    .term a:hover { color: #2882F9 }

    @keyframes blink-animation {
        to {
            visibility: hidden;
        }
    }

    .term-fg1 { } /* don't bold beccause it looks weird */
    .term-fg2 { color: #838887; } /* faint (decreased intensity) - same as gray really */
    .term-fg3 { font-style: italic; } /* italic */
    .term-fg4 { text-decoration: underline; } /* underline */
    .term-fg5 { animation: blink-animation 1s steps(3, start) infinite; } /* blink */
    .term-fg9 { text-decoration: line-through; } /* crossed-out */

    .term-fg30 { color: #666666; } /* black (but we can't use black, so a diff color) */
    .term-fg31 { color: #ff7070; } /* red */
    .term-fg32 { color: #b0f986; } /* green */
    .term-fg33 { color: #c6c502; } /* yellow */
    .term-fg34 { color: #8db7e0; } /* blue */
    .term-fg35 { color: #f271fb; } /* magenta */
    .term-fg36 { color: #6bf7ff; } /* cyan */

    /* high intense colors */
    .term-fgi1 { color: #5ef765; }
    .term-fgi90 { color: #838887; } /* grey */
    .term-fgi91 { color: #ff3333; } /* red */
    .term-fgi92 { color: #00FF00; } /* green */
    .term-fgi93 { color: #fffc67; } /* yellow */
    .term-fgi94 { color: #6871ff; } /* blue */
    .term-fgi95 { color: #ff76ff; } /* magenta */
    .term-fgi96 { color: #60fcff; } /* cyan */

    /* background colors */
    .term-bg40 { background: #676767; } /* grey */
    .term-bg41 { background: #ff4343; } /* red */
    .term-bg42 { background: #99ff5f; } /* green */

    /* custom foreground/background combos for readability */
    .term-fg31.term-bg40 { color: #F8A39F; }

    /* xterm colors */
    .term-fgx16 { color: #000000; }
    .term-fgx17 { color: #00005f; }
    .term-fgx18 { color: #000087; }
    .term-fgx19 { color: #0000af; }
    .term-fgx20 { color: #0000d7; }
    .term-fgx21 { color: #0000ff; }
    .term-fgx22 { color: #005f00; }
    .term-fgx23 { color: #005f5f; }
    .term-fgx24 { color: #005f87; }
    .term-fgx25 { color: #005faf; }
    .term-fgx26 { color: #005fd7; }
    .term-fgx27 { color: #005fff; }
    .term-fgx28 { color: #008700; }
    .term-fgx29 { color: #00875f; }
    .term-fgx30 { color: #008787; }
    .term-fgx31 { color: #0087af; }
    .term-fgx32 { color: #0087d7; }
    .term-fgx33 { color: #0087ff; }
    .term-fgx34 { color: #00af00; }
    .term-fgx35 { color: #00af5f; }
    .term-fgx36 { color: #00af87; }
    .term-fgx37 { color: #00afaf; }
    .term-fgx38 { color: #00afd7; }
    .term-fgx39 { color: #00afff; }
    .term-fgx40 { color: #00d700; }
    .term-fgx41 { color: #00d75f; }
    .term-fgx42 { color: #00d787; }
    .term-fgx43 { color: #00d7af; }
    .term-fgx44 { color: #00d7d7; }
    .term-fgx45 { color: #00d7ff; }
    .term-fgx46 { color: #00ff00; }
    .term-fgx47 { color: #00ff5f; }
    .term-fgx48 { color: #00ff87; }
    .term-fgx49 { color: #00ffaf; }
    .term-fgx50 { color: #00ffd7; }
    .term-fgx51 { color: #00ffff; }
    .term-fgx52 { color: #5f0000; }
    .term-fgx53 { color: #5f005f; }
    .term-fgx54 { color: #5f0087; }
    .term-fgx55 { color: #5f00af; }
    .term-fgx56 { color: #5f00d7; }
    .term-fgx57 { color: #5f00ff; }
    .term-fgx58 { color: #5f5f00; }
    .term-fgx59 { color: #5f5f5f; }
    .term-fgx60 { color: #5f5f87; }
    .term-fgx61 { color: #5f5faf; }
    .term-fgx62 { color: #5f5fd7; }
    .term-fgx63 { color: #5f5fff; }
    .term-fgx64 { color: #5f8700; }
    .term-fgx65 { color: #5f875f; }
    .term-fgx66 { color: #5f8787; }
    .term-fgx67 { color: #5f87af; }
    .term-fgx68 { color: #5f87d7; }
    .term-fgx69 { color: #5f87ff; }
    .term-fgx70 { color: #5faf00; }
    .term-fgx71 { color: #5faf5f; }
    .term-fgx72 { color: #5faf87; }
    .term-fgx73 { color: #5fafaf; }
    .term-fgx74 { color: #5fafd7; }
    .term-fgx75 { color: #5fafff; }
    .term-fgx76 { color: #5fd700; }
    .term-fgx77 { color: #5fd75f; }
    .term-fgx78 { color: #5fd787; }
    .term-fgx79 { color: #5fd7af; }
    .term-fgx80 { color: #5fd7d7; }
    .term-fgx81 { color: #5fd7ff; }
    .term-fgx82 { color: #5fff00; }
    .term-fgx83 { color: #5fff5f; }
    .term-fgx84 { color: #5fff87; }
    .term-fgx85 { color: #5fffaf; }
    .term-fgx86 { color: #5fffd7; }
    .term-fgx87 { color: #5fffff; }
    .term-fgx88 { color: #870000; }
    .term-fgx89 { color: #87005f; }
    .term-fgx90 { color: #870087; }
    .term-fgx91 { color: #8700af; }
    .term-fgx92 { color: #8700d7; }
    .term-fgx93 { color: #8700ff; }
    .term-fgx94 { color: #875f00; }
    .term-fgx95 { color: #875f5f; }
    .term-fgx96 { color: #875f87; }
    .term-fgx97 { color: #875faf; }
    .term-fgx98 { color: #875fd7; }
    .term-fgx99 { color: #875fff; }
    .term-fgx100 { color: #878700; }
    .term-fgx101 { color: #87875f; }
    .term-fgx102 { color: #878787; }
    .term-fgx103 { color: #8787af; }
    .term-fgx104 { color: #8787d7; }
    .term-fgx105 { color: #8787ff; }
    .term-fgx106 { color: #87af00; }
    .term-fgx107 { color: #87af5f; }
    .term-fgx108 { color: #87af87; }
    .term-fgx109 { color: #87afaf; }
    .term-fgx110 { color: #87afd7; }
    .term-fgx111 { color: #87afff; }
    .term-fgx112 { color: #87d700; }
    .term-fgx113 { color: #87d75f; }
    .term-fgx114 { color: #87d787; }
    .term-fgx115 { color: #87d7af; }
    .term-fgx116 { color: #87d7d7; }
    .term-fgx117 { color: #87d7ff; }
    .term-fgx118 { color: #87ff00; }
    .term-fgx119 { color: #87ff5f; }
    .term-fgx120 { color: #87ff87; }
    .term-fgx121 { color: #87ffaf; }
    .term-fgx122 { color: #87ffd7; }
    .term-fgx123 { color: #87ffff; }
    .term-fgx124 { color: #af0000; }
    .term-fgx125 { color: #af005f; }
    .term-fgx126 { color: #af0087; }
    .term-fgx127 { color: #af00af; }
    .term-fgx128 { color: #af00d7; }
    .term-fgx129 { color: #af00ff; }
    .term-fgx130 { color: #af5f00; }
    .term-fgx131 { color: #af5f5f; }
    .term-fgx132 { color: #af5f87; }
    .term-fgx133 { color: #af5faf; }
    .term-fgx134 { color: #af5fd7; }
    .term-fgx135 { color: #af5fff; }
    .term-fgx136 { color: #af8700; }
    .term-fgx137 { color: #af875f; }
    .term-fgx138 { color: #af8787; }
    .term-fgx139 { color: #af87af; }
    .term-fgx140 { color: #af87d7; }
    .term-fgx141 { color: #af87ff; }
    .term-fgx142 { color: #afaf00; }
    .term-fgx143 { color: #afaf5f; }
    .term-fgx144 { color: #afaf87; }
    .term-fgx145 { color: #afafaf; }
    .term-fgx146 { color: #afafd7; }
    .term-fgx147 { color: #afafff; }
    .term-fgx148 { color: #afd700; }
    .term-fgx149 { color: #afd75f; }
    .term-fgx150 { color: #afd787; }
    .term-fgx151 { color: #afd7af; }
    .term-fgx152 { color: #afd7d7; }
    .term-fgx153 { color: #afd7ff; }
    .term-fgx154 { color: #afff00; }
    .term-fgx155 { color: #afff5f; }
    .term-fgx156 { color: #afff87; }
    .term-fgx157 { color: #afffaf; }
    .term-fgx158 { color: #afffd7; }
    .term-fgx159 { color: #afffff; }
    .term-fgx160 { color: #d70000; }
    .term-fgx161 { color: #d7005f; }
    .term-fgx162 { color: #d70087; }
    .term-fgx163 { color: #d700af; }
    .term-fgx164 { color: #d700d7; }
    .term-fgx165 { color: #d700ff; }
    .term-fgx166 { color: #d75f00; }
    .term-fgx167 { color: #d75f5f; }
    .term-fgx168 { color: #d75f87; }
    .term-fgx169 { color: #d75faf; }
    .term-fgx170 { color: #d75fd7; }
    .term-fgx171 { color: #d75fff; }
    .term-fgx172 { color: #d78700; }
    .term-fgx173 { color: #d7875f; }
    .term-fgx174 { color: #d78787; }
    .term-fgx175 { color: #d787af; }
    .term-fgx176 { color: #d787d7; }
    .term-fgx177 { color: #d787ff; }
    .term-fgx178 { color: #d7af00; }
    .term-fgx179 { color: #d7af5f; }
    .term-fgx180 { color: #d7af87; }
    .term-fgx181 { color: #d7afaf; }
    .term-fgx182 { color: #d7afd7; }
    .term-fgx183 { color: #d7afff; }
    .term-fgx184 { color: #d7d700; }
    .term-fgx185 { color: #d7d75f; }
    .term-fgx186 { color: #d7d787; }
    .term-fgx187 { color: #d7d7af; }
    .term-fgx188 { color: #d7d7d7; }
    .term-fgx189 { color: #d7d7ff; }
    .term-fgx190 { color: #d7ff00; }
    .term-fgx191 { color: #d7ff5f; }
    .term-fgx192 { color: #d7ff87; }
    .term-fgx193 { color: #d7ffaf; }
    .term-fgx194 { color: #d7ffd7; }
    .term-fgx195 { color: #d7ffff; }
    .term-fgx196 { color: #ff0000; }
    .term-fgx197 { color: #ff005f; }
    .term-fgx198 { color: #ff0087; }
    .term-fgx199 { color: #ff00af; }
    .term-fgx200 { color: #ff00d7; }
    .term-fgx201 { color: #ff00ff; }
    .term-fgx202 { color: #ff5f00; }
    .term-fgx203 { color: #ff5f5f; }
    .term-fgx204 { color: #ff5f87; }
    .term-fgx205 { color: #ff5faf; }
    .term-fgx206 { color: #ff5fd7; }
    .term-fgx207 { color: #ff5fff; }
    .term-fgx208 { color: #ff8700; }
    .term-fgx209 { color: #ff875f; }
    .term-fgx210 { color: #ff8787; }
    .term-fgx211 { color: #ff87af; }
    .term-fgx212 { color: #ff87d7; }
    .term-fgx213 { color: #ff87ff; }
    .term-fgx214 { color: #ffaf00; }
    .term-fgx215 { color: #ffaf5f; }
    .term-fgx216 { color: #ffaf87; }
    .term-fgx217 { color: #ffafaf; }
    .term-fgx218 { color: #ffafd7; }
    .term-fgx219 { color: #ffafff; }
    .term-fgx220 { color: #ffd700; }
    .term-fgx221 { color: #ffd75f; }
    .term-fgx222 { color: #ffd787; }
    .term-fgx223 { color: #ffd7af; }
    .term-fgx224 { color: #ffd7d7; }
    .term-fgx225 { color: #ffd7ff; }
    .term-fgx226 { color: #ffff00; }
    .term-fgx227 { color: #ffff5f; }
    .term-fgx228 { color: #ffff87; }
    .term-fgx229 { color: #ffffaf; }
    .term-fgx230 { color: #ffffd7; }
    .term-fgx231 { color: #ffffff; }
    .term-fgx232 { color: #080808; }
    .term-fgx233 { color: #121212; }
    .term-fgx234 { color: #1c1c1c; }
    .term-fgx235 { color: #262626; }
    .term-fgx236 { color: #303030; }
    .term-fgx237 { color: #3a3a3a; }
    .term-fgx238 { color: #444444; }
    .term-fgx239 { color: #4e4e4e; }
    .term-fgx240 { color: #585858; }
    .term-fgx241 { color: #626262; }
    .term-fgx242 { color: #6c6c6c; }
    .term-fgx243 { color: #767676; }
    .term-fgx244 { color: #808080; }
    .term-fgx245 { color: #8a8a8a; }
    .term-fgx246 { color: #949494; }
    .term-fgx247 { color: #9e9e9e; }
    .term-fgx248 { color: #a8a8a8; }
    .term-fgx249 { color: #b2b2b2; }
    .term-fgx250 { color: #bcbcbc; }
    .term-fgx251 { color: #c6c6c6; }
    .term-fgx252 { color: #d0d0d0; }
    .term-fgx253 { color: #dadada; }
    .term-fgx254 { color: #e4e4e4; }
    .term-fgx255 { color: #eeeeee; }
</style>

</head>
<body>
    <div class="col-xl-10 col-xxl-8 mx-auto px-3 py-1 py-md-3">
        <main class="container-fluid">
            <div class="row">
                <div>
                    <div class="float-end">
                        <div class="form-check form-switch">
                            <i class="bi bi-brightness-low" id="dark-mode-icon"></i>
                            <input class="form-check-input" type="checkbox" role="switch" id="dark-mode-toggle" data-bs-toggle="tooltip"
                                   data-bs-placement="bottom" data-bs-title="Toggle Dark Mode"/>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"role="button" aria-expanded="true" aria-controls="id-dd21d0a5d5c14540ca5a8175">
        
            <div class="col-12 col-md-12 col-lg-6 col-xl-6 text-start"><h1>Nethermind Optimism Plugin Integration Diff</h1></div>
        

        <div class="col-6 col-md-3 col-xl-2 ms-auto mt-2">
            <div class="row line-stat">
                
                    <span class="text-end">diff:</span>
                
                
                    <span class="text-end">ignored:</span>
                
            </div>
        </div>
        <div class="col-6 col-md-3 col-xl-2 ms-auto mt-2 toplevelstat">
            <div class="row line-stat">
                
                    <div class="text-end"><span class="text-success">+3784</span></div>
                    <div class="text-start"><span class="text-danger">-0</span></div>
                
                
                    <div class="text-end"><span class="text-add-ignored">+0</span></div>
                    <div class="text-start"><span class="text-delete-ignored">-38</span></div>
                
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse show border-1 ps-3 my-3" id="id-dd21d0a5d5c14540ca5a8175">
        <div><p>This diff shows the changes made to integrate the Optimism plugin into Nethermind.
The base branch without the Optimism plugin can be found at <a href="https://github.com/NethermindEth/nethermind/tree/no-op-plugin"><code>github.com/NethermindEth/nethermind/tree/no-op-plugin</code></a>.
The master branch with the Optimism plugin can be found at <a href="https://github.com/NethermindEth/nethermind/tree/master"><code>github.com/NethermindEth/nethermind</code></a>.</p>
</div>
        <div>
            
            
        </div>
        <div>
            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-8dde9fbaf9c5b0818a59dc0c"role="button" aria-expanded="false" aria-controls="id-8dde9fbaf9c5b0818a59dc0c">
        
            <div class="col-12 col-md-12 col-lg-6 col-xl-6 text-start"><h2>Optimism Plugin</h2></div>
        

        <div class="col-6 col-md-3 col-xl-2 ms-auto mt-2">
            <div class="row line-stat">
                
                
            </div>
        </div>
        <div class="col-6 col-md-3 col-xl-2 ms-auto mt-2 ">
            <div class="row line-stat">
                
                    <div class="text-end"><span class="text-success">+3487</span></div>
                    <div class="text-start"><span class="text-danger">-0</span></div>
                
                
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-8dde9fbaf9c5b0818a59dc0c">
        <div><p>This section shows the addition of the Nethermind.Optimism directory and its contents.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-08602d0fcb4ac33d36083285" role="button"
                       aria-expanded="false" aria-controls="id-08602d0fcb4ac33d36083285">
                        <code>src/Nethermind/Nethermind.Optimism/Create2DeployerContractRewriter.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Create2DeployerContractRewriter.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+25</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-08602d0fcb4ac33d36083285"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Create2DeployerContractRewriter.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Create2DeployerContractRewriter.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..96cf2f65e427685c66d8a35a89c5d50936acda98</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Create2DeployerContractRewriter.cs</span>
<span class="term-fg36">@@ -0,0 +1,25 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Blockchain;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Find;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class Create2DeployerContractRewriter(IOptimismSpecHelper opSpecHelper, ISpecProvider specProvider, IBlockTree blockTree)</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public void RewriteContract(BlockHeader header, IWorldState worldState)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        IReleaseSpec spec = specProvider.GetSpec(header);</span>
<span class="term-fg32">+        BlockHeader? parent = blockTree.FindParent(header, BlockTreeLookupOptions.None)?.Header;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        &#47;&#47; A migration at the first block of Canyon unless it&#39;s genesis</span>
<span class="term-fg32">+        if ((parent is null || !opSpecHelper.IsCanyon(parent)) &amp;&amp; opSpecHelper.IsCanyon(header) &amp;&amp; !header.IsGenesis)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            worldState.InsertCode(opSpecHelper.Create2DeployerAddress!, opSpecHelper.Create2DeployerCode, spec);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c94b7c2c90ad3f5768c0e776" role="button"
                       aria-expanded="false" aria-controls="id-c94b7c2c90ad3f5768c0e776">
                        <code>src/Nethermind/Nethermind.Optimism/DepositTxExtensions.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/DepositTxExtensions.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+14</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c94b7c2c90ad3f5768c0e776"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;DepositTxExtensions.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;DepositTxExtensions.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..5c908bb730d1779fc25944ae9d80e0746e9b2e60</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;DepositTxExtensions.cs</span>
<span class="term-fg36">@@ -0,0 +1,14 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public static class DepositTxExtensions</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public static bool IsDeposit(this Transaction tx)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return tx.Type == TxType.DepositTx;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-54190bb8de9576039dc9fef2" role="button"
                       aria-expanded="false" aria-controls="id-54190bb8de9576039dc9fef2">
                        <code>src/Nethermind/Nethermind.Optimism/IL1CostHelper.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/IL1CostHelper.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+13</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-54190bb8de9576039dc9fef2"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;IL1CostHelper.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;IL1CostHelper.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..9342c78fe4f60036d2e9fbe752738fe0c8f197d0</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;IL1CostHelper.cs</span>
<span class="term-fg36">@@ -0,0 +1,13 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Int256;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public interface IL1CostHelper</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    UInt256 ComputeL1Cost(Transaction tx, BlockHeader header, IWorldState worldState);</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-849253fc1460159fe5625e69" role="button"
                       aria-expanded="false" aria-controls="id-849253fc1460159fe5625e69">
                        <code>src/Nethermind/Nethermind.Optimism/IOptimismConfig.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/IOptimismConfig.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+12</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-849253fc1460159fe5625e69"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;IOptimismConfig.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;IOptimismConfig.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..074f8149769184906a5ad16a9f88ff7b018d3cc7</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;IOptimismConfig.cs</span>
<span class="term-fg36">@@ -0,0 +1,12 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Config;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public interface IOptimismConfig : IConfig</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    [ConfigItem(Description = &quot;The sequencer address.&quot;, DefaultValue = &quot;null&quot;)]</span>
<span class="term-fg32">+    string? SequencerUrl { get; set; }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-55a14456bc8457e89a5a55ee" role="button"
                       aria-expanded="false" aria-controls="id-55a14456bc8457e89a5a55ee">
                        <code>src/Nethermind/Nethermind.Optimism/IOptimismSpecHelper.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/IOptimismSpecHelper.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+19</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-55a14456bc8457e89a5a55ee"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;IOptimismSpecHelper.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;IOptimismSpecHelper.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..5874e01fa86983bc59c54a63bc50bbd166327608</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;IOptimismSpecHelper.cs</span>
<span class="term-fg36">@@ -0,0 +1,19 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public interface IOptimismSpecHelper</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    Address L1FeeReceiver { get; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    bool IsBedrock(BlockHeader header);</span>
<span class="term-fg32">+    bool IsRegolith(BlockHeader header);</span>
<span class="term-fg32">+    bool IsCanyon(BlockHeader header);</span>
<span class="term-fg32">+    bool IsEcotone(BlockHeader header);</span>
<span class="term-fg32">+    bool IsFjord(BlockHeader header);</span>
<span class="term-fg32">+    Address? Create2DeployerAddress { get; }</span>
<span class="term-fg32">+    byte[]? Create2DeployerCode { get; }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7cb841868d57393124e08e4c" role="button"
                       aria-expanded="false" aria-controls="id-7cb841868d57393124e08e4c">
                        <code>src/Nethermind/Nethermind.Optimism/InitializeBlockProducerOptimism.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/InitializeBlockProducerOptimism.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+68</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7cb841868d57393124e08e4c"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;InitializeBlockProducerOptimism.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;InitializeBlockProducerOptimism.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..06111a6445e5b74a67475c5a68d6e071c8e5b47b</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;InitializeBlockProducerOptimism.cs</span>
<span class="term-fg36">@@ -0,0 +1,68 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Api;</span>
<span class="term-fg32">+using Nethermind.Config;</span>
<span class="term-fg32">+using Nethermind.Consensus;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Init.Steps;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class InitializeBlockProducerOptimism : InitializeBlockProducer</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly OptimismNethermindApi _api;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public InitializeBlockProducerOptimism(OptimismNethermindApi api) : base(api)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _api = api;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override IBlockProducer BuildProducer()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (_api.DbProvider is null) throw new StepDependencyException(nameof(_api.DbProvider));</span>
<span class="term-fg32">+        if (_api.BlockTree is null) throw new StepDependencyException(nameof(_api.BlockTree));</span>
<span class="term-fg32">+        if (_api.SpecProvider is null) throw new StepDependencyException(nameof(_api.SpecProvider));</span>
<span class="term-fg32">+        if (_api.RewardCalculatorSource is null) throw new StepDependencyException(nameof(_api.RewardCalculatorSource));</span>
<span class="term-fg32">+        if (_api.ReceiptStorage is null) throw new StepDependencyException(nameof(_api.ReceiptStorage));</span>
<span class="term-fg32">+        if (_api.TxPool is null) throw new StepDependencyException(nameof(_api.TxPool));</span>
<span class="term-fg32">+        if (_api.TransactionComparerProvider is null) throw new StepDependencyException(nameof(_api.TransactionComparerProvider));</span>
<span class="term-fg32">+        if (_api.BlockValidator is null) throw new StepDependencyException(nameof(_api.BlockValidator));</span>
<span class="term-fg32">+        if (_api.SpecHelper is null) throw new StepDependencyException(nameof(_api.SpecHelper));</span>
<span class="term-fg32">+        if (_api.L1CostHelper is null) throw new StepDependencyException(nameof(_api.L1CostHelper));</span>
<span class="term-fg32">+        if (_api.WorldStateManager is null) throw new StepDependencyException(nameof(_api.WorldStateManager));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _api.BlockProducerEnvFactory = new OptimismBlockProducerEnvFactory(</span>
<span class="term-fg32">+            _api.WorldStateManager,</span>
<span class="term-fg32">+            _api.BlockTree,</span>
<span class="term-fg32">+            _api.SpecProvider,</span>
<span class="term-fg32">+            _api.BlockValidator,</span>
<span class="term-fg32">+            _api.RewardCalculatorSource,</span>
<span class="term-fg32">+            _api.ReceiptStorage,</span>
<span class="term-fg32">+            _api.BlockPreprocessor,</span>
<span class="term-fg32">+            _api.TxPool,</span>
<span class="term-fg32">+            _api.TransactionComparerProvider,</span>
<span class="term-fg32">+            _api.Config&lt;IBlocksConfig&gt;(),</span>
<span class="term-fg32">+            _api.SpecHelper,</span>
<span class="term-fg32">+            _api.L1CostHelper,</span>
<span class="term-fg32">+            _api.LogManager);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _api.GasLimitCalculator = new OptimismGasLimitCalculator();</span>
<span class="term-fg32">+        BlockProducerEnv producerEnv = _api.BlockProducerEnvFactory.Create();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _api.BlockProducer = new OptimismPostMergeBlockProducer(</span>
<span class="term-fg32">+            new OptimismPayloadTxSource(),</span>
<span class="term-fg32">+            producerEnv.TxSource,</span>
<span class="term-fg32">+            producerEnv.ChainProcessor,</span>
<span class="term-fg32">+            producerEnv.BlockTree,</span>
<span class="term-fg32">+            producerEnv.ReadOnlyStateProvider,</span>
<span class="term-fg32">+            _api.GasLimitCalculator,</span>
<span class="term-fg32">+            NullSealEngine.Instance,</span>
<span class="term-fg32">+            new ManualTimestamper(),</span>
<span class="term-fg32">+            _api.SpecProvider,</span>
<span class="term-fg32">+            _api.LogManager,</span>
<span class="term-fg32">+            _api.Config&lt;IBlocksConfig&gt;());</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return _api.BlockProducer;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c41fd982a4aab52971ea1f0e" role="button"
                       aria-expanded="false" aria-controls="id-c41fd982a4aab52971ea1f0e">
                        <code>src/Nethermind/Nethermind.Optimism/InitializeBlockchainOptimism.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/InitializeBlockchainOptimism.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+110</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c41fd982a4aab52971ea1f0e"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;InitializeBlockchainOptimism.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;InitializeBlockchainOptimism.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..561bc844a9e0d7cea3ff6874ba7d125e33a192e7</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;InitializeBlockchainOptimism.cs</span>
<span class="term-fg36">@@ -0,0 +1,110 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System.Threading.Tasks;</span>
<span class="term-fg32">+using Nethermind.Api;</span>
<span class="term-fg32">+using Nethermind.Blockchain.BeaconBlockRoot;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Blocks;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Services;</span>
<span class="term-fg32">+using Nethermind.Config;</span>
<span class="term-fg32">+using Nethermind.Consensus.Processing;</span>
<span class="term-fg32">+using Nethermind.Consensus.Producers;</span>
<span class="term-fg32">+using Nethermind.Consensus.Validators;</span>
<span class="term-fg32">+using Nethermind.Consensus.Withdrawals;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Evm;</span>
<span class="term-fg32">+using Nethermind.Evm.TransactionProcessing;</span>
<span class="term-fg32">+using Nethermind.Init.Steps;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.InvalidChainTracker;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class InitializeBlockchainOptimism(OptimismNethermindApi api) : InitializeBlockchain(api)</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly IBlocksConfig _blocksConfig = api.Config&lt;IBlocksConfig&gt;();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override Task InitBlockchain()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        api.RegisterTxType(TxType.DepositTx, new OptimismTxDecoder&lt;Transaction&gt;(), Always.Valid);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        api.SpecHelper = new(api.ChainSpec.Optimism);</span>
<span class="term-fg32">+        api.L1CostHelper = new(api.SpecHelper, api.ChainSpec.Optimism.L1BlockAddress);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return base.InitBlockchain();</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override ITransactionProcessor CreateTransactionProcessor(CodeInfoRepository codeInfoRepository, VirtualMachine virtualMachine)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (api.SpecProvider is null) throw new StepDependencyException(nameof(api.SpecProvider));</span>
<span class="term-fg32">+        if (api.SpecHelper is null) throw new StepDependencyException(nameof(api.SpecHelper));</span>
<span class="term-fg32">+        if (api.L1CostHelper is null) throw new StepDependencyException(nameof(api.L1CostHelper));</span>
<span class="term-fg32">+        if (api.WorldState is null) throw new StepDependencyException(nameof(api.WorldState));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return new OptimismTransactionProcessor(</span>
<span class="term-fg32">+            api.SpecProvider,</span>
<span class="term-fg32">+            api.WorldState,</span>
<span class="term-fg32">+            virtualMachine,</span>
<span class="term-fg32">+            api.LogManager,</span>
<span class="term-fg32">+            api.L1CostHelper,</span>
<span class="term-fg32">+            api.SpecHelper,</span>
<span class="term-fg32">+            codeInfoRepository</span>
<span class="term-fg32">+        );</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override IHeaderValidator CreateHeaderValidator()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (api.InvalidChainTracker is null) throw new StepDependencyException(nameof(api.InvalidChainTracker));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        OptimismHeaderValidator opHeaderValidator = new(</span>
<span class="term-fg32">+            api.BlockTree,</span>
<span class="term-fg32">+            api.SealValidator,</span>
<span class="term-fg32">+            api.SpecProvider,</span>
<span class="term-fg32">+            api.LogManager);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return new InvalidHeaderInterceptor(opHeaderValidator, api.InvalidChainTracker, api.LogManager);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override IBlockValidator CreateBlockValidator()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (api.InvalidChainTracker is null) throw new StepDependencyException(nameof(api.InvalidChainTracker));</span>
<span class="term-fg32">+        return new InvalidBlockInterceptor(base.CreateBlockValidator(), api.InvalidChainTracker, api.LogManager);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override BlockProcessor CreateBlockProcessor(BlockCachePreWarmer? preWarmer)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        ITransactionProcessor? transactionProcessor = api.TransactionProcessor;</span>
<span class="term-fg32">+        if (api.DbProvider is null) throw new StepDependencyException(nameof(api.DbProvider));</span>
<span class="term-fg32">+        if (api.RewardCalculatorSource is null) throw new StepDependencyException(nameof(api.RewardCalculatorSource));</span>
<span class="term-fg32">+        if (transactionProcessor is null) throw new StepDependencyException(nameof(transactionProcessor));</span>
<span class="term-fg32">+        if (api.SpecHelper is null) throw new StepDependencyException(nameof(api.SpecHelper));</span>
<span class="term-fg32">+        if (api.SpecProvider is null) throw new StepDependencyException(nameof(api.SpecProvider));</span>
<span class="term-fg32">+        if (api.BlockTree is null) throw new StepDependencyException(nameof(api.BlockTree));</span>
<span class="term-fg32">+        if (api.WorldState is null) throw new StepDependencyException(nameof(api.WorldState));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Create2DeployerContractRewriter contractRewriter = new(api.SpecHelper, api.SpecProvider, api.BlockTree);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return new OptimismBlockProcessor(</span>
<span class="term-fg32">+            api.SpecProvider,</span>
<span class="term-fg32">+            api.BlockValidator,</span>
<span class="term-fg32">+            api.RewardCalculatorSource.Get(transactionProcessor),</span>
<span class="term-fg32">+            new BlockProcessor.BlockValidationTransactionsExecutor(transactionProcessor, api.WorldState),</span>
<span class="term-fg32">+            api.WorldState,</span>
<span class="term-fg32">+            api.ReceiptStorage,</span>
<span class="term-fg32">+            transactionProcessor,</span>
<span class="term-fg32">+            new BlockhashStore(api.SpecProvider, api.WorldState),</span>
<span class="term-fg32">+            new BeaconBlockRootHandler(transactionProcessor),</span>
<span class="term-fg32">+            api.LogManager,</span>
<span class="term-fg32">+            api.SpecHelper,</span>
<span class="term-fg32">+            contractRewriter,</span>
<span class="term-fg32">+            new BlockProductionWithdrawalProcessor(new NullWithdrawalProcessor()),</span>
<span class="term-fg32">+            preWarmer: preWarmer);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override IUnclesValidator CreateUnclesValidator() =&gt; Always.Valid;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override IHealthHintService CreateHealthHintService() =&gt;</span>
<span class="term-fg32">+        new ManualHealthHintService(_blocksConfig.SecondsPerSlot * 6, HealthHintConstants.InfinityHint);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override IBlockProductionPolicy CreateBlockProductionPolicy() =&gt; AlwaysStartBlockProductionPolicy.Instance;</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5a40e458bbcc29eb156007b3" role="button"
                       aria-expanded="false" aria-controls="id-5a40e458bbcc29eb156007b3">
                        <code>src/Nethermind/Nethermind.Optimism/L1BlockGasInfo.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/L1BlockGasInfo.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+112</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5a40e458bbcc29eb156007b3"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;L1BlockGasInfo.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;L1BlockGasInfo.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..0df4477eb405f3985985015063052ea7b833f639</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;L1BlockGasInfo.cs</span>
<span class="term-fg36">@@ -0,0 +1,112 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Int256;</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using System.Linq;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public readonly struct L1TxGasInfo(UInt256? l1Fee, UInt256? l1GasPrice, UInt256? l1GasUsed, string? l1FeeScalar, UInt256? l1BaseFeeScalar = null, UInt256? l1BlobBaseFee = null, UInt256? l1BlobBaseFeeScalar = null)</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public UInt256? L1Fee { get; } = l1Fee;</span>
<span class="term-fg32">+    public UInt256? L1GasPrice { get; } = l1GasPrice;</span>
<span class="term-fg32">+    public UInt256? L1GasUsed { get; } = l1GasUsed;</span>
<span class="term-fg32">+    public string? L1FeeScalar { get; } = l1FeeScalar;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public UInt256? L1BaseFeeScalar { get; } = l1BaseFeeScalar;</span>
<span class="term-fg32">+    public UInt256? L1BlobBaseFee { get; } = l1BlobBaseFee;</span>
<span class="term-fg32">+    public UInt256? L1BlobBaseFeeScalar { get; } = l1BlobBaseFeeScalar;</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public readonly struct L1BlockGasInfo</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly UInt256? _l1GasPrice;</span>
<span class="term-fg32">+    private readonly UInt256? _l1BlobBaseFee;</span>
<span class="term-fg32">+    private readonly UInt256? _l1BaseFeeScalar;</span>
<span class="term-fg32">+    private readonly UInt256? _l1BlobBaseFeeScalar;</span>
<span class="term-fg32">+    private readonly UInt256 _l1BaseFee;</span>
<span class="term-fg32">+    private readonly UInt256 _overhead;</span>
<span class="term-fg32">+    private readonly UInt256 _feeScalar;</span>
<span class="term-fg32">+    private readonly string? _feeScalarDecimal;</span>
<span class="term-fg32">+    private readonly bool _isFjord;</span>
<span class="term-fg32">+    private readonly bool _isEcotone;</span>
<span class="term-fg32">+    private readonly bool _isPostRegolith;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private static readonly byte[] BedrockL1AttributesSelector = [0x01, 0x5d, 0x8e, 0xb9];</span>
<span class="term-fg32">+    private readonly IOptimismSpecHelper _specHelper;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public L1BlockGasInfo(Block block, IOptimismSpecHelper specHelper)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _specHelper = specHelper;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (block is not null &amp;&amp; block.Transactions.Length &gt; 0)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            Transaction depositTx = block.Transactions[0];</span>
<span class="term-fg32">+            if (depositTx.Data is null || depositTx.Data.Value.Length &lt; 4)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                return;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            Memory&lt;byte&gt; data = depositTx.Data.Value;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            _isFjord = _specHelper.IsFjord(block.Header);</span>
<span class="term-fg32">+            _isPostRegolith = _specHelper.IsRegolith(block.Header);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            if (_isFjord || (_isEcotone = (_specHelper.IsEcotone(block.Header) &amp;&amp; !data[0..4].Span.SequenceEqual(BedrockL1AttributesSelector))))</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                if (data.Length != 164)</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    return;</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+                _l1GasPrice = new(data[36..68].Span, true);</span>
<span class="term-fg32">+                _l1BlobBaseFee = new(data[68..100].Span, true);</span>
<span class="term-fg32">+                _l1BaseFeeScalar = new(data[4..8].Span, true);</span>
<span class="term-fg32">+                _l1BlobBaseFeeScalar = new(data[8..12].Span, true);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            else</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                if (data.Length &lt; 4 + 32 * 8)</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    return;</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+                _l1GasPrice = new(data[(4 + 32 * 2)..(4 + 32 * 3)].Span, true);</span>
<span class="term-fg32">+                _l1BaseFee = new(data[(4 + 32 * 2)..(4 + 32 * 3)].Span, true);</span>
<span class="term-fg32">+                _overhead = new(data[(4 + 32 * 6)..(4 + 32 * 7)].Span, true);</span>
<span class="term-fg32">+                _feeScalar = new UInt256(data[(4 + 32 * 7)..(4 + 32 * 8)].Span, true);</span>
<span class="term-fg32">+                _feeScalarDecimal = (((ulong)_feeScalar) &#47; 1_000_000m).ToString();</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public readonly L1TxGasInfo GetTxGasInfo(Transaction tx)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        UInt256? l1Fee = null;</span>
<span class="term-fg32">+        UInt256? l1GasUsed = null;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (_l1GasPrice is not null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            if (_isFjord)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                UInt256 fastLzSize = OPL1CostHelper.ComputeFlzCompressLen(tx);</span>
<span class="term-fg32">+                l1Fee = OPL1CostHelper.ComputeL1CostFjord(fastLzSize, _l1GasPrice.Value, _l1BlobBaseFee!.Value, _l1BaseFeeScalar!.Value, _l1BlobBaseFeeScalar!.Value, out UInt256 estimatedSize);</span>
<span class="term-fg32">+                l1GasUsed = OPL1CostHelper.ComputeGasUsedFjord(estimatedSize);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            else if (_isEcotone)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                l1GasUsed = OPL1CostHelper.ComputeDataGas(tx, _isPostRegolith);</span>
<span class="term-fg32">+                l1Fee = OPL1CostHelper.ComputeL1CostEcotone(l1GasUsed.Value, _l1GasPrice.Value, _l1BlobBaseFee!.Value, _l1BaseFeeScalar!.Value, _l1BlobBaseFeeScalar!.Value);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            else</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                l1GasUsed = OPL1CostHelper.ComputeDataGas(tx, _isPostRegolith) + _overhead;</span>
<span class="term-fg32">+                l1Fee = OPL1CostHelper.ComputeL1CostPreEcotone(l1GasUsed.Value, _l1BaseFee, _feeScalar);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return new L1TxGasInfo(l1Fee, _l1GasPrice, l1GasUsed, _feeScalarDecimal, _l1BaseFeeScalar, _l1BlobBaseFee, _l1BlobBaseFeeScalar);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3a47b87436e141381820dd0f" role="button"
                       aria-expanded="false" aria-controls="id-3a47b87436e141381820dd0f">
                        <code>src/Nethermind/Nethermind.Optimism/Nethermind.Optimism.csproj</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Nethermind.Optimism.csproj" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+18</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3a47b87436e141381820dd0f"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Nethermind.Optimism.csproj NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Nethermind.Optimism.csproj</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..939e7284adbc65919d91ee28d0be33597225b4ce</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Nethermind.Optimism.csproj</span>
<span class="term-fg36">@@ -0,0 +1,18 @@</span>
<span class="term-fg32">+&lt;Project Sdk=&quot;Microsoft.NET.Sdk&quot;&gt;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+  &lt;PropertyGroup&gt;</span>
<span class="term-fg32">+    &lt;Nullable&gt;enable&lt;&#47;Nullable&gt;</span>
<span class="term-fg32">+    &lt;AllowUnsafeBlocks&gt;true&lt;&#47;AllowUnsafeBlocks&gt;</span>
<span class="term-fg32">+  &lt;&#47;PropertyGroup&gt;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+  &lt;ItemGroup&gt;</span>
<span class="term-fg32">+    &lt;ProjectReference Include=&quot;..\Nethermind.Api\Nethermind.Api.csproj&quot; &#47;&gt;</span>
<span class="term-fg32">+    &lt;ProjectReference Include=&quot;..\Nethermind.Blockchain\Nethermind.Blockchain.csproj&quot; &#47;&gt;</span>
<span class="term-fg32">+    &lt;ProjectReference Include=&quot;..\Nethermind.Core\Nethermind.Core.csproj&quot; &#47;&gt;</span>
<span class="term-fg32">+    &lt;ProjectReference Include=&quot;..\Nethermind.Consensus\Nethermind.Consensus.csproj&quot; &#47;&gt;</span>
<span class="term-fg32">+    &lt;ProjectReference Include=&quot;..\Nethermind.Init\Nethermind.Init.csproj&quot; &#47;&gt;</span>
<span class="term-fg32">+    &lt;ProjectReference Include=&quot;..\Nethermind.JsonRpc\Nethermind.JsonRpc.csproj&quot; &#47;&gt;</span>
<span class="term-fg32">+    &lt;ProjectReference Include=&quot;..\Nethermind.Merge.Plugin\Nethermind.Merge.Plugin.csproj&quot; &#47;&gt;</span>
<span class="term-fg32">+  &lt;&#47;ItemGroup&gt;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&lt;&#47;Project&gt;</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c9c56526ece5b97cb4cf2ae8" role="button"
                       aria-expanded="false" aria-controls="id-c9c56526ece5b97cb4cf2ae8">
                        <code>src/Nethermind/Nethermind.Optimism/OPConfigHelper.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OPConfigHelper.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+46</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c9c56526ece5b97cb4cf2ae8"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OPConfigHelper.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OPConfigHelper.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..c404456c8aa89714bb18d3525f5c032c468f6839</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OPConfigHelper.cs</span>
<span class="term-fg36">@@ -0,0 +1,46 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Specs.ChainSpecStyle;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismSpecHelper(OptimismParameters parameters) : IOptimismSpecHelper</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly long _bedrockBlockNumber = parameters.BedrockBlockNumber;</span>
<span class="term-fg32">+    private readonly ulong _regolithTimestamp = parameters.RegolithTimestamp;</span>
<span class="term-fg32">+    private readonly ulong? _canyonTimestamp = parameters.CanyonTimestamp;</span>
<span class="term-fg32">+    private readonly ulong? _ecotoneTimestamp = parameters.EcotoneTimestamp;</span>
<span class="term-fg32">+    private readonly ulong? _fjordTimestamp = parameters.FjordTimestamp;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Address L1FeeReceiver { get; init; } = parameters.L1FeeRecipient;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public bool IsRegolith(BlockHeader header)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return header.Timestamp &gt;= _regolithTimestamp;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public bool IsBedrock(BlockHeader header)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return header.Number &gt;= _bedrockBlockNumber;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public bool IsCanyon(BlockHeader header)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return header.Timestamp &gt;= _canyonTimestamp;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public bool IsEcotone(BlockHeader header)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return header.Timestamp &gt;= _ecotoneTimestamp;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public bool IsFjord(BlockHeader header)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return header.Timestamp &gt;= _fjordTimestamp;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Address? Create2DeployerAddress { get; } = parameters.Create2DeployerAddress;</span>
<span class="term-fg32">+    public byte[]? Create2DeployerCode { get; } = parameters.Create2DeployerCode;</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-3e8c207ecbe61176116246a6" role="button"
                       aria-expanded="false" aria-controls="id-3e8c207ecbe61176116246a6">
                        <code>src/Nethermind/Nethermind.Optimism/OPL1CostHelper.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OPL1CostHelper.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+246</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-3e8c207ecbe61176116246a6"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OPL1CostHelper.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OPL1CostHelper.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..1cf69cf5ee914dad148f72f5db207bceb8380c34</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OPL1CostHelper.cs</span>
<span class="term-fg36">@@ -0,0 +1,246 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using System.Linq;</span>
<span class="term-fg32">+using System.Runtime.CompilerServices;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Evm;</span>
<span class="term-fg32">+using Nethermind.Int256;</span>
<span class="term-fg32">+using Nethermind.Serialization.Rlp;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OPL1CostHelper(IOptimismSpecHelper opSpecHelper, Address l1BlockAddr) : IL1CostHelper</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly IOptimismSpecHelper _opSpecHelper = opSpecHelper;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private readonly StorageCell _l1BaseFeeSlot = new(l1BlockAddr, new UInt256(1));</span>
<span class="term-fg32">+    private readonly StorageCell _overheadSlot = new(l1BlockAddr, new UInt256(5));</span>
<span class="term-fg32">+    private readonly StorageCell _scalarSlot = new(l1BlockAddr, new UInt256(6));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private static readonly UInt256 BasicDivisor = 1_000_000;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47; Ecotone</span>
<span class="term-fg32">+    private readonly StorageCell _blobBaseFeeSlot = new(l1BlockAddr, new UInt256(7));</span>
<span class="term-fg32">+    private readonly StorageCell _baseFeeScalarSlot = new(l1BlockAddr, new UInt256(3));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private static readonly UInt256 PrecisionMultiplier = 16;</span>
<span class="term-fg32">+    private static readonly UInt256 PrecisionDivisor = PrecisionMultiplier * BasicDivisor;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47; Fjord</span>
<span class="term-fg32">+    private static readonly UInt256 L1CostInterceptNeg = 42_585_600;</span>
<span class="term-fg32">+    private static readonly UInt256 L1CostFastlzCoef = 836_500;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private static readonly UInt256 MinTransactionSizeScaled = 100 * 1_000_000;</span>
<span class="term-fg32">+    private static readonly UInt256 FjordDivisor = 1_000_000_000_000;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [SkipLocalsInit]</span>
<span class="term-fg32">+    public UInt256 ComputeL1Cost(Transaction tx, BlockHeader header, IWorldState worldState)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (tx.IsDeposit())</span>
<span class="term-fg32">+            return UInt256.Zero;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        UInt256 l1BaseFee = new(worldState.Get(_l1BaseFeeSlot), true);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (_opSpecHelper.IsFjord(header))</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            UInt256 blobBaseFee = new(worldState.Get(_blobBaseFeeSlot), true);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            ReadOnlySpan&lt;byte&gt; scalarData = worldState.Get(_baseFeeScalarSlot);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            const int baseFeeFieldsStart = 16;</span>
<span class="term-fg32">+            const int fieldSize = sizeof(uint);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            int l1BaseFeeScalarStart = scalarData.Length &gt; baseFeeFieldsStart ? scalarData.Length - baseFeeFieldsStart : 0;</span>
<span class="term-fg32">+            int l1BaseFeeScalarEnd = l1BaseFeeScalarStart + (scalarData.Length &gt;= baseFeeFieldsStart ? fieldSize : fieldSize - baseFeeFieldsStart + scalarData.Length);</span>
<span class="term-fg32">+            UInt256 l1BaseFeeScalar = new(scalarData[l1BaseFeeScalarStart..l1BaseFeeScalarEnd], true);</span>
<span class="term-fg32">+            UInt256 l1BlobBaseFeeScalar = new(scalarData[l1BaseFeeScalarEnd..(l1BaseFeeScalarEnd + fieldSize)], true);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            uint fastLzSize = ComputeFlzCompressLen(tx);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            return ComputeL1CostFjord(fastLzSize, l1BaseFee, blobBaseFee, l1BaseFeeScalar, l1BlobBaseFeeScalar, out _);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        UInt256 dataGas = ComputeDataGas(tx, _opSpecHelper.IsRegolith(header));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (dataGas.IsZero)</span>
<span class="term-fg32">+            return UInt256.Zero;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (_opSpecHelper.IsEcotone(header))</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            UInt256 blobBaseFee = new(worldState.Get(_blobBaseFeeSlot), true);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            ReadOnlySpan&lt;byte&gt; scalarData = worldState.Get(_baseFeeScalarSlot);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            const int baseFeeFieldsStart = 16;</span>
<span class="term-fg32">+            const int fieldSize = sizeof(uint);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            int l1BaseFeeScalarStart = scalarData.Length &gt; baseFeeFieldsStart ? scalarData.Length - baseFeeFieldsStart : 0;</span>
<span class="term-fg32">+            int l1BaseFeeScalarEnd = l1BaseFeeScalarStart + (scalarData.Length &gt;= baseFeeFieldsStart ? fieldSize : fieldSize - baseFeeFieldsStart + scalarData.Length);</span>
<span class="term-fg32">+            UInt256 l1BaseFeeScalar = new(scalarData[l1BaseFeeScalarStart..l1BaseFeeScalarEnd], true);</span>
<span class="term-fg32">+            UInt256 l1BlobBaseFeeScalar = new(scalarData[l1BaseFeeScalarEnd..(l1BaseFeeScalarEnd + fieldSize)], true);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            return ComputeL1CostEcotone(dataGas, l1BaseFee, blobBaseFee, l1BaseFeeScalar, l1BlobBaseFeeScalar);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        else</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            UInt256 overhead = new(worldState.Get(_overheadSlot), true);</span>
<span class="term-fg32">+            UInt256 feeScalar = new(worldState.Get(_scalarSlot), true);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            return ComputeL1CostPreEcotone(dataGas + overhead, l1BaseFee, feeScalar);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [SkipLocalsInit]</span>
<span class="term-fg32">+    public static UInt256 ComputeDataGas(Transaction tx, bool isRegolith)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        byte[] encoded = Rlp.Encode(tx, RlpBehaviors.SkipTypedWrapping).Bytes;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        long zeroCount = encoded.Count(b =&gt; b == 0);</span>
<span class="term-fg32">+        long nonZeroCount = encoded.Length - zeroCount;</span>
<span class="term-fg32">+        &#47;&#47; Add pre-EIP-3529 overhead</span>
<span class="term-fg32">+        nonZeroCount += isRegolith ? 0 : OptimismConstants.PreRegolithNonZeroCountOverhead;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return (ulong)(zeroCount * GasCostOf.TxDataZero + nonZeroCount * GasCostOf.TxDataNonZeroEip2028);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47; Fjord L1 formula:</span>
<span class="term-fg32">+    &#47;&#47; l1FeeScaled = baseFeeScalar * l1BaseFee * 16 + blobFeeScalar * l1BlobBaseFee</span>
<span class="term-fg32">+    &#47;&#47; estimatedSize = max(minTransactionSize, intercept + fastlzCoef * fastlzSize)</span>
<span class="term-fg32">+    &#47;&#47; l1Cost = estimatedSize * l1FeeScaled &#47; 1e12</span>
<span class="term-fg32">+    public static UInt256 ComputeL1CostFjord(UInt256 fastLzSize, UInt256 l1BaseFee, UInt256 blobBaseFee, UInt256 l1BaseFeeScalar, UInt256 l1BlobBaseFeeScalar, out UInt256 estimatedSize)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        UInt256 l1FeeScaled = l1BaseFeeScalar * l1BaseFee * PrecisionMultiplier + l1BlobBaseFeeScalar * blobBaseFee;</span>
<span class="term-fg32">+        UInt256 fastLzCost = L1CostFastlzCoef * fastLzSize;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (fastLzCost &lt; L1CostInterceptNeg)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            fastLzCost = 0;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        else</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            fastLzCost -= L1CostInterceptNeg;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        estimatedSize = UInt256.Max(MinTransactionSizeScaled, fastLzCost);</span>
<span class="term-fg32">+        return estimatedSize * l1FeeScaled &#47; FjordDivisor;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47; Ecotone formula: (dataGas) * (16 * l1BaseFee * l1BaseFeeScalar + l1BlobBaseFee*l1BlobBaseFeeScalar) &#47; 16e6</span>
<span class="term-fg32">+    public static UInt256 ComputeL1CostEcotone(UInt256 dataGas, UInt256 l1BaseFee, UInt256 blobBaseFee, UInt256 l1BaseFeeScalar, UInt256 l1BlobBaseFeeScalar)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return dataGas * (PrecisionMultiplier * l1BaseFee * l1BaseFeeScalar + blobBaseFee * l1BlobBaseFeeScalar) &#47; PrecisionDivisor;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47; Pre-Ecotone formula: (dataGas + overhead) * l1BaseFee * scalar &#47; 1e6</span>
<span class="term-fg32">+    public static UInt256 ComputeL1CostPreEcotone(UInt256 dataGasWithOverhead, UInt256 l1BaseFee, UInt256 feeScalar)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return dataGasWithOverhead * l1BaseFee * feeScalar &#47; BasicDivisor;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47; Based on:</span>
<span class="term-fg32">+    &#47;&#47; https:&#47;&#47;github.com&#47;ethereum-optimism&#47;op-geth&#47;blob&#47;7c2819836018bfe0ca07c4e4955754834ffad4e0&#47;core&#47;types&#47;rollup_cost.go</span>
<span class="term-fg32">+    &#47;&#47; https:&#47;&#47;github.com&#47;Vectorized&#47;solady&#47;blob&#47;5315d937d79b335c668896d7533ac603adac5315&#47;js&#47;solady.js</span>
<span class="term-fg32">+    &#47;&#47; Do not use SkipLocalsInit, `ht` should be zeros initially</span>
<span class="term-fg32">+    public static uint ComputeFlzCompressLen(Transaction tx)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        byte[] encoded = Rlp.Encode(tx, RlpBehaviors.SkipTypedWrapping).Bytes;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        static uint FlzCompressLen(byte[] data)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            uint n = 0;</span>
<span class="term-fg32">+            Span&lt;uint&gt; ht = stackalloc uint[8192];</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            uint u24(uint i) =&gt; data[i] | ((uint)data[i + 1] &lt;&lt; 8) | ((uint)data[i + 2] &lt;&lt; 16);</span>
<span class="term-fg32">+            uint cmp(uint p, uint q, uint e)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                uint l = 0;</span>
<span class="term-fg32">+                for (e -= q; l &lt; e; l++)</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    if (data[p + (int)l] != data[q + (int)l])</span>
<span class="term-fg32">+                    {</span>
<span class="term-fg32">+                        e = 0;</span>
<span class="term-fg32">+                    }</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+                return l;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            void literals(uint r)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                n += 0x21 * (r &#47; 0x20);</span>
<span class="term-fg32">+                r %= 0x20;</span>
<span class="term-fg32">+                if (r != 0)</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    n += r + 1;</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            void match(uint l)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                l--;</span>
<span class="term-fg32">+                n += 3 * (l &#47; 262);</span>
<span class="term-fg32">+                if (l % 262 &gt;= 6)</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    n += 3;</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+                else</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    n += 2;</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            uint hash(uint v) =&gt; ((2654435769 * v) &gt;&gt; 19) &amp; 0x1fff;</span>
<span class="term-fg32">+            uint setNextHash(uint ip, ref Span&lt;uint&gt; ht)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                ht[(int)hash(u24(ip))] = ip;</span>
<span class="term-fg32">+                return ip + 1;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            uint a = 0;</span>
<span class="term-fg32">+            uint ipLimit = (uint)data.Length - 13;</span>
<span class="term-fg32">+            if (data.Length &lt; 13)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                ipLimit = 0;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            for (uint ip = a + 2; ip &lt; ipLimit;)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                uint d;</span>
<span class="term-fg32">+                uint r;</span>
<span class="term-fg32">+                for (; ; )</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    uint s = u24(ip);</span>
<span class="term-fg32">+                    int h = (int)hash(s);</span>
<span class="term-fg32">+                    r = ht[h];</span>
<span class="term-fg32">+                    ht[h] = ip;</span>
<span class="term-fg32">+                    d = ip - r;</span>
<span class="term-fg32">+                    if (ip &gt;= ipLimit)</span>
<span class="term-fg32">+                    {</span>
<span class="term-fg32">+                        break;</span>
<span class="term-fg32">+                    }</span>
<span class="term-fg32">+                    ip++;</span>
<span class="term-fg32">+                    if (d &lt;= 0x1fff &amp;&amp; s == u24(r))</span>
<span class="term-fg32">+                    {</span>
<span class="term-fg32">+                        break;</span>
<span class="term-fg32">+                    }</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+                if (ip &gt;= ipLimit)</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    break;</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+                ip--;</span>
<span class="term-fg32">+                if (ip &gt; a)</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    literals(ip - a);</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+                uint l = cmp(r + 3, ip + 3, ipLimit + 9);</span>
<span class="term-fg32">+                match(l);</span>
<span class="term-fg32">+                ip = setNextHash(setNextHash(ip + l, ref ht), ref ht);</span>
<span class="term-fg32">+                a = ip;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            literals((uint)data.Length - a);</span>
<span class="term-fg32">+            return n;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        return FlzCompressLen(encoded);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    internal static UInt256 ComputeGasUsedFjord(UInt256 estimatedSize) =&gt; estimatedSize * GasCostOf.TxDataNonZeroEip2028 &#47; BasicDivisor;</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-366440206b58bce8ef52eaaa" role="button"
                       aria-expanded="false" aria-controls="id-366440206b58bce8ef52eaaa">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismBlockProcessor.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismBlockProcessor.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+65</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-366440206b58bce8ef52eaaa"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockProcessor.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockProcessor.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..0c87d77e2a9bb7215bc5117b238911f0e9309408</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockProcessor.cs</span>
<span class="term-fg36">@@ -0,0 +1,65 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using Nethermind.Blockchain.BeaconBlockRoot;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Blocks;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Receipts;</span>
<span class="term-fg32">+using Nethermind.Consensus.Processing;</span>
<span class="term-fg32">+using Nethermind.Consensus.Rewards;</span>
<span class="term-fg32">+using Nethermind.Consensus.Validators;</span>
<span class="term-fg32">+using Nethermind.Consensus.Withdrawals;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Evm.Tracing;</span>
<span class="term-fg32">+using Nethermind.Evm.TransactionProcessing;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismBlockProcessor : BlockProcessor</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly Create2DeployerContractRewriter? _contractRewriter;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismBlockProcessor(</span>
<span class="term-fg32">+        ISpecProvider? specProvider,</span>
<span class="term-fg32">+        IBlockValidator? blockValidator,</span>
<span class="term-fg32">+        IRewardCalculator? rewardCalculator,</span>
<span class="term-fg32">+        IBlockProcessor.IBlockTransactionsExecutor? blockTransactionsExecutor,</span>
<span class="term-fg32">+        IWorldState? stateProvider,</span>
<span class="term-fg32">+        IReceiptStorage? receiptStorage,</span>
<span class="term-fg32">+        ITransactionProcessor transactionProcessor,</span>
<span class="term-fg32">+        IBlockhashStore? blockhashStore,</span>
<span class="term-fg32">+        IBeaconBlockRootHandler? beaconBlockRootHandler,</span>
<span class="term-fg32">+        ILogManager? logManager,</span>
<span class="term-fg32">+        IOptimismSpecHelper opSpecHelper,</span>
<span class="term-fg32">+        Create2DeployerContractRewriter contractRewriter,</span>
<span class="term-fg32">+        IWithdrawalProcessor? withdrawalProcessor = null,</span>
<span class="term-fg32">+        IBlockCachePreWarmer? preWarmer = null)</span>
<span class="term-fg32">+        : base(</span>
<span class="term-fg32">+            specProvider,</span>
<span class="term-fg32">+            blockValidator,</span>
<span class="term-fg32">+            rewardCalculator,</span>
<span class="term-fg32">+            blockTransactionsExecutor,</span>
<span class="term-fg32">+            stateProvider,</span>
<span class="term-fg32">+            receiptStorage,</span>
<span class="term-fg32">+            transactionProcessor,</span>
<span class="term-fg32">+            beaconBlockRootHandler,</span>
<span class="term-fg32">+            blockhashStore,</span>
<span class="term-fg32">+            logManager,</span>
<span class="term-fg32">+            withdrawalProcessor,</span>
<span class="term-fg32">+            ReceiptsRootCalculator.Instance,</span>
<span class="term-fg32">+            preWarmer)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(stateProvider);</span>
<span class="term-fg32">+        _contractRewriter = contractRewriter;</span>
<span class="term-fg32">+        ReceiptsTracer = new OptimismBlockReceiptTracer(opSpecHelper, stateProvider);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override TxReceipt[] ProcessBlock(Block block, IBlockTracer blockTracer, ProcessingOptions options)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _contractRewriter?.RewriteContract(block.Header, _stateProvider);</span>
<span class="term-fg32">+        return base.ProcessBlock(block, blockTracer, options);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7cb1f06c1a07442ebe6343fb" role="button"
                       aria-expanded="false" aria-controls="id-7cb1f06c1a07442ebe6343fb">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismBlockProducerEnvFactory.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismBlockProducerEnvFactory.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+98</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7cb1f06c1a07442ebe6343fb"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockProducerEnvFactory.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockProducerEnvFactory.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..88ee38dd5e3728381047ddc6f390072a7800be4a</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockProducerEnvFactory.cs</span>
<span class="term-fg36">@@ -0,0 +1,98 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Blockchain;</span>
<span class="term-fg32">+using Nethermind.Blockchain.BeaconBlockRoot;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Blocks;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Receipts;</span>
<span class="term-fg32">+using Nethermind.Config;</span>
<span class="term-fg32">+using Nethermind.Consensus.Comparers;</span>
<span class="term-fg32">+using Nethermind.Consensus.Processing;</span>
<span class="term-fg32">+using Nethermind.Consensus.Producers;</span>
<span class="term-fg32">+using Nethermind.Consensus.Rewards;</span>
<span class="term-fg32">+using Nethermind.Consensus.Transactions;</span>
<span class="term-fg32">+using Nethermind.Consensus.Validators;</span>
<span class="term-fg32">+using Nethermind.Consensus.Withdrawals;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Evm.TransactionProcessing;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+using Nethermind.TxPool;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismBlockProducerEnvFactory : BlockProducerEnvFactory</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly OptimismSpecHelper _specHelper;</span>
<span class="term-fg32">+    private readonly OPL1CostHelper _l1CostHelper;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismBlockProducerEnvFactory(</span>
<span class="term-fg32">+        IWorldStateManager worldStateManager,</span>
<span class="term-fg32">+        IBlockTree blockTree,</span>
<span class="term-fg32">+        ISpecProvider specProvider,</span>
<span class="term-fg32">+        IBlockValidator blockValidator,</span>
<span class="term-fg32">+        IRewardCalculatorSource rewardCalculatorSource,</span>
<span class="term-fg32">+        IReceiptStorage receiptStorage,</span>
<span class="term-fg32">+        IBlockPreprocessorStep blockPreprocessorStep,</span>
<span class="term-fg32">+        ITxPool txPool,</span>
<span class="term-fg32">+        ITransactionComparerProvider transactionComparerProvider,</span>
<span class="term-fg32">+        IBlocksConfig blocksConfig,</span>
<span class="term-fg32">+        OptimismSpecHelper specHelper,</span>
<span class="term-fg32">+        OPL1CostHelper l1CostHelper,</span>
<span class="term-fg32">+        ILogManager logManager) : base(</span>
<span class="term-fg32">+            worldStateManager,</span>
<span class="term-fg32">+            blockTree,</span>
<span class="term-fg32">+            specProvider,</span>
<span class="term-fg32">+            blockValidator,</span>
<span class="term-fg32">+            rewardCalculatorSource,</span>
<span class="term-fg32">+            receiptStorage,</span>
<span class="term-fg32">+            blockPreprocessorStep,</span>
<span class="term-fg32">+            txPool,</span>
<span class="term-fg32">+            transactionComparerProvider,</span>
<span class="term-fg32">+            blocksConfig,</span>
<span class="term-fg32">+            logManager)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _specHelper = specHelper;</span>
<span class="term-fg32">+        _l1CostHelper = l1CostHelper;</span>
<span class="term-fg32">+        TransactionsExecutorFactory = new OptimismTransactionsExecutorFactory(specProvider, logManager);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override ReadOnlyTxProcessingEnv CreateReadonlyTxProcessingEnv(IWorldStateManager worldStateManager,</span>
<span class="term-fg32">+        ReadOnlyBlockTree readOnlyBlockTree) =&gt;</span>
<span class="term-fg32">+        new OptimismReadOnlyTxProcessingEnv(worldStateManager, readOnlyBlockTree, _specProvider, _logManager, _l1CostHelper, _specHelper);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override ITxSource CreateTxSourceForProducer(ITxSource? additionalTxSource,</span>
<span class="term-fg32">+        ReadOnlyTxProcessingEnv processingEnv,</span>
<span class="term-fg32">+        ITxPool txPool, IBlocksConfig blocksConfig, ITransactionComparerProvider transactionComparerProvider,</span>
<span class="term-fg32">+        ILogManager logManager)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        ITxSource baseTxSource = base.CreateTxSourceForProducer(additionalTxSource, processingEnv, txPool, blocksConfig,</span>
<span class="term-fg32">+            transactionComparerProvider, logManager);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return new OptimismTxPoolTxSource(baseTxSource);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override BlockProcessor CreateBlockProcessor(</span>
<span class="term-fg32">+        IReadOnlyTxProcessingScope readOnlyTxProcessingEnv,</span>
<span class="term-fg32">+        ISpecProvider specProvider,</span>
<span class="term-fg32">+        IBlockValidator blockValidator,</span>
<span class="term-fg32">+        IRewardCalculatorSource rewardCalculatorSource,</span>
<span class="term-fg32">+        IReceiptStorage receiptStorage,</span>
<span class="term-fg32">+        ILogManager logManager,</span>
<span class="term-fg32">+        IBlocksConfig blocksConfig)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return new OptimismBlockProcessor(specProvider,</span>
<span class="term-fg32">+            blockValidator,</span>
<span class="term-fg32">+            rewardCalculatorSource.Get(readOnlyTxProcessingEnv.TransactionProcessor),</span>
<span class="term-fg32">+            TransactionsExecutorFactory.Create(readOnlyTxProcessingEnv),</span>
<span class="term-fg32">+            readOnlyTxProcessingEnv.WorldState,</span>
<span class="term-fg32">+            receiptStorage,</span>
<span class="term-fg32">+            readOnlyTxProcessingEnv.TransactionProcessor,</span>
<span class="term-fg32">+            new BlockhashStore(specProvider, readOnlyTxProcessingEnv.WorldState),</span>
<span class="term-fg32">+            new BeaconBlockRootHandler(readOnlyTxProcessingEnv.TransactionProcessor),</span>
<span class="term-fg32">+            logManager,</span>
<span class="term-fg32">+            _specHelper,</span>
<span class="term-fg32">+            new Create2DeployerContractRewriter(_specHelper, _specProvider, _blockTree),</span>
<span class="term-fg32">+            new BlockProductionWithdrawalProcessor(new WithdrawalProcessor(readOnlyTxProcessingEnv.WorldState, logManager)));</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-54fe9d5268e71d2672baa027" role="button"
                       aria-expanded="false" aria-controls="id-54fe9d5268e71d2672baa027">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismBlockProductionTransactionPicker.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismBlockProductionTransactionPicker.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+29</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-54fe9d5268e71d2672baa027"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockProductionTransactionPicker.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockProductionTransactionPicker.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..5480936a2f5c0d412babb3f44f384b6bdd5ddd38</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockProductionTransactionPicker.cs</span>
<span class="term-fg36">@@ -0,0 +1,29 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System.Collections.Generic;</span>
<span class="term-fg32">+using Nethermind.Consensus.Processing;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismBlockProductionTransactionPicker : BlockProcessor.BlockProductionTransactionPicker</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public OptimismBlockProductionTransactionPicker(ISpecProvider specProvider) : base(specProvider)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public override BlockProcessor.AddingTxEventArgs CanAddTransaction(Block block, Transaction currentTx,</span>
<span class="term-fg32">+        IReadOnlySet&lt;Transaction&gt; transactionsInBlock, IWorldState stateProvider)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (!currentTx.IsDeposit())</span>
<span class="term-fg32">+            return base.CanAddTransaction(block, currentTx, transactionsInBlock, stateProvider);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        &#47;&#47; Trusting CL with deposit tx validation</span>
<span class="term-fg32">+        BlockProcessor.AddingTxEventArgs args = new(transactionsInBlock.Count, currentTx, block, transactionsInBlock);</span>
<span class="term-fg32">+        OnAddingTransaction(args);</span>
<span class="term-fg32">+        return args;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e38f5f99dff4659cc014353d" role="button"
                       aria-expanded="false" aria-controls="id-e38f5f99dff4659cc014353d">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismBlockReceiptTracer.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismBlockReceiptTracer.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+74</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e38f5f99dff4659cc014353d"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockReceiptTracer.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockReceiptTracer.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..208d02a35e10957f686b9a7b2c5e0c26e8162c5a</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismBlockReceiptTracer.cs</span>
<span class="term-fg36">@@ -0,0 +1,74 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.Evm.Tracing;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismBlockReceiptTracer : BlockReceiptsTracer</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly IOptimismSpecHelper _opSpecHelper;</span>
<span class="term-fg32">+    private readonly IWorldState _worldState;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismBlockReceiptTracer(IOptimismSpecHelper opSpecHelper, IWorldState worldState)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _opSpecHelper = opSpecHelper;</span>
<span class="term-fg32">+        _worldState = worldState;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private (ulong?, ulong?) GetDepositReceiptData(BlockHeader header)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(CurrentTx);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        ulong? depositNonce = null;</span>
<span class="term-fg32">+        ulong? version = null;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (CurrentTx.IsDeposit())</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            depositNonce = _worldState.GetNonce(CurrentTx.SenderAddress!).ToUInt64(null);</span>
<span class="term-fg32">+            &#47;&#47; We write nonce after tx processing, so need to subtract one</span>
<span class="term-fg32">+            if (depositNonce &gt; 0)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                depositNonce--;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            if (_opSpecHelper.IsCanyon(header))</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                version = 1;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return (depositNonce, version);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override TxReceipt BuildReceipt(Address recipient, long spentGas, byte statusCode, LogEntry[] logEntries, Hash256? stateRoot)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        (ulong? depositNonce, ulong? version) = GetDepositReceiptData(Block.Header);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Transaction transaction = CurrentTx!;</span>
<span class="term-fg32">+        OptimismTxReceipt txReceipt = new()</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            Logs = logEntries,</span>
<span class="term-fg32">+            TxType = transaction.Type,</span>
<span class="term-fg32">+            &#47;&#47; Bloom calculated in parallel with other receipts</span>
<span class="term-fg32">+            GasUsedTotal = Block.GasUsed,</span>
<span class="term-fg32">+            StatusCode = statusCode,</span>
<span class="term-fg32">+            Recipient = transaction.IsContractCreation ? null : recipient,</span>
<span class="term-fg32">+            BlockHash = Block.Hash,</span>
<span class="term-fg32">+            BlockNumber = Block.Number,</span>
<span class="term-fg32">+            Index = _currentIndex,</span>
<span class="term-fg32">+            GasUsed = spentGas,</span>
<span class="term-fg32">+            Sender = transaction.SenderAddress,</span>
<span class="term-fg32">+            ContractAddress = transaction.IsContractCreation ? recipient : null,</span>
<span class="term-fg32">+            TxHash = transaction.Hash,</span>
<span class="term-fg32">+            PostTransactionState = stateRoot,</span>
<span class="term-fg32">+            DepositNonce = depositNonce,</span>
<span class="term-fg32">+            DepositReceiptVersion = version</span>
<span class="term-fg32">+        };</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return txReceipt;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b9eeba8d575af11fed1e7517" role="button"
                       aria-expanded="false" aria-controls="id-b9eeba8d575af11fed1e7517">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismConfig.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismConfig.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+9</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b9eeba8d575af11fed1e7517"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismConfig.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismConfig.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..0903acfb3ce6e6f5f4f8be1c41e9d7f7138a0816</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismConfig.cs</span>
<span class="term-fg36">@@ -0,0 +1,9 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismConfig : IOptimismConfig</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public string? SequencerUrl { get; set; } = null;</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-95d6756e995457b615d70308" role="button"
                       aria-expanded="false" aria-controls="id-95d6756e995457b615d70308">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismConstants.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismConstants.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+9</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-95d6756e995457b615d70308"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismConstants.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismConstants.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..81ea8f1c48a944df3aa29cfd233a2ef431739f20</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismConstants.cs</span>
<span class="term-fg36">@@ -0,0 +1,9 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismConstants</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public const long PreRegolithNonZeroCountOverhead = 68;</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-aff2a99ea941ffadc7ecb455" role="button"
                       aria-expanded="false" aria-controls="id-aff2a99ea941ffadc7ecb455">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismEthereumEcdsa.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismEthereumEcdsa.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+36</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-aff2a99ea941ffadc7ecb455"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismEthereumEcdsa.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismEthereumEcdsa.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..f70db353bf7c418ee615e414e23c8675790ed46c</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismEthereumEcdsa.cs</span>
<span class="term-fg36">@@ -0,0 +1,36 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.Crypto;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismEthereumEcdsa : Ecdsa, IEthereumEcdsa</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly IEthereumEcdsa _ethereumEcdsa;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismEthereumEcdsa(IEthereumEcdsa ethereumEcdsa)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _ethereumEcdsa = ethereumEcdsa;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public void Sign(PrivateKey privateKey, Transaction tx, bool isEip155Enabled = true) =&gt; _ethereumEcdsa.Sign(privateKey, tx, isEip155Enabled);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Address? RecoverAddress(Transaction tx, bool useSignatureChainId = false)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (tx.Signature is null &amp;&amp; tx.IsOPSystemTransaction)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return Address.Zero;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        return _ethereumEcdsa.RecoverAddress(tx, useSignatureChainId);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Address? RecoverAddress(Signature signature, Hash256 message) =&gt; _ethereumEcdsa.RecoverAddress(signature, message);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Address? RecoverAddress(Span&lt;byte&gt; signatureBytes, Hash256 message) =&gt; _ethereumEcdsa.RecoverAddress(signatureBytes, message);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public bool Verify(Address sender, Transaction tx) =&gt; _ethereumEcdsa.Verify(sender, tx);</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b637e1942b9c9041752366d0" role="button"
                       aria-expanded="false" aria-controls="id-b637e1942b9c9041752366d0">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismGasLimitCalculator.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismGasLimitCalculator.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+14</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b637e1942b9c9041752366d0"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismGasLimitCalculator.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismGasLimitCalculator.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..5e5a6932e95f1c038f53dd1e1289a5f9c62eb04a</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismGasLimitCalculator.cs</span>
<span class="term-fg36">@@ -0,0 +1,14 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using Nethermind.Consensus;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismGasLimitCalculator : IGasLimitCalculator</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public long GetGasLimit(BlockHeader parentHeader) =&gt;</span>
<span class="term-fg32">+        throw new InvalidOperationException(&quot;GasLimit in Optimism should come from payload attributes.&quot;);</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-84358587fdac5554115e3acd" role="button"
                       aria-expanded="false" aria-controls="id-84358587fdac5554115e3acd">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismHeaderValidator.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismHeaderValidator.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+21</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-84358587fdac5554115e3acd"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismHeaderValidator.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismHeaderValidator.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..32db335b5729dbdfd6c4a68353863f373dbf7553</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismHeaderValidator.cs</span>
<span class="term-fg36">@@ -0,0 +1,21 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Blockchain;</span>
<span class="term-fg32">+using Nethermind.Consensus;</span>
<span class="term-fg32">+using Nethermind.Consensus.Validators;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismHeaderValidator(</span>
<span class="term-fg32">+    IBlockTree? blockTree,</span>
<span class="term-fg32">+    ISealValidator? sealValidator,</span>
<span class="term-fg32">+    ISpecProvider? specProvider,</span>
<span class="term-fg32">+    ILogManager? logManager)</span>
<span class="term-fg32">+    : HeaderValidator(blockTree, sealValidator, specProvider, logManager)</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    protected override bool ValidateGasLimitRange(BlockHeader header, BlockHeader parent, IReleaseSpec spec, ref string? error) =&gt; true;</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8b47e953d38e9e5937b40ae7" role="button"
                       aria-expanded="false" aria-controls="id-8b47e953d38e9e5937b40ae7">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismNethermindApi.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismNethermindApi.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+26</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8b47e953d38e9e5937b40ae7"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismNethermindApi.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismNethermindApi.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..8e1e8f4002d25c84702293522ddcc6358ab96249</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismNethermindApi.cs</span>
<span class="term-fg36">@@ -0,0 +1,26 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Api;</span>
<span class="term-fg32">+using Nethermind.Config;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.InvalidChainTracker;</span>
<span class="term-fg32">+using Nethermind.Serialization.Json;</span>
<span class="term-fg32">+using Nethermind.Specs.ChainSpecStyle;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismNethermindApi : NethermindApi</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public OptimismNethermindApi(</span>
<span class="term-fg32">+        IConfigProvider configProvider,</span>
<span class="term-fg32">+        IJsonSerializer jsonSerializer,</span>
<span class="term-fg32">+        ILogManager logManager,</span>
<span class="term-fg32">+        ChainSpec chainSpec) : base(configProvider, jsonSerializer, logManager, chainSpec)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public IInvalidChainTracker? InvalidChainTracker { get; set; }</span>
<span class="term-fg32">+    public OPL1CostHelper? L1CostHelper { get; set; }</span>
<span class="term-fg32">+    public OptimismSpecHelper? SpecHelper { get; set; }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-e31ee6a260bde07b0865916e" role="button"
                       aria-expanded="false" aria-controls="id-e31ee6a260bde07b0865916e">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismPayloadPreparationService.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismPayloadPreparationService.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+55</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-e31ee6a260bde07b0865916e"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPayloadPreparationService.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPayloadPreparationService.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..35fd2e3abb29ca350099f2eb3533c78313b3315f</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPayloadPreparationService.cs</span>
<span class="term-fg36">@@ -0,0 +1,55 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using Nethermind.Consensus.Producers;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Timers;</span>
<span class="term-fg32">+using Nethermind.Int256;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.BlockProduction;</span>
<span class="term-fg32">+using Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismPayloadPreparationService : PayloadPreparationService</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly ILogger _logger;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismPayloadPreparationService(</span>
<span class="term-fg32">+        PostMergeBlockProducer blockProducer,</span>
<span class="term-fg32">+        IBlockImprovementContextFactory blockImprovementContextFactory,</span>
<span class="term-fg32">+        ITimerFactory timerFactory,</span>
<span class="term-fg32">+        ILogManager logManager,</span>
<span class="term-fg32">+        TimeSpan timePerSlot,</span>
<span class="term-fg32">+        int slotsPerOldPayloadCleanup = SlotsPerOldPayloadCleanup,</span>
<span class="term-fg32">+        TimeSpan? improvementDelay = null,</span>
<span class="term-fg32">+        TimeSpan? minTimeForProduction = null)</span>
<span class="term-fg32">+        : base(</span>
<span class="term-fg32">+            blockProducer,</span>
<span class="term-fg32">+            blockImprovementContextFactory,</span>
<span class="term-fg32">+            timerFactory,</span>
<span class="term-fg32">+            logManager,</span>
<span class="term-fg32">+            timePerSlot,</span>
<span class="term-fg32">+            slotsPerOldPayloadCleanup,</span>
<span class="term-fg32">+            improvementDelay,</span>
<span class="term-fg32">+            minTimeForProduction)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _logger = logManager.GetClassLogger();</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override void ImproveBlock(string payloadId, BlockHeader parentHeader,</span>
<span class="term-fg32">+        PayloadAttributes payloadAttributes, Block currentBestBlock, DateTimeOffset startDateTime)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (payloadAttributes is OptimismPayloadAttributes { NoTxPool: true })</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            if (_logger.IsDebug)</span>
<span class="term-fg32">+                _logger.Debug(&quot;Skip block improvement because of NoTxPool payload attribute.&quot;);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            &#47;&#47; ignore TryAdd failure (it can only happen if payloadId is already in the dictionary)</span>
<span class="term-fg32">+            _payloadStorage.TryAdd(payloadId,</span>
<span class="term-fg32">+                new NoBlockImprovementContext(currentBestBlock, UInt256.Zero, startDateTime));</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        else base.ImproveBlock(payloadId, parentHeader, payloadAttributes, currentBestBlock, startDateTime);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-7a58b3a97433e27b4c58b13c" role="button"
                       aria-expanded="false" aria-controls="id-7a58b3a97433e27b4c58b13c">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismPayloadTxSource.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismPayloadTxSource.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+28</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-7a58b3a97433e27b4c58b13c"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPayloadTxSource.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPayloadTxSource.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..53b23ea2695184f76fa20be6ecb586f9dc3542ac</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPayloadTxSource.cs</span>
<span class="term-fg36">@@ -0,0 +1,28 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System.Collections.Generic;</span>
<span class="term-fg32">+using System.Linq;</span>
<span class="term-fg32">+using Nethermind.Consensus.Producers;</span>
<span class="term-fg32">+using Nethermind.Consensus.Transactions;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismPayloadTxSource : ITxSource</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public IEnumerable&lt;Transaction&gt; GetTransactions(BlockHeader parent, long gasLimit, PayloadAttributes? payloadAttributes)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (payloadAttributes is OptimismPayloadAttributes optimismPayloadAttributes)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            Transaction[]? transactions = optimismPayloadAttributes.GetTransactions();</span>
<span class="term-fg32">+            if (transactions is not null)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                return transactions;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return Enumerable.Empty&lt;Transaction&gt;();</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-364f14b48eb07048b6e6c9e9" role="button"
                       aria-expanded="false" aria-controls="id-364f14b48eb07048b6e6c9e9">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismPlugin.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismPlugin.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+304</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-364f14b48eb07048b6e6c9e9"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPlugin.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPlugin.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..0f45fe0ddbff03ed4c0f3b929ceced83c1943b52</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPlugin.cs</span>
<span class="term-fg36">@@ -0,0 +1,304 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using System.Threading.Tasks;</span>
<span class="term-fg32">+using Nethermind.Api;</span>
<span class="term-fg32">+using Nethermind.Api.Extensions;</span>
<span class="term-fg32">+using Nethermind.Consensus;</span>
<span class="term-fg32">+using Nethermind.Consensus.Producers;</span>
<span class="term-fg32">+using Nethermind.Consensus.Transactions;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.BlockProduction;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.GC;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.Handlers;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules;</span>
<span class="term-fg32">+using Nethermind.Config;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Synchronization;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.InvalidChainTracker;</span>
<span class="term-fg32">+using Nethermind.Blockchain;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Receipts;</span>
<span class="term-fg32">+using Nethermind.Consensus.Rewards;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.Synchronization;</span>
<span class="term-fg32">+using Nethermind.Synchronization.ParallelSync;</span>
<span class="term-fg32">+using Nethermind.HealthChecks;</span>
<span class="term-fg32">+using Nethermind.Serialization.Json;</span>
<span class="term-fg32">+using Nethermind.Specs.ChainSpecStyle;</span>
<span class="term-fg32">+using Nethermind.Serialization.Rlp;</span>
<span class="term-fg32">+using Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules.Eth;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.handlers;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismPlugin : IConsensusPlugin, ISynchronizationPlugin, IInitializationPlugin</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public string Author =&gt; &quot;Nethermind&quot;;</span>
<span class="term-fg32">+    public string Name =&gt; &quot;Optimism&quot;;</span>
<span class="term-fg32">+    public string Description =&gt; &quot;Optimism support for Nethermind&quot;;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private OptimismNethermindApi? _api;</span>
<span class="term-fg32">+    private ILogger _logger;</span>
<span class="term-fg32">+    private IMergeConfig _mergeConfig = null!;</span>
<span class="term-fg32">+    private ISyncConfig _syncConfig = null!;</span>
<span class="term-fg32">+    private IBlocksConfig _blocksConfig = null!;</span>
<span class="term-fg32">+    private BlockCacheService? _blockCacheService;</span>
<span class="term-fg32">+    private InvalidChainTracker? _invalidChainTracker;</span>
<span class="term-fg32">+    private ManualBlockFinalizationManager? _blockFinalizationManager;</span>
<span class="term-fg32">+    private IPeerRefresher? _peerRefresher;</span>
<span class="term-fg32">+    private IBeaconPivot? _beaconPivot;</span>
<span class="term-fg32">+    private BeaconSync? _beaconSync;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public bool ShouldRunSteps(INethermindApi api) =&gt; api.ChainSpec.SealEngineType == SealEngineType;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    #region IConsensusPlugin</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public string SealEngineType =&gt; Core.SealEngineType.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public IBlockProductionTrigger DefaultBlockProductionTrigger =&gt; NeverProduceTrigger.Instance;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public IBlockProducer InitBlockProducer(ITxSource? additionalTxSource = null)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (additionalTxSource is not null)</span>
<span class="term-fg32">+            throw new ArgumentException(</span>
<span class="term-fg32">+                &quot;Optimism does not support additional tx source&quot;);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.BlockProducer);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return _api.BlockProducer;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    #endregion</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public INethermindApi CreateApi(IConfigProvider configProvider, IJsonSerializer jsonSerializer,</span>
<span class="term-fg32">+        ILogManager logManager, ChainSpec chainSpec) =&gt;</span>
<span class="term-fg32">+        new OptimismNethermindApi(configProvider, jsonSerializer, logManager, chainSpec);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public void InitRlpDecoders(INethermindApi api)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (ShouldRunSteps(api))</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            Rlp.RegisterDecoders(typeof(OptimismReceiptMessageDecoder).Assembly, true);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Task Init(INethermindApi api)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (!ShouldRunSteps(api))</span>
<span class="term-fg32">+            return Task.CompletedTask;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _api = (OptimismNethermindApi)api;</span>
<span class="term-fg32">+        _mergeConfig = _api.Config&lt;IMergeConfig&gt;();</span>
<span class="term-fg32">+        _syncConfig = _api.Config&lt;ISyncConfig&gt;();</span>
<span class="term-fg32">+        _blocksConfig = _api.Config&lt;IBlocksConfig&gt;();</span>
<span class="term-fg32">+        _logger = _api.LogManager.GetClassLogger();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.BlockTree);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.EthereumEcdsa);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _api.PoSSwitcher = AlwaysPoS.Instance;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _blockCacheService = new BlockCacheService();</span>
<span class="term-fg32">+        _api.EthereumEcdsa = new OptimismEthereumEcdsa(_api.EthereumEcdsa);</span>
<span class="term-fg32">+        _api.InvalidChainTracker = _invalidChainTracker = new InvalidChainTracker(</span>
<span class="term-fg32">+            _api.PoSSwitcher,</span>
<span class="term-fg32">+            _api.BlockTree,</span>
<span class="term-fg32">+            _blockCacheService,</span>
<span class="term-fg32">+            _api.LogManager);</span>
<span class="term-fg32">+        _api.DisposeStack.Push(_invalidChainTracker);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _api.FinalizationManager = _blockFinalizationManager = new ManualBlockFinalizationManager();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _api.RewardCalculatorSource = NoBlockRewards.Instance;</span>
<span class="term-fg32">+        _api.SealValidator = NullSealEngine.Instance;</span>
<span class="term-fg32">+        _api.GossipPolicy = ShouldNotGossip.Instance;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _api.BlockPreprocessor.AddFirst(new MergeProcessingRecoveryStep(_api.PoSSwitcher));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return Task.CompletedTask;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Task InitSynchronization()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (_api is null || !ShouldRunSteps(_api))</span>
<span class="term-fg32">+            return Task.CompletedTask;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.SpecProvider);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.BlockTree);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.DbProvider);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.PeerDifficultyRefreshPool);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.SyncPeerPool);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.NodeStatsManager);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.BlockchainProcessor);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_blockCacheService);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_invalidChainTracker);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _invalidChainTracker.SetupBlockchainProcessorInterceptor(_api.BlockchainProcessor);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _peerRefresher = new PeerRefresher(_api.PeerDifficultyRefreshPool, _api.TimerFactory, _api.LogManager);</span>
<span class="term-fg32">+        _api.DisposeStack.Push((PeerRefresher)_peerRefresher);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _beaconPivot = new BeaconPivot(_syncConfig, _api.DbProvider.MetadataDb, _api.BlockTree, _api.PoSSwitcher, _api.LogManager);</span>
<span class="term-fg32">+        _beaconSync = new BeaconSync(_beaconPivot, _api.BlockTree, _syncConfig, _blockCacheService, _api.PoSSwitcher, _api.LogManager);</span>
<span class="term-fg32">+        _api.BetterPeerStrategy = new MergeBetterPeerStrategy(null!, _api.PoSSwitcher, _beaconPivot, _api.LogManager);</span>
<span class="term-fg32">+        _api.Pivot = _beaconPivot;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        MergeBlockDownloaderFactory blockDownloaderFactory = new MergeBlockDownloaderFactory(</span>
<span class="term-fg32">+            _api.PoSSwitcher,</span>
<span class="term-fg32">+            _beaconPivot,</span>
<span class="term-fg32">+            _api.SpecProvider,</span>
<span class="term-fg32">+            _api.BlockValidator!,</span>
<span class="term-fg32">+            _api.SealValidator!,</span>
<span class="term-fg32">+            _syncConfig,</span>
<span class="term-fg32">+            _api.BetterPeerStrategy!,</span>
<span class="term-fg32">+            new FullStateFinder(_api.BlockTree, _api.StateReader!),</span>
<span class="term-fg32">+            _api.LogManager);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _api.Synchronizer = new MergeSynchronizer(</span>
<span class="term-fg32">+            _api.DbProvider,</span>
<span class="term-fg32">+            _api.NodeStorageFactory.WrapKeyValueStore(_api.DbProvider.StateDb),</span>
<span class="term-fg32">+            _api.SpecProvider!,</span>
<span class="term-fg32">+            _api.BlockTree!,</span>
<span class="term-fg32">+            _api.ReceiptStorage!,</span>
<span class="term-fg32">+            _api.SyncPeerPool,</span>
<span class="term-fg32">+            _api.NodeStatsManager!,</span>
<span class="term-fg32">+            _syncConfig,</span>
<span class="term-fg32">+            blockDownloaderFactory,</span>
<span class="term-fg32">+            _beaconPivot,</span>
<span class="term-fg32">+            _api.PoSSwitcher,</span>
<span class="term-fg32">+            _mergeConfig,</span>
<span class="term-fg32">+            _invalidChainTracker,</span>
<span class="term-fg32">+            _api.ProcessExit!,</span>
<span class="term-fg32">+            _api.BetterPeerStrategy,</span>
<span class="term-fg32">+            _api.ChainSpec,</span>
<span class="term-fg32">+            _beaconSync,</span>
<span class="term-fg32">+            _api.StateReader!,</span>
<span class="term-fg32">+            _api.LogManager</span>
<span class="term-fg32">+        );</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _ = new PivotUpdator(</span>
<span class="term-fg32">+            _api.BlockTree,</span>
<span class="term-fg32">+            _api.Synchronizer.SyncModeSelector,</span>
<span class="term-fg32">+            _api.SyncPeerPool,</span>
<span class="term-fg32">+            _syncConfig,</span>
<span class="term-fg32">+            _blockCacheService,</span>
<span class="term-fg32">+            _beaconSync,</span>
<span class="term-fg32">+            _api.DbProvider.MetadataDb,</span>
<span class="term-fg32">+            _api.LogManager);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return Task.CompletedTask;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public async Task InitRpcModules()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (_api is null || !ShouldRunSteps(_api))</span>
<span class="term-fg32">+            return;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.SpecProvider);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.BlockProcessingQueue);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.SyncModeSelector);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.BlockTree);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.BlockValidator);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.RpcModuleProvider);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.BlockProducer);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_api.TxPool);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_beaconSync);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_beaconPivot);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_blockCacheService);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_invalidChainTracker);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_blockFinalizationManager);</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(_peerRefresher);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        &#47;&#47; Ugly temporary hack to not receive engine API messages before end of processing of all blocks after restart.</span>
<span class="term-fg32">+        &#47;&#47; Then we will wait 5s more to ensure everything is processed</span>
<span class="term-fg32">+        while (!_api.BlockProcessingQueue.IsEmpty)</span>
<span class="term-fg32">+            await Task.Delay(100);</span>
<span class="term-fg32">+        await Task.Delay(5000);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        BlockImprovementContextFactory improvementContextFactory = new(</span>
<span class="term-fg32">+            _api.BlockProducer,</span>
<span class="term-fg32">+            TimeSpan.FromSeconds(_blocksConfig.SecondsPerSlot));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        OptimismPayloadPreparationService payloadPreparationService = new(</span>
<span class="term-fg32">+            (PostMergeBlockProducer)_api.BlockProducer,</span>
<span class="term-fg32">+            improvementContextFactory,</span>
<span class="term-fg32">+            _api.TimerFactory,</span>
<span class="term-fg32">+            _api.LogManager,</span>
<span class="term-fg32">+            TimeSpan.FromSeconds(_blocksConfig.SecondsPerSlot));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _api.RpcCapabilitiesProvider = new EngineRpcCapabilitiesProvider(_api.SpecProvider);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        IInitConfig initConfig = _api.Config&lt;IInitConfig&gt;();</span>
<span class="term-fg32">+        IEngineRpcModule engineRpcModule = new EngineRpcModule(</span>
<span class="term-fg32">+            new GetPayloadV1Handler(payloadPreparationService, _api.SpecProvider, _api.LogManager),</span>
<span class="term-fg32">+            new GetPayloadV2Handler(payloadPreparationService, _api.SpecProvider, _api.LogManager),</span>
<span class="term-fg32">+            new GetPayloadV3Handler(payloadPreparationService, _api.SpecProvider, _api.LogManager, _api.CensorshipDetector),</span>
<span class="term-fg32">+            new GetPayloadV4Handler(payloadPreparationService, _api.SpecProvider, _api.LogManager, _api.CensorshipDetector),</span>
<span class="term-fg32">+            new NewPayloadHandler(</span>
<span class="term-fg32">+                _api.BlockValidator,</span>
<span class="term-fg32">+                _api.BlockTree,</span>
<span class="term-fg32">+                _syncConfig,</span>
<span class="term-fg32">+                _api.PoSSwitcher,</span>
<span class="term-fg32">+                _beaconSync,</span>
<span class="term-fg32">+                _beaconPivot,</span>
<span class="term-fg32">+                _blockCacheService,</span>
<span class="term-fg32">+                _api.BlockProcessingQueue,</span>
<span class="term-fg32">+                _invalidChainTracker,</span>
<span class="term-fg32">+                _beaconSync,</span>
<span class="term-fg32">+                _api.LogManager,</span>
<span class="term-fg32">+                TimeSpan.FromSeconds(_mergeConfig.NewPayloadTimeout),</span>
<span class="term-fg32">+                _api.Config&lt;IReceiptConfig&gt;().StoreReceipts),</span>
<span class="term-fg32">+            new ForkchoiceUpdatedHandler(</span>
<span class="term-fg32">+                _api.BlockTree,</span>
<span class="term-fg32">+                _blockFinalizationManager,</span>
<span class="term-fg32">+                _api.PoSSwitcher,</span>
<span class="term-fg32">+                payloadPreparationService,</span>
<span class="term-fg32">+                _api.BlockProcessingQueue,</span>
<span class="term-fg32">+                _blockCacheService,</span>
<span class="term-fg32">+                _invalidChainTracker,</span>
<span class="term-fg32">+                _beaconSync,</span>
<span class="term-fg32">+                _beaconPivot,</span>
<span class="term-fg32">+                _peerRefresher,</span>
<span class="term-fg32">+                _api.SpecProvider,</span>
<span class="term-fg32">+                _api.SyncPeerPool!,</span>
<span class="term-fg32">+                _api.LogManager,</span>
<span class="term-fg32">+                _api.Config&lt;IBlocksConfig&gt;().SecondsPerSlot,</span>
<span class="term-fg32">+                _api.Config&lt;IMergeConfig&gt;().SimulateBlockProduction),</span>
<span class="term-fg32">+            new GetPayloadBodiesByHashV1Handler(_api.BlockTree, _api.LogManager),</span>
<span class="term-fg32">+            new GetPayloadBodiesByRangeV1Handler(_api.BlockTree, _api.LogManager),</span>
<span class="term-fg32">+            new GetPayloadBodiesByHashV2Handler(_api.BlockTree, _api.LogManager),</span>
<span class="term-fg32">+            new GetPayloadBodiesByRangeV2Handler(_api.BlockTree, _api.LogManager),</span>
<span class="term-fg32">+            new ExchangeTransitionConfigurationV1Handler(_api.PoSSwitcher, _api.LogManager),</span>
<span class="term-fg32">+            new ExchangeCapabilitiesHandler(_api.RpcCapabilitiesProvider, _api.LogManager),</span>
<span class="term-fg32">+            new GetBlobsHandler(_api.TxPool),</span>
<span class="term-fg32">+            _api.SpecProvider,</span>
<span class="term-fg32">+            new GCKeeper(</span>
<span class="term-fg32">+                initConfig.DisableGcOnNewPayload</span>
<span class="term-fg32">+                    ? NoGCStrategy.Instance</span>
<span class="term-fg32">+                    : new NoSyncGcRegionStrategy(_api.SyncModeSelector, _mergeConfig), _api.LogManager),</span>
<span class="term-fg32">+            _api.LogManager);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        IOptimismEngineRpcModule opEngine = new OptimismEngineRpcModule(engineRpcModule);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        _api.RpcModuleProvider.RegisterSingle(opEngine);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (_logger.IsInfo) _logger.Info(&quot;Optimism Engine Module has been enabled&quot;);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public IBlockProducerRunner CreateBlockProducerRunner()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return new StandardBlockProducerRunner(</span>
<span class="term-fg32">+            DefaultBlockProductionTrigger,</span>
<span class="term-fg32">+            _api!.BlockTree!,</span>
<span class="term-fg32">+            _api.BlockProducer!);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public ValueTask DisposeAsync() =&gt; ValueTask.CompletedTask;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public bool MustInitialize =&gt; true;</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-577348b6956ccf8171fa0788" role="button"
                       aria-expanded="false" aria-controls="id-577348b6956ccf8171fa0788">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismPostMergeBlockProducer.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismPostMergeBlockProducer.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+91</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-577348b6956ccf8171fa0788"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPostMergeBlockProducer.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPostMergeBlockProducer.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..3da889a982b2e500be6a52f772b65bc12d4fe743</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismPostMergeBlockProducer.cs</span>
<span class="term-fg36">@@ -0,0 +1,91 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using System.Collections.Generic;</span>
<span class="term-fg32">+using Nethermind.Blockchain;</span>
<span class="term-fg32">+using Nethermind.Config;</span>
<span class="term-fg32">+using Nethermind.Consensus;</span>
<span class="term-fg32">+using Nethermind.Consensus.Processing;</span>
<span class="term-fg32">+using Nethermind.Consensus.Producers;</span>
<span class="term-fg32">+using Nethermind.Consensus.Transactions;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.BlockProduction;</span>
<span class="term-fg32">+using Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismPostMergeBlockProducer : PostMergeBlockProducer</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly ITxSource _payloadAttrsTxSource;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismPostMergeBlockProducer(</span>
<span class="term-fg32">+        ITxSource payloadAttrsTxSource,</span>
<span class="term-fg32">+        ITxSource txPoolTxSource,</span>
<span class="term-fg32">+        IBlockchainProcessor processor,</span>
<span class="term-fg32">+        IBlockTree blockTree,</span>
<span class="term-fg32">+        IWorldState stateProvider,</span>
<span class="term-fg32">+        IGasLimitCalculator gasLimitCalculator,</span>
<span class="term-fg32">+        ISealEngine sealEngine,</span>
<span class="term-fg32">+        ITimestamper timestamper,</span>
<span class="term-fg32">+        ISpecProvider specProvider,</span>
<span class="term-fg32">+        ILogManager logManager,</span>
<span class="term-fg32">+        IBlocksConfig? miningConfig</span>
<span class="term-fg32">+    ) : base(</span>
<span class="term-fg32">+        payloadAttrsTxSource.Then(txPoolTxSource),</span>
<span class="term-fg32">+        processor,</span>
<span class="term-fg32">+        blockTree,</span>
<span class="term-fg32">+        stateProvider,</span>
<span class="term-fg32">+        gasLimitCalculator,</span>
<span class="term-fg32">+        sealEngine,</span>
<span class="term-fg32">+        timestamper,</span>
<span class="term-fg32">+        specProvider,</span>
<span class="term-fg32">+        logManager,</span>
<span class="term-fg32">+        miningConfig)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _payloadAttrsTxSource = payloadAttrsTxSource;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public override Block PrepareEmptyBlock(BlockHeader parent, PayloadAttributes? payloadAttributes = null)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        OptimismPayloadAttributes attrs = (payloadAttributes as OptimismPayloadAttributes)</span>
<span class="term-fg32">+            ?? throw new InvalidOperationException(&quot;Payload attributes are not set&quot;);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        BlockHeader blockHeader = base.PrepareBlockHeader(parent, attrs);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        IEnumerable&lt;Transaction&gt; txs = _payloadAttrsTxSource.GetTransactions(parent, attrs.GasLimit, attrs);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Block block = new(blockHeader, txs, Array.Empty&lt;BlockHeader&gt;(), payloadAttributes?.Withdrawals);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (_producingBlockLock.Wait(BlockProductionTimeoutMs))</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            try</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                if (TrySetState(parent.StateRoot))</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    return ProcessPreparedBlock(block, null) ?? throw new EmptyBlockProductionException(&quot;Block processing failed&quot;);</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+                else</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    throw new EmptyBlockProductionException($&quot;Setting state for processing block failed: couldn&#39;t set state to stateRoot {parent.StateRoot}&quot;);</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            finally</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                _producingBlockLock.Release();</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        throw new EmptyBlockProductionException(&quot;Setting state for processing block failed&quot;);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override void AmendHeader(BlockHeader blockHeader, BlockHeader parent)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        base.AmendHeader(blockHeader, parent);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        blockHeader.ExtraData = Array.Empty&lt;byte&gt;();</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-f607039311e3dfcf7c3c6bb5" role="button"
                       aria-expanded="false" aria-controls="id-f607039311e3dfcf7c3c6bb5">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismReadOnlyTxProcessingEnv.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismReadOnlyTxProcessingEnv.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+38</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-f607039311e3dfcf7c3c6bb5"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismReadOnlyTxProcessingEnv.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismReadOnlyTxProcessingEnv.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..b374b105bed1135f9c4f265335fb3ac28eaf34d4</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismReadOnlyTxProcessingEnv.cs</span>
<span class="term-fg36">@@ -0,0 +1,38 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2022 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Blockchain;</span>
<span class="term-fg32">+using Nethermind.Consensus.Processing;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Evm;</span>
<span class="term-fg32">+using Nethermind.Evm.TransactionProcessing;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismReadOnlyTxProcessingEnv(</span>
<span class="term-fg32">+      IWorldStateManager worldStateManager,</span>
<span class="term-fg32">+      IReadOnlyBlockTree readOnlyBlockTree,</span>
<span class="term-fg32">+      ISpecProvider specProvider,</span>
<span class="term-fg32">+      ILogManager logManager,</span>
<span class="term-fg32">+      IL1CostHelper l1CostHelper,</span>
<span class="term-fg32">+      IOptimismSpecHelper opSpecHelper,</span>
<span class="term-fg32">+      IWorldState? worldStateToWarmUp = null) : ReadOnlyTxProcessingEnv(</span>
<span class="term-fg32">+      worldStateManager,</span>
<span class="term-fg32">+      readOnlyBlockTree,</span>
<span class="term-fg32">+      specProvider,</span>
<span class="term-fg32">+      logManager,</span>
<span class="term-fg32">+      worldStateToWarmUp</span>
<span class="term-fg32">+     )</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    protected override ITransactionProcessor CreateTransactionProcessor()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        ArgumentNullException.ThrowIfNull(LogManager);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        BlockhashProvider blockhashProvider = new(BlockTree, SpecProvider, StateProvider, LogManager);</span>
<span class="term-fg32">+        VirtualMachine virtualMachine = new(blockhashProvider, SpecProvider, CodeInfoRepository, LogManager);</span>
<span class="term-fg32">+        return new OptimismTransactionProcessor(SpecProvider, StateProvider, virtualMachine, LogManager, l1CostHelper, opSpecHelper, CodeInfoRepository);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-39303a782b8bc498b840c647" role="button"
                       aria-expanded="false" aria-controls="id-39303a782b8bc498b840c647">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismReceiptMessageDecoder.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismReceiptMessageDecoder.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+202</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-39303a782b8bc498b840c647"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismReceiptMessageDecoder.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismReceiptMessageDecoder.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..186fc2375d358dc968d3695b51638d499a88da48</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismReceiptMessageDecoder.cs</span>
<span class="term-fg36">@@ -0,0 +1,202 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.Core.Extensions;</span>
<span class="term-fg32">+using Nethermind.Serialization.Rlp;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+[Rlp.Decoder(RlpDecoderKey.Trie)]</span>
<span class="term-fg32">+public class OptimismReceiptTrieDecoder() : OptimismReceiptMessageDecoder(true) { }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+[Rlp.Decoder]</span>
<span class="term-fg32">+public class OptimismReceiptMessageDecoder(bool isEncodedForTrie = false) : IRlpStreamDecoder&lt;OptimismTxReceipt&gt;, IRlpStreamDecoder&lt;TxReceipt&gt;</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly bool _isEncodedForTrie = isEncodedForTrie;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismTxReceipt Decode(RlpStream rlpStream, RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        OptimismTxReceipt txReceipt = new();</span>
<span class="term-fg32">+        if (!rlpStream.IsSequenceNext())</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            rlpStream.SkipLength();</span>
<span class="term-fg32">+            txReceipt.TxType = (TxType)rlpStream.ReadByte();</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        int lastCheck = rlpStream.ReadSequenceLength() + rlpStream.Position;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        byte[] firstItem = rlpStream.DecodeByteArray();</span>
<span class="term-fg32">+        if (firstItem.Length == 1 &amp;&amp; (firstItem[0] == 0 || firstItem[0] == 1))</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            txReceipt.StatusCode = firstItem[0];</span>
<span class="term-fg32">+            txReceipt.GasUsedTotal = (long)rlpStream.DecodeUBigInt();</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        else if (firstItem.Length is &gt;= 1 and &lt;= 4)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            txReceipt.GasUsedTotal = (long)firstItem.ToUnsignedBigInteger();</span>
<span class="term-fg32">+            txReceipt.SkipStateAndStatusInRlp = true;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        else</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            txReceipt.PostTransactionState = firstItem.Length == 0 ? null : new Hash256(firstItem);</span>
<span class="term-fg32">+            txReceipt.GasUsedTotal = (long)rlpStream.DecodeUBigInt();</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        txReceipt.Bloom = rlpStream.DecodeBloom();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        int logEntriesCheck = rlpStream.ReadSequenceLength() + rlpStream.Position;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        int numberOfReceipts = rlpStream.PeekNumberOfItemsRemaining(logEntriesCheck);</span>
<span class="term-fg32">+        LogEntry[] entries = new LogEntry[numberOfReceipts];</span>
<span class="term-fg32">+        for (int i = 0; i &lt; numberOfReceipts; i++)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            entries[i] = Rlp.Decode&lt;LogEntry&gt;(rlpStream, RlpBehaviors.AllowExtraBytes);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        txReceipt.Logs = entries;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (lastCheck &gt; rlpStream.Position)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            if (txReceipt.TxType == TxType.DepositTx &amp;&amp; lastCheck &gt; rlpStream.Position)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                txReceipt.DepositNonce = rlpStream.DecodeUlong();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+                if (lastCheck &gt; rlpStream.Position)</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    txReceipt.DepositReceiptVersion = rlpStream.DecodeUlong();</span>
<span class="term-fg32">+                }</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return txReceipt;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private (int Total, int Logs) GetContentLength(OptimismTxReceipt item, RlpBehaviors rlpBehaviors)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (item is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return (0, 0);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        int contentLength = 0;</span>
<span class="term-fg32">+        contentLength += Rlp.LengthOf(item.GasUsedTotal);</span>
<span class="term-fg32">+        contentLength += Rlp.LengthOf(item.Bloom);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        int logsLength = GetLogsLength(item);</span>
<span class="term-fg32">+        contentLength += Rlp.LengthOfSequence(logsLength);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        bool isEip658Receipts = (rlpBehaviors &amp; RlpBehaviors.Eip658Receipts) == RlpBehaviors.Eip658Receipts;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (!item.SkipStateAndStatusInRlp)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            contentLength += isEip658Receipts</span>
<span class="term-fg32">+                ? Rlp.LengthOf(item.StatusCode)</span>
<span class="term-fg32">+                : Rlp.LengthOf(item.PostTransactionState);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (item.TxType == TxType.DepositTx &amp;&amp; item.DepositNonce is not null &amp;&amp;</span>
<span class="term-fg32">+            (item.DepositReceiptVersion is not null || !_isEncodedForTrie))</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            contentLength += Rlp.LengthOf(item.DepositNonce);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            if (item.DepositReceiptVersion is not null)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                contentLength += Rlp.LengthOf(item.DepositReceiptVersion.Value);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return (contentLength, logsLength);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private static int GetLogsLength(OptimismTxReceipt item)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        int logsLength = 0;</span>
<span class="term-fg32">+        for (var i = 0; i &lt; item.Logs?.Length; i++)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            logsLength += Rlp.LengthOf(item.Logs[i]);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return logsLength;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47;&#47; &lt;summary&gt;</span>
<span class="term-fg32">+    &#47;&#47;&#47; https:&#47;&#47;eips.ethereum.org&#47;EIPS&#47;eip-2718</span>
<span class="term-fg32">+    &#47;&#47;&#47; &lt;&#47;summary&gt;</span>
<span class="term-fg32">+    public int GetLength(OptimismTxReceipt item, RlpBehaviors rlpBehaviors)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        (int Total, int Logs) length = GetContentLength(item, rlpBehaviors);</span>
<span class="term-fg32">+        int receiptPayloadLength = Rlp.LengthOfSequence(length.Total);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        bool isForTxRoot = (rlpBehaviors &amp; RlpBehaviors.SkipTypedWrapping) == RlpBehaviors.SkipTypedWrapping;</span>
<span class="term-fg32">+        int result = item.TxType != TxType.Legacy</span>
<span class="term-fg32">+            ? isForTxRoot</span>
<span class="term-fg32">+                ? (1 + receiptPayloadLength)</span>
<span class="term-fg32">+                : Rlp.LengthOfSequence(1 + receiptPayloadLength) &#47;&#47; Rlp(TransactionType || TransactionPayload)</span>
<span class="term-fg32">+            : receiptPayloadLength;</span>
<span class="term-fg32">+        return result;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public void Encode(RlpStream rlpStream, OptimismTxReceipt item, RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (item is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            rlpStream.EncodeNullObject();</span>
<span class="term-fg32">+            return;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        (int totalContentLength, int logsLength) = GetContentLength(item, rlpBehaviors);</span>
<span class="term-fg32">+        int sequenceLength = Rlp.LengthOfSequence(totalContentLength);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (item.TxType != TxType.Legacy)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            if ((rlpBehaviors &amp; RlpBehaviors.SkipTypedWrapping) == RlpBehaviors.None)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                rlpStream.StartByteArray(sequenceLength + 1, false);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            rlpStream.WriteByte((byte)item.TxType);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        rlpStream.StartSequence(totalContentLength);</span>
<span class="term-fg32">+        if (!item.SkipStateAndStatusInRlp)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            rlpStream.Encode(item.StatusCode);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        rlpStream.Encode(item.GasUsedTotal);</span>
<span class="term-fg32">+        rlpStream.Encode(item.Bloom);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        rlpStream.StartSequence(logsLength);</span>
<span class="term-fg32">+        for (var i = 0; i &lt; item.Logs?.Length; i++)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            rlpStream.Encode(item.Logs[i]);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (item.TxType == TxType.DepositTx &amp;&amp; item.DepositNonce is not null &amp;&amp;</span>
<span class="term-fg32">+            (item.DepositReceiptVersion is not null || !_isEncodedForTrie))</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            rlpStream.Encode(item.DepositNonce.Value);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            if (item.DepositReceiptVersion is not null)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                rlpStream.Encode(item.DepositReceiptVersion.Value);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    TxReceipt IRlpStreamDecoder&lt;TxReceipt&gt;.Decode(RlpStream rlpStream, RlpBehaviors rlpBehaviors)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return Decode(rlpStream, rlpBehaviors);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public void Encode(RlpStream stream, TxReceipt item, RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        Encode(stream, (OptimismTxReceipt)item, rlpBehaviors);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public int GetLength(TxReceipt item, RlpBehaviors rlpBehaviors)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return GetLength((OptimismTxReceipt)item, rlpBehaviors);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-26e4275e88fb6a5aa61bcc1b" role="button"
                       aria-expanded="false" aria-controls="id-26e4275e88fb6a5aa61bcc1b">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismReceiptStorageDecoder.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismReceiptStorageDecoder.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+336</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-26e4275e88fb6a5aa61bcc1b"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismReceiptStorageDecoder.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismReceiptStorageDecoder.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..d3e95e82ef13d0bef6eaed7fc2f6ce0bbbff39f2</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismReceiptStorageDecoder.cs</span>
<span class="term-fg36">@@ -0,0 +1,336 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using Nethermind.Core.Collections;</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Serialization.Rlp;</span>
<span class="term-fg32">+using static Nethermind.Serialization.Rlp.Rlp;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+[Decoder(RlpDecoderKey.Storage)]</span>
<span class="term-fg32">+public class OptimismCompactReceiptStorageDecoder :</span>
<span class="term-fg32">+    IRlpStreamDecoder&lt;OptimismTxReceipt&gt;, IRlpValueDecoder&lt;OptimismTxReceipt&gt;, IRlpObjectDecoder&lt;OptimismTxReceipt&gt;, IReceiptRefDecoder,</span>
<span class="term-fg32">+    IRlpStreamDecoder&lt;TxReceipt&gt;, IRlpValueDecoder&lt;TxReceipt&gt;, IRlpObjectDecoder&lt;TxReceipt&gt;</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public OptimismTxReceipt Decode(RlpStream rlpStream, RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (rlpStream.IsNextItemNull())</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            rlpStream.ReadByte();</span>
<span class="term-fg32">+            return null!;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        OptimismTxReceipt txReceipt = new();</span>
<span class="term-fg32">+        int lastCheck = rlpStream.ReadSequenceLength() + rlpStream.Position;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        byte[] firstItem = rlpStream.DecodeByteArray();</span>
<span class="term-fg32">+        if (firstItem.Length == 1)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            txReceipt.StatusCode = firstItem[0];</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        else</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            txReceipt.PostTransactionState = firstItem.Length == 0 ? null : new Hash256(firstItem);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        txReceipt.Sender = rlpStream.DecodeAddress();</span>
<span class="term-fg32">+        txReceipt.GasUsedTotal = (long)rlpStream.DecodeUBigInt();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        int sequenceLength = rlpStream.ReadSequenceLength();</span>
<span class="term-fg32">+        int logEntriesCheck = sequenceLength + rlpStream.Position;</span>
<span class="term-fg32">+        using ArrayPoolList&lt;LogEntry&gt; logEntries = new(sequenceLength * 2 &#47; LengthOfAddressRlp);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        while (rlpStream.Position &lt; logEntriesCheck)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            logEntries.Add(CompactLogEntryDecoder.Decode(rlpStream, RlpBehaviors.AllowExtraBytes)!);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        txReceipt.Logs = [.. logEntries];</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (lastCheck &gt; rlpStream.Position)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            int remainingItems = rlpStream.PeekNumberOfItemsRemaining(lastCheck);</span>
<span class="term-fg32">+            if (remainingItems &gt; 0)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                txReceipt.DepositNonce = rlpStream.DecodeUlong();</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            if (remainingItems &gt; 1)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                txReceipt.DepositReceiptVersion = rlpStream.DecodeUlong();</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        bool allowExtraBytes = (rlpBehaviors &amp; RlpBehaviors.AllowExtraBytes) != 0;</span>
<span class="term-fg32">+        if (!allowExtraBytes)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            rlpStream.Check(lastCheck);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        txReceipt.Bloom = new Bloom(txReceipt.Logs);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return txReceipt;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismTxReceipt Decode(ref ValueDecoderContext decoderContext,</span>
<span class="term-fg32">+        RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (decoderContext.IsNextItemNull())</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            decoderContext.ReadByte();</span>
<span class="term-fg32">+            return null!;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        OptimismTxReceipt txReceipt = new();</span>
<span class="term-fg32">+        int lastCheck = decoderContext.ReadSequenceLength() + decoderContext.Position;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        byte[] firstItem = decoderContext.DecodeByteArray();</span>
<span class="term-fg32">+        if (firstItem.Length == 1)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            txReceipt.StatusCode = firstItem[0];</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        else</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            txReceipt.PostTransactionState = firstItem.Length == 0 ? null : new Hash256(firstItem);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        txReceipt.Sender = decoderContext.DecodeAddress();</span>
<span class="term-fg32">+        txReceipt.GasUsedTotal = (long)decoderContext.DecodeUBigInt();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        int sequenceLength = decoderContext.ReadSequenceLength();</span>
<span class="term-fg32">+        int logEntriesCheck = sequenceLength + decoderContext.Position;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        &#47;&#47; Don&#39;t know the size exactly, I&#39;ll just assume its just an address and add some margin</span>
<span class="term-fg32">+        using ArrayPoolList&lt;LogEntry&gt; logEntries = new(sequenceLength * 2 &#47; LengthOfAddressRlp);</span>
<span class="term-fg32">+        while (decoderContext.Position &lt; logEntriesCheck)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            logEntries.Add(CompactLogEntryDecoder.Decode(ref decoderContext, RlpBehaviors.AllowExtraBytes)!);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        txReceipt.Logs = [.. logEntries];</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (lastCheck &gt; decoderContext.Position)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            int remainingItems = decoderContext.PeekNumberOfItemsRemaining(lastCheck);</span>
<span class="term-fg32">+            if (remainingItems &gt; 0)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                txReceipt.DepositNonce = decoderContext.DecodeULong();</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            if (remainingItems &gt; 1)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                txReceipt.DepositReceiptVersion = decoderContext.DecodeULong();</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        bool allowExtraBytes = (rlpBehaviors &amp; RlpBehaviors.AllowExtraBytes) != 0;</span>
<span class="term-fg32">+        if (!allowExtraBytes)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            decoderContext.Check(lastCheck);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        txReceipt.Bloom = new Bloom(txReceipt.Logs);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return txReceipt;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public void DecodeStructRef(scoped ref ValueDecoderContext decoderContext, RlpBehaviors rlpBehaviors,</span>
<span class="term-fg32">+        out TxReceiptStructRef item)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        &#47;&#47; Note: This method runs at 2.5 million times&#47;sec on my machine</span>
<span class="term-fg32">+        item = new TxReceiptStructRef();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (decoderContext.IsNextItemNull())</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            decoderContext.ReadByte();</span>
<span class="term-fg32">+            return;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        int lastCheck = decoderContext.ReadSequenceLength() + decoderContext.Position;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        ReadOnlySpan&lt;byte&gt; firstItem = decoderContext.DecodeByteArraySpan();</span>
<span class="term-fg32">+        if (firstItem.Length == 1)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            item.StatusCode = firstItem[0];</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        else</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            item.PostTransactionState =</span>
<span class="term-fg32">+                firstItem.Length == 0 ? new Hash256StructRef() : new Hash256StructRef(firstItem);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        decoderContext.DecodeAddressStructRef(out item.Sender);</span>
<span class="term-fg32">+        item.GasUsedTotal = (long)decoderContext.DecodeUBigInt();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        (int PrefixLength, int ContentLength) peekPrefixAndContentLength =</span>
<span class="term-fg32">+            decoderContext.PeekPrefixAndContentLength();</span>
<span class="term-fg32">+        int logsBytes = peekPrefixAndContentLength.ContentLength + peekPrefixAndContentLength.PrefixLength;</span>
<span class="term-fg32">+        item.LogsRlp = decoderContext.Data.Slice(decoderContext.Position, logsBytes);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (lastCheck &gt; decoderContext.Position)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            int remainingItems = decoderContext.PeekNumberOfItemsRemaining(lastCheck);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            if (remainingItems &gt; 1)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                decoderContext.SkipItem();</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            if (remainingItems &gt; 2)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                decoderContext.SkipItem();</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        decoderContext.SkipItem();</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public void DecodeLogEntryStructRef(scoped ref ValueDecoderContext decoderContext, RlpBehaviors none,</span>
<span class="term-fg32">+        out LogEntryStructRef current)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        CompactLogEntryDecoder.DecodeLogEntryStructRef(ref decoderContext, none, out current);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Hash256[] DecodeTopics(ValueDecoderContext valueDecoderContext)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return CompactLogEntryDecoder.DecodeTopics(valueDecoderContext);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47; Refstruct decode does not generate bloom</span>
<span class="term-fg32">+    public bool CanDecodeBloom =&gt; false;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Rlp Encode(OptimismTxReceipt? item, RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        RlpStream rlpStream = new(GetLength(item!, rlpBehaviors));</span>
<span class="term-fg32">+        Encode(rlpStream, item, rlpBehaviors);</span>
<span class="term-fg32">+        return new Rlp(rlpStream.Data.ToArray()!);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public void Encode(RlpStream rlpStream, OptimismTxReceipt? item, RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (item is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            rlpStream.EncodeNullObject();</span>
<span class="term-fg32">+            return;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        (int totalContentLength, int logsLength) = GetContentLength(item, rlpBehaviors);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        bool isEip658receipts = (rlpBehaviors &amp; RlpBehaviors.Eip658Receipts) == RlpBehaviors.Eip658Receipts;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        &#47;&#47; Note: Any byte saved here is about 3GB on mainnet.</span>
<span class="term-fg32">+        rlpStream.StartSequence(totalContentLength);</span>
<span class="term-fg32">+        if (isEip658receipts)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            rlpStream.Encode(item.StatusCode);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        else</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            rlpStream.Encode(item.PostTransactionState);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        rlpStream.Encode(item.Sender);</span>
<span class="term-fg32">+        rlpStream.Encode(item.GasUsedTotal);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        rlpStream.StartSequence(logsLength);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        LogEntry[] logs = item.Logs ?? Array.Empty&lt;LogEntry&gt;();</span>
<span class="term-fg32">+        for (int i = 0; i &lt; logs.Length; i++)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            CompactLogEntryDecoder.Encode(rlpStream, logs[i]);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (item.TxType == TxType.DepositTx &amp;&amp; item.DepositNonce is not null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            rlpStream.Encode(item.DepositNonce.Value);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            if (item.DepositReceiptVersion is not null)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                rlpStream.Encode(item.DepositReceiptVersion.Value);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private static (int Total, int Logs) GetContentLength(OptimismTxReceipt? item, RlpBehaviors rlpBehaviors)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        int contentLength = 0;</span>
<span class="term-fg32">+        if (item is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return (contentLength, 0);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        bool isEip658Receipts = (rlpBehaviors &amp; RlpBehaviors.Eip658Receipts) == RlpBehaviors.Eip658Receipts;</span>
<span class="term-fg32">+        if (isEip658Receipts)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            contentLength += LengthOf(item.StatusCode);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        else</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            contentLength += LengthOf(item.PostTransactionState);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        contentLength += LengthOf(item.Sender);</span>
<span class="term-fg32">+        contentLength += LengthOf(item.GasUsedTotal);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        int logsLength = GetLogsLength(item);</span>
<span class="term-fg32">+        contentLength += LengthOfSequence(logsLength);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (item.TxType == TxType.DepositTx &amp;&amp; item.DepositNonce is not null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            contentLength += LengthOf(item.DepositNonce);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            if (item.DepositReceiptVersion is not null)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                contentLength += LengthOf(item.DepositReceiptVersion.Value);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return (contentLength, logsLength);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private static int GetLogsLength(OptimismTxReceipt item)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        int logsLength = 0;</span>
<span class="term-fg32">+        LogEntry[] logs = item.Logs ?? Array.Empty&lt;LogEntry&gt;();</span>
<span class="term-fg32">+        for (int i = 0; i &lt; logs.Length; i++)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            logsLength += CompactLogEntryDecoder.Instance.GetLength(logs[i]);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return logsLength;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public int GetLength(OptimismTxReceipt item, RlpBehaviors rlpBehaviors)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        (int Total, int Logs) length = GetContentLength(item, rlpBehaviors);</span>
<span class="term-fg32">+        return LengthOfSequence(length.Total);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    TxReceipt IRlpStreamDecoder&lt;TxReceipt&gt;.Decode(RlpStream rlpStream, RlpBehaviors rlpBehaviors)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return Decode(rlpStream, rlpBehaviors);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public void Encode(RlpStream stream, TxReceipt item, RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        Encode(stream, (OptimismTxReceipt)item, rlpBehaviors);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public int GetLength(TxReceipt item, RlpBehaviors rlpBehaviors)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return GetLength((OptimismTxReceipt)item, rlpBehaviors);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    TxReceipt IRlpValueDecoder&lt;TxReceipt&gt;.Decode(ref ValueDecoderContext decoderContext, RlpBehaviors rlpBehaviors)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return Decode(ref decoderContext, rlpBehaviors);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Rlp Encode(TxReceipt? item, RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return Encode((OptimismTxReceipt?)item, rlpBehaviors);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c36ab5f6376256c6bc8d01b4" role="button"
                       aria-expanded="false" aria-controls="id-c36ab5f6376256c6bc8d01b4">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismTransactionProcessor.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismTransactionProcessor.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+168</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c36ab5f6376256c6bc8d01b4"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTransactionProcessor.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTransactionProcessor.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..d21a3350ed39e962e9c56ffb1a162b24566a18e7</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTransactionProcessor.cs</span>
<span class="term-fg36">@@ -0,0 +1,168 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Evm;</span>
<span class="term-fg32">+using Nethermind.Evm.Tracing;</span>
<span class="term-fg32">+using Nethermind.Evm.TransactionProcessing;</span>
<span class="term-fg32">+using Nethermind.Int256;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public sealed class OptimismTransactionProcessor(</span>
<span class="term-fg32">+    ISpecProvider specProvider,</span>
<span class="term-fg32">+    IWorldState worldState,</span>
<span class="term-fg32">+    IVirtualMachine virtualMachine,</span>
<span class="term-fg32">+    ILogManager logManager,</span>
<span class="term-fg32">+    IL1CostHelper l1CostHelper,</span>
<span class="term-fg32">+    IOptimismSpecHelper opSpecHelper,</span>
<span class="term-fg32">+    ICodeInfoRepository? codeInfoRepository</span>
<span class="term-fg32">+    ) : TransactionProcessorBase(specProvider, worldState, virtualMachine, codeInfoRepository, logManager)</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private UInt256? _currentTxL1Cost;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override TransactionResult Execute(Transaction tx, in BlockExecutionContext blCtx, ITxTracer tracer, ExecutionOptions opts)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (tx.SupportsBlobs)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            &#47;&#47; No blob txs in optimism</span>
<span class="term-fg32">+            return TransactionResult.MalformedTransaction;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        IReleaseSpec spec = SpecProvider.GetSpec(blCtx.Header);</span>
<span class="term-fg32">+        _currentTxL1Cost = null;</span>
<span class="term-fg32">+        if (tx.IsDeposit())</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            WorldState.AddToBalanceAndCreateIfNotExists(tx.SenderAddress!, tx.Mint, spec);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Snapshot snapshot = WorldState.TakeSnapshot();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        TransactionResult result = base.Execute(tx, blCtx, tracer, opts);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (!result &amp;&amp; tx.IsDeposit() &amp;&amp; result.Error != &quot;block gas limit exceeded&quot;)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            &#47;&#47; deposit tx should be included</span>
<span class="term-fg32">+            WorldState.Restore(snapshot);</span>
<span class="term-fg32">+            if (!WorldState.AccountExists(tx.SenderAddress!))</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                WorldState.CreateAccount(tx.SenderAddress!, 0, 1);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            else</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                WorldState.IncrementNonce(tx.SenderAddress!);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            blCtx.Header.GasUsed += tx.GasLimit;</span>
<span class="term-fg32">+            tracer.MarkAsFailed(tx.To!, tx.GasLimit, Array.Empty&lt;byte&gt;(), $&quot;failed deposit: {result.Error}&quot;);</span>
<span class="term-fg32">+            result = TransactionResult.Ok;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return result;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override TransactionResult BuyGas(Transaction tx, BlockHeader header, IReleaseSpec spec, ITxTracer tracer, ExecutionOptions opts,</span>
<span class="term-fg32">+        in UInt256 effectiveGasPrice, out UInt256 premiumPerGas, out UInt256 senderReservedGasPayment)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        premiumPerGas = UInt256.Zero;</span>
<span class="term-fg32">+        senderReservedGasPayment = UInt256.Zero;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        bool validate = !opts.HasFlag(ExecutionOptions.NoValidation);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        UInt256 senderBalance = WorldState.GetBalance(tx.SenderAddress!);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (tx.IsDeposit() &amp;&amp; !tx.IsOPSystemTransaction &amp;&amp; senderBalance &lt; tx.Value)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return &quot;insufficient sender balance&quot;;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (validate &amp;&amp; !tx.IsDeposit())</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            if (!tx.TryCalculatePremiumPerGas(header.BaseFeePerGas, out premiumPerGas))</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                TraceLogInvalidTx(tx, &quot;MINER_PREMIUM_IS_NEGATIVE&quot;);</span>
<span class="term-fg32">+                return &quot;miner premium is negative&quot;;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            if (UInt256.SubtractUnderflow(senderBalance, tx.Value, out UInt256 balanceLeft))</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                TraceLogInvalidTx(tx, $&quot;INSUFFICIENT_SENDER_BALANCE: ({tx.SenderAddress})_BALANCE = {senderBalance}&quot;);</span>
<span class="term-fg32">+                return &quot;insufficient sender balance&quot;;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            UInt256 l1Cost = _currentTxL1Cost ??= l1CostHelper.ComputeL1Cost(tx, header, WorldState);</span>
<span class="term-fg32">+            if (UInt256.SubtractUnderflow(balanceLeft, l1Cost, out balanceLeft))</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                TraceLogInvalidTx(tx, $&quot;INSUFFICIENT_SENDER_BALANCE: ({tx.SenderAddress})_BALANCE = {senderBalance}&quot;);</span>
<span class="term-fg32">+                return &quot;insufficient sender balance&quot;;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            bool overflows = UInt256.MultiplyOverflow((UInt256)tx.GasLimit, tx.MaxFeePerGas, out UInt256 maxGasFee);</span>
<span class="term-fg32">+            if (spec.IsEip1559Enabled &amp;&amp; !tx.IsFree() &amp;&amp; (overflows || balanceLeft &lt; maxGasFee))</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                TraceLogInvalidTx(tx, $&quot;INSUFFICIENT_MAX_FEE_PER_GAS_FOR_SENDER_BALANCE: ({tx.SenderAddress})_BALANCE = {senderBalance}, MAX_FEE_PER_GAS: {tx.MaxFeePerGas}&quot;);</span>
<span class="term-fg32">+                return &quot;insufficient MaxFeePerGas for sender balance&quot;;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            overflows = UInt256.MultiplyOverflow((UInt256)tx.GasLimit, effectiveGasPrice, out senderReservedGasPayment);</span>
<span class="term-fg32">+            if (overflows || senderReservedGasPayment &gt; balanceLeft)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                TraceLogInvalidTx(tx, $&quot;INSUFFICIENT_SENDER_BALANCE: ({tx.SenderAddress})_BALANCE = {senderBalance}&quot;);</span>
<span class="term-fg32">+                return &quot;insufficient sender balance&quot;;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            senderReservedGasPayment += l1Cost; &#47;&#47; no overflow here, otherwise previous check would fail</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (validate)</span>
<span class="term-fg32">+            WorldState.SubtractFromBalance(tx.SenderAddress!, senderReservedGasPayment, spec);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return TransactionResult.Ok;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override TransactionResult IncrementNonce(Transaction tx, BlockHeader header, IReleaseSpec spec, ITxTracer tracer, ExecutionOptions opts)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (!tx.IsDeposit())</span>
<span class="term-fg32">+            return base.IncrementNonce(tx, header, spec, tracer, opts);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        WorldState.IncrementNonce(tx.SenderAddress!);</span>
<span class="term-fg32">+        return TransactionResult.Ok;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override TransactionResult ValidateSender(Transaction tx, BlockHeader header, IReleaseSpec spec, ITxTracer tracer, ExecutionOptions opts) =&gt;</span>
<span class="term-fg32">+        tx.IsDeposit() ? TransactionResult.Ok : base.ValidateSender(tx, header, spec, tracer, opts);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override void PayFees(Transaction tx, BlockHeader header, IReleaseSpec spec, ITxTracer tracer,</span>
<span class="term-fg32">+        in TransactionSubstate substate, in long spentGas, in UInt256 premiumPerGas, in byte statusCode)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (!tx.IsDeposit())</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            &#47;&#47; Skip coinbase payments for deposit tx in Regolith</span>
<span class="term-fg32">+            base.PayFees(tx, header, spec, tracer, substate, spentGas, premiumPerGas, statusCode);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            if (opSpecHelper.IsBedrock(header))</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                UInt256 l1Cost = _currentTxL1Cost ??= l1CostHelper.ComputeL1Cost(tx, header, WorldState);</span>
<span class="term-fg32">+                WorldState.AddToBalanceAndCreateIfNotExists(opSpecHelper.L1FeeReceiver, l1Cost, spec);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override long Refund(Transaction tx, BlockHeader header, IReleaseSpec spec, ExecutionOptions opts,</span>
<span class="term-fg32">+        in TransactionSubstate substate, in long unspentGas, in UInt256 gasPrice)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        &#47;&#47; if deposit: skip refunds, skip tipping coinbase</span>
<span class="term-fg32">+        &#47;&#47; Regolith changes this behaviour to report the actual gasUsed instead of always reporting all gas used.</span>
<span class="term-fg32">+        if (tx.IsDeposit() &amp;&amp; !opSpecHelper.IsRegolith(header))</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            &#47;&#47; Record deposits as using all their gas</span>
<span class="term-fg32">+            &#47;&#47; System Transactions are special &amp; are not recorded as using any gas (anywhere)</span>
<span class="term-fg32">+            return tx.IsOPSystemTransaction ? 0 : tx.GasLimit;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return base.Refund(tx, header, spec, opts, substate, unspentGas, gasPrice);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5b21afaded2afaed165d306b" role="button"
                       aria-expanded="false" aria-controls="id-5b21afaded2afaed165d306b">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismTransactionsExecutorFactory.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismTransactionsExecutorFactory.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+29</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5b21afaded2afaed165d306b"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTransactionsExecutorFactory.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTransactionsExecutorFactory.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..951d01542a81dbb5428eb70cbd3b3c3c401e1a8c</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTransactionsExecutorFactory.cs</span>
<span class="term-fg36">@@ -0,0 +1,29 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Consensus.Processing;</span>
<span class="term-fg32">+using Nethermind.Consensus.Producers;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Evm.TransactionProcessing;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismTransactionsExecutorFactory : IBlockTransactionsExecutorFactory</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly ISpecProvider _specProvider;</span>
<span class="term-fg32">+    private readonly ILogManager _logManager;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismTransactionsExecutorFactory(ISpecProvider specProvider, ILogManager logManager)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _specProvider = specProvider;</span>
<span class="term-fg32">+        _logManager = logManager;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public IBlockProcessor.IBlockTransactionsExecutor Create(IReadOnlyTxProcessingScope readOnlyTxProcessingEnv)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return new BlockProcessor.BlockProductionTransactionsExecutor(readOnlyTxProcessingEnv.TransactionProcessor,</span>
<span class="term-fg32">+            readOnlyTxProcessingEnv.WorldState, new OptimismBlockProductionTransactionPicker(_specProvider),</span>
<span class="term-fg32">+            _logManager);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-a3061c24aad7bea065e2d003" role="button"
                       aria-expanded="false" aria-controls="id-a3061c24aad7bea065e2d003">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismTxDecoder.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismTxDecoder.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+72</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-a3061c24aad7bea065e2d003"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTxDecoder.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTxDecoder.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..9bb2e77fcddefe1f635abd3eaa25fbec96db99ad</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTxDecoder.cs</span>
<span class="term-fg36">@@ -0,0 +1,72 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2022 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.Serialization.Rlp;</span>
<span class="term-fg32">+using Nethermind.Serialization.Rlp.TxDecoders;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public sealed class OptimismTxDecoder&lt;T&gt;(Func&lt;T&gt;? transactionFactory = null)</span>
<span class="term-fg32">+    : BaseEIP1559TxDecoder&lt;T&gt;(TxType.DepositTx, transactionFactory) where T : Transaction, new()</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    protected override int GetSignatureLength(Signature? signature, bool forSigning, bool isEip155Enabled = false, ulong chainId = 0) =&gt; 0;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override void EncodeSignature(Signature? signature, RlpStream stream, bool forSigning, bool isEip155Enabled = false, ulong chainId = 0)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override void DecodePayload(Transaction transaction, RlpStream rlpStream, RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        transaction.SourceHash = rlpStream.DecodeKeccak();</span>
<span class="term-fg32">+        transaction.SenderAddress = rlpStream.DecodeAddress();</span>
<span class="term-fg32">+        transaction.To = rlpStream.DecodeAddress();</span>
<span class="term-fg32">+        transaction.Mint = rlpStream.DecodeUInt256();</span>
<span class="term-fg32">+        transaction.Value = rlpStream.DecodeUInt256();</span>
<span class="term-fg32">+        transaction.GasLimit = rlpStream.DecodeLong();</span>
<span class="term-fg32">+        transaction.IsOPSystemTransaction = rlpStream.DecodeBool();</span>
<span class="term-fg32">+        transaction.Data = rlpStream.DecodeByteArray();</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override void DecodePayload(Transaction transaction, ref Rlp.ValueDecoderContext decoderContext,</span>
<span class="term-fg32">+        RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        transaction.SourceHash = decoderContext.DecodeKeccak();</span>
<span class="term-fg32">+        transaction.SenderAddress = decoderContext.DecodeAddress();</span>
<span class="term-fg32">+        transaction.To = decoderContext.DecodeAddress();</span>
<span class="term-fg32">+        transaction.Mint = decoderContext.DecodeUInt256();</span>
<span class="term-fg32">+        transaction.Value = decoderContext.DecodeUInt256();</span>
<span class="term-fg32">+        transaction.GasLimit = decoderContext.DecodeLong();</span>
<span class="term-fg32">+        transaction.IsOPSystemTransaction = decoderContext.DecodeBool();</span>
<span class="term-fg32">+        transaction.Data = decoderContext.DecodeByteArray();</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override Signature? DecodeSignature(ulong v, ReadOnlySpan&lt;byte&gt; rBytes, ReadOnlySpan&lt;byte&gt; sBytes, Signature? fallbackSignature = null, RlpBehaviors rlpBehaviors = RlpBehaviors.None) =&gt;</span>
<span class="term-fg32">+        v == 0 &amp;&amp; rBytes.IsEmpty &amp;&amp; sBytes.IsEmpty</span>
<span class="term-fg32">+            ? fallbackSignature</span>
<span class="term-fg32">+            : base.DecodeSignature(v, rBytes, sBytes, fallbackSignature, rlpBehaviors);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override int GetPayloadLength(Transaction transaction) =&gt;</span>
<span class="term-fg32">+        Rlp.LengthOf(transaction.SourceHash)</span>
<span class="term-fg32">+        + Rlp.LengthOf(transaction.SenderAddress)</span>
<span class="term-fg32">+        + Rlp.LengthOf(transaction.To)</span>
<span class="term-fg32">+        + Rlp.LengthOf(transaction.Mint)</span>
<span class="term-fg32">+        + Rlp.LengthOf(transaction.Value)</span>
<span class="term-fg32">+        + Rlp.LengthOf(transaction.GasLimit)</span>
<span class="term-fg32">+        + Rlp.LengthOf(transaction.IsOPSystemTransaction)</span>
<span class="term-fg32">+        + Rlp.LengthOf(transaction.Data);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override void EncodePayload(Transaction transaction, RlpStream stream, RlpBehaviors rlpBehaviors = RlpBehaviors.None)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        stream.Encode(transaction.SourceHash);</span>
<span class="term-fg32">+        stream.Encode(transaction.SenderAddress);</span>
<span class="term-fg32">+        stream.Encode(transaction.To);</span>
<span class="term-fg32">+        stream.Encode(transaction.Mint);</span>
<span class="term-fg32">+        stream.Encode(transaction.Value);</span>
<span class="term-fg32">+        stream.Encode(transaction.GasLimit);</span>
<span class="term-fg32">+        stream.Encode(transaction.IsOPSystemTransaction);</span>
<span class="term-fg32">+        stream.Encode(transaction.Data);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-ca0a789403198784c2e0df36" role="button"
                       aria-expanded="false" aria-controls="id-ca0a789403198784c2e0df36">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismTxPoolTxSource.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismTxPoolTxSource.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+26</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-ca0a789403198784c2e0df36"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTxPoolTxSource.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTxPoolTxSource.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..7334e9448b45d4feae8ed17f4800900892e9af40</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTxPoolTxSource.cs</span>
<span class="term-fg36">@@ -0,0 +1,26 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System.Collections.Generic;</span>
<span class="term-fg32">+using System.Linq;</span>
<span class="term-fg32">+using Nethermind.Consensus.Producers;</span>
<span class="term-fg32">+using Nethermind.Consensus.Transactions;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismTxPoolTxSource : ITxSource</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly ITxSource _baseTxSource;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismTxPoolTxSource(ITxSource baseTxSource)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _baseTxSource = baseTxSource;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public IEnumerable&lt;Transaction&gt; GetTransactions(BlockHeader parent, long gasLimit, PayloadAttributes? payloadAttributes) =&gt;</span>
<span class="term-fg32">+        payloadAttributes is OptimismPayloadAttributes { NoTxPool: true }</span>
<span class="term-fg32">+            ? Enumerable.Empty&lt;Transaction&gt;()</span>
<span class="term-fg32">+            : _baseTxSource.GetTransactions(parent, gasLimit, payloadAttributes);</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-149c7713d0f71f8fbaa15fdf" role="button"
                       aria-expanded="false" aria-controls="id-149c7713d0f71f8fbaa15fdf">
                        <code>src/Nethermind/Nethermind.Optimism/OptimismTxReceipt.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/OptimismTxReceipt.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+21</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-149c7713d0f71f8fbaa15fdf"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTxReceipt.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTxReceipt.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..3d1dcf83883b5c605683a22bf13e99a8bc2e9ff8</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;OptimismTxReceipt.cs</span>
<span class="term-fg36">@@ -0,0 +1,21 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismTxReceipt : TxReceipt</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public OptimismTxReceipt()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismTxReceipt(TxReceipt receipt) : base(receipt)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+    public ulong? DepositNonce { get; set; }</span>
<span class="term-fg32">+    public ulong? DepositReceiptVersion { get; set; }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-4fef490e6beb8b7829c02513" role="button"
                       aria-expanded="false" aria-controls="id-4fef490e6beb8b7829c02513">
                        <code>src/Nethermind/Nethermind.Optimism/ReadOnlyChainProcessingEnv.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/ReadOnlyChainProcessingEnv.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+74</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-4fef490e6beb8b7829c02513"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;ReadOnlyChainProcessingEnv.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;ReadOnlyChainProcessingEnv.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..3e1e3cbe011e5be3f28430ee7a48d081552e559c</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;ReadOnlyChainProcessingEnv.cs</span>
<span class="term-fg36">@@ -0,0 +1,74 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2022 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Blockchain;</span>
<span class="term-fg32">+using Nethermind.Blockchain.BeaconBlockRoot;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Blocks;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Receipts;</span>
<span class="term-fg32">+using Nethermind.Consensus.Processing;</span>
<span class="term-fg32">+using Nethermind.Consensus.Rewards;</span>
<span class="term-fg32">+using Nethermind.Consensus.Validators;</span>
<span class="term-fg32">+using Nethermind.Consensus.Withdrawals;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Evm.TransactionProcessing;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&#47;&#47;&#47; &lt;summary&gt;</span>
<span class="term-fg32">+&#47;&#47;&#47; Not thread safe.</span>
<span class="term-fg32">+&#47;&#47;&#47; &lt;&#47;summary&gt;</span>
<span class="term-fg32">+public class OptimismReadOnlyChainProcessingEnv(</span>
<span class="term-fg32">+    IReadOnlyTxProcessingScope txEnv,</span>
<span class="term-fg32">+    IBlockValidator blockValidator,</span>
<span class="term-fg32">+    IBlockPreprocessorStep recoveryStep,</span>
<span class="term-fg32">+    IRewardCalculator rewardCalculator,</span>
<span class="term-fg32">+    IReceiptStorage receiptStorage,</span>
<span class="term-fg32">+    ISpecProvider specProvider,</span>
<span class="term-fg32">+    IBlockTree blockTree,</span>
<span class="term-fg32">+    IStateReader stateReader,</span>
<span class="term-fg32">+    ILogManager logManager,</span>
<span class="term-fg32">+    IOptimismSpecHelper opSpecHelper,</span>
<span class="term-fg32">+    Create2DeployerContractRewriter contractRewriter,</span>
<span class="term-fg32">+    IWithdrawalProcessor? withdrawalProcessor,</span>
<span class="term-fg32">+    IBlockProcessor.IBlockTransactionsExecutor? blockTransactionsExecutor = null) : ReadOnlyChainProcessingEnv(</span>
<span class="term-fg32">+    txEnv,</span>
<span class="term-fg32">+    blockValidator,</span>
<span class="term-fg32">+    recoveryStep,</span>
<span class="term-fg32">+    rewardCalculator,</span>
<span class="term-fg32">+    receiptStorage,</span>
<span class="term-fg32">+    specProvider,</span>
<span class="term-fg32">+    blockTree,</span>
<span class="term-fg32">+    stateReader,</span>
<span class="term-fg32">+    logManager,</span>
<span class="term-fg32">+    blockTransactionsExecutor)</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override IBlockProcessor CreateBlockProcessor(</span>
<span class="term-fg32">+        IReadOnlyTxProcessingScope scope,</span>
<span class="term-fg32">+        IBlockTree blockTree,</span>
<span class="term-fg32">+        IBlockValidator blockValidator,</span>
<span class="term-fg32">+        IRewardCalculator rewardCalculator,</span>
<span class="term-fg32">+        IReceiptStorage receiptStorage,</span>
<span class="term-fg32">+        ISpecProvider specProvider,</span>
<span class="term-fg32">+        ILogManager logManager,</span>
<span class="term-fg32">+        IBlockProcessor.IBlockTransactionsExecutor transactionsExecutor</span>
<span class="term-fg32">+    )</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return new OptimismBlockProcessor(</span>
<span class="term-fg32">+            specProvider,</span>
<span class="term-fg32">+            blockValidator,</span>
<span class="term-fg32">+            rewardCalculator,</span>
<span class="term-fg32">+            transactionsExecutor,</span>
<span class="term-fg32">+            scope.WorldState,</span>
<span class="term-fg32">+            receiptStorage,</span>
<span class="term-fg32">+            scope.TransactionProcessor,</span>
<span class="term-fg32">+            new BlockhashStore(specProvider, scope.WorldState),</span>
<span class="term-fg32">+            new BeaconBlockRootHandler(scope.TransactionProcessor),</span>
<span class="term-fg32">+            logManager,</span>
<span class="term-fg32">+            opSpecHelper,</span>
<span class="term-fg32">+            contractRewriter,</span>
<span class="term-fg32">+            withdrawalProcessor);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-0ea2d7387359fc55995c835c" role="button"
                       aria-expanded="false" aria-controls="id-0ea2d7387359fc55995c835c">
                        <code>src/Nethermind/Nethermind.Optimism/Rpc/IOptimismEngineRpcModule.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Rpc/IOptimismEngineRpcModule.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+72</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-0ea2d7387359fc55995c835c"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;IOptimismEngineRpcModule.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;IOptimismEngineRpcModule.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..c8eae2f7a2c3d8766824c04ab378ca318240a2e8</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;IOptimismEngineRpcModule.cs</span>
<span class="term-fg36">@@ -0,0 +1,72 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System.Threading.Tasks;</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.JsonRpc;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.Data;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+[RpcModule(ModuleType.Engine)]</span>
<span class="term-fg32">+public interface IOptimismEngineRpcModule : IRpcModule</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    [JsonRpcMethod(</span>
<span class="term-fg32">+        Description = &quot;Verifies the payload according to the execution environment rules and returns the verification status and hash of the last valid block.&quot;,</span>
<span class="term-fg32">+        IsSharable = true,</span>
<span class="term-fg32">+        IsImplemented = true)]</span>
<span class="term-fg32">+    Task&lt;ResultWrapper&lt;ForkchoiceUpdatedV1Result&gt;&gt; engine_forkchoiceUpdatedV1(ForkchoiceStateV1 forkchoiceState, OptimismPayloadAttributes? payloadAttributes = null);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(</span>
<span class="term-fg32">+        Description = &quot;Returns the most recent version of an execution payload with respect to the transaction set contained by the mempool.&quot;,</span>
<span class="term-fg32">+        IsSharable = true,</span>
<span class="term-fg32">+        IsImplemented = true)]</span>
<span class="term-fg32">+    Task&lt;ResultWrapper&lt;ExecutionPayload?&gt;&gt; engine_getPayloadV1(byte[] payloadId);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(</span>
<span class="term-fg32">+        Description = &quot;Verifies the payload according to the execution environment rules and returns the verification status and hash of the last valid block.&quot;,</span>
<span class="term-fg32">+        IsSharable = true,</span>
<span class="term-fg32">+        IsImplemented = true)]</span>
<span class="term-fg32">+    Task&lt;ResultWrapper&lt;PayloadStatusV1&gt;&gt; engine_newPayloadV1(ExecutionPayload executionPayload);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(</span>
<span class="term-fg32">+        Description = &quot;Verifies the payload according to the execution environment rules and returns the verification status and hash of the last valid block.&quot;,</span>
<span class="term-fg32">+        IsSharable = true,</span>
<span class="term-fg32">+        IsImplemented = true)]</span>
<span class="term-fg32">+    Task&lt;ResultWrapper&lt;ForkchoiceUpdatedV1Result&gt;&gt; engine_forkchoiceUpdatedV2(ForkchoiceStateV1 forkchoiceState, OptimismPayloadAttributes? payloadAttributes = null);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(</span>
<span class="term-fg32">+        Description = &quot;Returns the most recent version of an execution payload with respect to the transaction set contained by the mempool.&quot;,</span>
<span class="term-fg32">+        IsSharable = true,</span>
<span class="term-fg32">+        IsImplemented = true)]</span>
<span class="term-fg32">+    Task&lt;ResultWrapper&lt;GetPayloadV2Result?&gt;&gt; engine_getPayloadV2(byte[] payloadId);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(</span>
<span class="term-fg32">+        Description = &quot;Verifies the payload according to the execution environment rules and returns the verification status and hash of the last valid block.&quot;,</span>
<span class="term-fg32">+        IsSharable = true,</span>
<span class="term-fg32">+        IsImplemented = true)]</span>
<span class="term-fg32">+    Task&lt;ResultWrapper&lt;PayloadStatusV1&gt;&gt; engine_newPayloadV2(ExecutionPayload executionPayload);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(</span>
<span class="term-fg32">+        Description =</span>
<span class="term-fg32">+            &quot;Verifies the payload according to the execution environment rules and returns the verification status and hash of the last valid block.&quot;,</span>
<span class="term-fg32">+        IsSharable = true,</span>
<span class="term-fg32">+        IsImplemented = true)]</span>
<span class="term-fg32">+    Task&lt;ResultWrapper&lt;ForkchoiceUpdatedV1Result&gt;&gt; engine_forkchoiceUpdatedV3(</span>
<span class="term-fg32">+        ForkchoiceStateV1 forkchoiceState, OptimismPayloadAttributes? payloadAttributes = null);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(</span>
<span class="term-fg32">+        Description = &quot;Returns the most recent version of an execution payload with respect to the transaction set contained by the mempool.&quot;,</span>
<span class="term-fg32">+        IsSharable = true,</span>
<span class="term-fg32">+        IsImplemented = true)]</span>
<span class="term-fg32">+    Task&lt;ResultWrapper&lt;OptimismGetPayloadV3Result?&gt;&gt; engine_getPayloadV3(byte[] payloadId);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(</span>
<span class="term-fg32">+        Description = &quot;Verifies the payload according to the execution environment rules and returns the verification status and hash of the last valid block.&quot;,</span>
<span class="term-fg32">+        IsSharable = true,</span>
<span class="term-fg32">+        IsImplemented = true)]</span>
<span class="term-fg32">+    Task&lt;ResultWrapper&lt;PayloadStatusV1&gt;&gt; engine_newPayloadV3(ExecutionPayloadV3 executionPayload,</span>
<span class="term-fg32">+        byte[]?[] blobVersionedHashes, Hash256? parentBeaconBlockRoot);</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b296fee0ec1bc2b1027fa8e3" role="button"
                       aria-expanded="false" aria-controls="id-b296fee0ec1bc2b1027fa8e3">
                        <code>src/Nethermind/Nethermind.Optimism/Rpc/IOptimismEthRpcModule.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Rpc/IOptimismEthRpcModule.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+50</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b296fee0ec1bc2b1027fa8e3"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;IOptimismEthRpcModule.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;IOptimismEthRpcModule.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..6fd24f38c871c0f685f040540f8c0cb79c9fff6d</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;IOptimismEthRpcModule.cs</span>
<span class="term-fg36">@@ -0,0 +1,50 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules.Eth;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules;</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.JsonRpc;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Find;</span>
<span class="term-fg32">+using Nethermind.Int256;</span>
<span class="term-fg32">+using System.Threading.Tasks;</span>
<span class="term-fg32">+using Nethermind.Facade.Eth;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+[RpcModule(ModuleType.Eth)]</span>
<span class="term-fg32">+public interface IOptimismEthRpcModule : IEthRpcModule</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    [JsonRpcMethod(Description = &quot;Get receipts from all transactions from particular block, more efficient than fetching the receipts one-by-one.&quot;,</span>
<span class="term-fg32">+          IsImplemented = true,</span>
<span class="term-fg32">+          ExampleResponse = &quot;{\&quot;jsonrpc\&quot;:\&quot;2.0\&quot;,\&quot;result\&quot;:[{\&quot;transactionHash\&quot;:\&quot;0x681c2b6f99e37fd6fe6046db8b51ec3460d699cacd6a376143fd5842ac50621f\&quot;,\&quot;transactionIndex\&quot;:\&quot;0x0\&quot;,\&quot;blockHash\&quot;:\&quot;0x29f141925d2d8e357ae5b6040c97aa12d7ac6dfcbe2b20e7b616d8907ac8e1f3\&quot;,\&quot;blockNumber\&quot;:\&quot;0x3\&quot;,\&quot;cumulativeGasUsed\&quot;:\&quot;0x5208\&quot;,\&quot;gasUsed\&quot;:\&quot;0x5208\&quot;,\&quot;effectiveGasPrice\&quot;:\&quot;0x1\&quot;,\&quot;from\&quot;:\&quot;0xb7705ae4c6f81b66cdb323c65f4e8133690fc099\&quot;,\&quot;to\&quot;:\&quot;0x942921b14f1b1c385cd7e0cc2ef7abe5598c8358\&quot;,\&quot;contractAddress\&quot;:null,\&quot;logs\&quot;:[],\&quot;logsBloom\&quot;:\&quot;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\&quot;,\&quot;status\&quot;:\&quot;0x1\&quot;,\&quot;type\&quot;:\&quot;0x0\&quot;},{\&quot;transactionHash\&quot;:\&quot;0x7126cf20a0ad8bd51634837d9049615c34c1bff5e1a54e5663f7e23109bff48b\&quot;,\&quot;transactionIndex\&quot;:\&quot;0x1\&quot;,\&quot;blockHash\&quot;:\&quot;0x29f141925d2d8e357ae5b6040c97aa12d7ac6dfcbe2b20e7b616d8907ac8e1f3\&quot;,\&quot;blockNumber\&quot;:\&quot;0x3\&quot;,\&quot;cumulativeGasUsed\&quot;:\&quot;0xa410\&quot;,\&quot;gasUsed\&quot;:\&quot;0x5208\&quot;,\&quot;effectiveGasPrice\&quot;:\&quot;0x1\&quot;,\&quot;from\&quot;:\&quot;0xb7705ae4c6f81b66cdb323c65f4e8133690fc099\&quot;,\&quot;to\&quot;:\&quot;0x942921b14f1b1c385cd7e0cc2ef7abe5598c8358\&quot;,\&quot;contractAddress\&quot;:null,\&quot;logs\&quot;:[],\&quot;logsBloom\&quot;:\&quot;0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000\&quot;,\&quot;status\&quot;:\&quot;0x1\&quot;,\&quot;type\&quot;:\&quot;0x0\&quot;}],\&quot;id\&quot;:67}&quot;)]</span>
<span class="term-fg32">+    new ResultWrapper&lt;OptimismReceiptForRpc[]?&gt; eth_getBlockReceipts([JsonRpcParameter(ExampleValue = &quot;latest&quot;)] BlockParameter blockParameter);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(IsImplemented = true,</span>
<span class="term-fg32">+        Description = &quot;Retrieves a transaction receipt by tx hash&quot;,</span>
<span class="term-fg32">+        IsSharable = true,</span>
<span class="term-fg32">+        ExampleResponse = &quot;{\&quot;transactionHash\&quot;:\&quot;0x80757153e93d1b475e203406727b62a501187f63e23b8fa999279e219ee3be71\&quot;,\&quot;transactionIndex\&quot;:\&quot;0x7\&quot;,\&quot;blockHash\&quot;:\&quot;0x42def051b21038905cd2a2bc28d460a94df2249466847f0e1bcb4be4eb21891a\&quot;,\&quot;blockNumber\&quot;:\&quot;0x4e3f39\&quot;,\&quot;cumulativeGasUsed\&quot;:\&quot;0x62c9d\&quot;,\&quot;gasUsed\&quot;:\&quot;0xe384\&quot;,\&quot;effectiveGasPrice\&quot;:\&quot;0x12a05f200\&quot;,\&quot;from\&quot;:\&quot;0x0afe0a94415e8974052e7e6cfab19ee1c2ef4f69\&quot;,\&quot;to\&quot;:\&quot;0x19e8c84d4943e58b035626b064cfc76ee13ee6cb\&quot;,\&quot;contractAddress\&quot;:null,\&quot;logs\&quot;:[{\&quot;removed\&quot;:false,\&quot;logIndex\&quot;:\&quot;0x0\&quot;,\&quot;transactionIndex\&quot;:\&quot;0x7\&quot;,\&quot;transactionHash\&quot;:\&quot;0x80757153e93d1b475e203406727b62a501187f63e23b8fa999279e219ee3be71\&quot;,\&quot;blockHash\&quot;:\&quot;0x42def051b21038905cd2a2bc28d460a94df2249466847f0e1bcb4be4eb21891a\&quot;,\&quot;blockNumber\&quot;:\&quot;0x4e3f39\&quot;,\&quot;address\&quot;:\&quot;0x2ac3c1d3e24b45c6c310534bc2dd84b5ed576335\&quot;,\&quot;data\&quot;:\&quot;0x0000000000000000000000000000000000000000000000000000000000000000\&quot;,\&quot;topics\&quot;:[\&quot;0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef\&quot;,\&quot;0x00000000000000000000000019e8c84d4943e58b035626b064cfc76ee13ee6cb\&quot;,\&quot;0x00000000000000000000000028078300a459a9e136f872285654cdc74463041e\&quot;]},{\&quot;removed\&quot;:false,\&quot;logIndex\&quot;:\&quot;0x1\&quot;,\&quot;transactionIndex\&quot;:\&quot;0x7\&quot;,\&quot;transactionHash\&quot;:\&quot;0x80757153e93d1b475e203406727b62a501187f63e23b8fa999279e219ee3be71\&quot;,\&quot;blockHash\&quot;:\&quot;0x42def051b21038905cd2a2bc28d460a94df2249466847f0e1bcb4be4eb21891a\&quot;,\&quot;blockNumber\&quot;:\&quot;0x4e3f39\&quot;,\&quot;address\&quot;:\&quot;0x19e8c84d4943e58b035626b064cfc76ee13ee6cb\&quot;,\&quot;data\&quot;:\&quot;0x000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000007735940000000000000000000000000000000000000000000000000000000000000000000\&quot;,\&quot;topics\&quot;:[\&quot;0x950494fc3642fae5221b6c32e0e45765c95ebb382a04a71b160db0843e74c99f\&quot;,\&quot;0x0000000000000000000000000afe0a94415e8974052e7e6cfab19ee1c2ef4f69\&quot;,\&quot;0x00000000000000000000000028078300a459a9e136f872285654cdc74463041e\&quot;,\&quot;0x0000000000000000000000000afe0a94415e8974052e7e6cfab19ee1c2ef4f69\&quot;]}],\&quot;logsBloom\&quot;:\&quot;0x00000000000000000000000000000000000000000000000020000000000000800000000000000000000400000000000000000000000000000000000000002000000000000000000000000008000000000000000000000000000000000000000000000002002000000000000000000000000000000000000000000812000000000000000000000000000001000000000000000000000008000400008000000000000000000000000000000000000000000000000000000000800000000000000000000002000000000000000000000000000000000000100000000000000000002000000000000000000000000010000000000000000000000400000000020000\&quot;,\&quot;status\&quot;:\&quot;0x1\&quot;,\&quot;type\&quot;:\&quot;0x0\&quot;}&quot;)]</span>
<span class="term-fg32">+    new ResultWrapper&lt;OptimismReceiptForRpc?&gt; eth_getTransactionReceipt([JsonRpcParameter(ExampleValue = &quot;[\&quot;0x80757153e93d1b475e203406727b62a501187f63e23b8fa999279e219ee3be71\&quot;]&quot;)] Hash256 txHashData);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(IsImplemented = true,</span>
<span class="term-fg32">+            Description = &quot;Retrieves a transaction by hash&quot;,</span>
<span class="term-fg32">+            IsSharable = true,</span>
<span class="term-fg32">+            ExampleResponse = &quot;{\&quot;hash\&quot;:\&quot;0xabca23910646013d608ec671de099447ab60b2b7159ad8319c3c088e8d9ea0fa\&quot;,\&quot;nonce\&quot;:\&quot;0x1a\&quot;,\&quot;blockHash\&quot;:\&quot;0xcb6756f69e0469acd5e5bb77966be580786ec2c11de85c9ddfd75257010e34f8\&quot;,\&quot;blockNumber\&quot;:\&quot;0x4dfbc7\&quot;,\&quot;transactionIndex\&quot;:\&quot;0xb\&quot;,\&quot;from\&quot;:\&quot;0xe1e7ab1c643dbe5b24739fdf2a5c7c193b54dd99\&quot;,\&quot;to\&quot;:\&quot;0x0b10e304088b2ba2b2acfd2f72573faad31a13a5\&quot;,\&quot;value\&quot;:\&quot;0x0\&quot;,\&quot;gasPrice\&quot;:\&quot;0x2540be400\&quot;,\&quot;gas\&quot;:\&quot;0xb4a4\&quot;,\&quot;data\&quot;:\&quot;0x095ea7b300000000000000000000000092c1576845703089cf6c0788379ed81f75f45dd500000000000000000000000000000000000000000000000000000002540be400\&quot;,\&quot;input\&quot;:\&quot;0x095ea7b300000000000000000000000092c1576845703089cf6c0788379ed81f75f45dd500000000000000000000000000000000000000000000000000000002540be400\&quot;,\&quot;type\&quot;:\&quot;0x0\&quot;,\&quot;v\&quot;:\&quot;0x2d\&quot;,\&quot;s\&quot;:\&quot;0x496d72d435ead8a8a9a865b14d6a102c1a9f848681d050dbbf11c522c612235\&quot;,\&quot;r\&quot;:\&quot;0xc8350e831203fecc8bff41f5cf858ac1d121e4b4d9e59c1137cc9440516ca9fd\&quot;}&quot;)]</span>
<span class="term-fg32">+    new ResultWrapper&lt;OptimismTransactionForRpc?&gt; eth_getTransactionByHash(</span>
<span class="term-fg32">+            [JsonRpcParameter(ExampleValue = &quot;\&quot;0xabca23910646013d608ec671de099447ab60b2b7159ad8319c3c088e8d9ea0fa\&quot;&quot;)] Hash256 transactionHash);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(IsImplemented = true,</span>
<span class="term-fg32">+           Description = &quot;Retrieves a transaction by block hash and index&quot;,</span>
<span class="term-fg32">+           IsSharable = true,</span>
<span class="term-fg32">+           ExampleResponse = &quot;{\&quot;hash\&quot;:\&quot;0xb87ec4c8cb36a06f49cdd93c2e9f63e0b7db9af07a605c8bcf1fbe705162344e\&quot;,\&quot;nonce\&quot;:\&quot;0x5d\&quot;,\&quot;blockHash\&quot;:\&quot;0xfe47fb3539ccce9d19a032473effdd6ce19e3c921bbae2746152ccf82ceef48e\&quot;,\&quot;blockNumber\&quot;:\&quot;0x4dfc90\&quot;,\&quot;transactionIndex\&quot;:\&quot;0x2\&quot;,\&quot;from\&quot;:\&quot;0xaa9a0f962e433755c843175488fe088fccf8526f\&quot;,\&quot;to\&quot;:\&quot;0x074b24cef703f17fe123fa1b82081055775b7004\&quot;,\&quot;value\&quot;:\&quot;0x0\&quot;,\&quot;gasPrice\&quot;:\&quot;0x2540be401\&quot;,\&quot;gas\&quot;:\&quot;0x130ab\&quot;,\&quot;data\&quot;:\&quot;0x428dc451000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000030000000000000000000000005d3c0f4ca5ee99f8e8f59ff9a5fab04f6a7e007f0000000000000000000000009d233a907e065855d2a9c7d4b552ea27fb2e5a36000000000000000000000000cbe56b00d173a26a5978ce90db2e33622fd95a28\&quot;,\&quot;input\&quot;:\&quot;0x428dc451000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000030000000000000000000000005d3c0f4ca5ee99f8e8f59ff9a5fab04f6a7e007f0000000000000000000000009d233a907e065855d2a9c7d4b552ea27fb2e5a36000000000000000000000000cbe56b00d173a26a5978ce90db2e33622fd95a28\&quot;,\&quot;type\&quot;:\&quot;0x0\&quot;,\&quot;v\&quot;:\&quot;0x2e\&quot;,\&quot;s\&quot;:\&quot;0x696f6db060a6dd30435a7f592506ba3213f81cf4704e211a1a45a99f8984189a\&quot;,\&quot;r\&quot;:\&quot;0x7e07076186e38b68cb7e4f68a04258a5744c5a2ad1a7153456ee662a07902954\&quot;}&quot;)]</span>
<span class="term-fg32">+    new ResultWrapper&lt;OptimismTransactionForRpc?&gt; eth_getTransactionByBlockHashAndIndex(</span>
<span class="term-fg32">+           [JsonRpcParameter(ExampleValue = &quot;[\&quot;0xfe47fb3539ccce9d19a032473effdd6ce19e3c921bbae2746152ccf82ceef48e\&quot;,\&quot;0x2\&quot;]&quot;)] Hash256 blockHash, UInt256 positionIndex);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonRpcMethod(IsImplemented = true,</span>
<span class="term-fg32">+            Description = &quot;Retrieves a transaction by block number and index&quot;,</span>
<span class="term-fg32">+            IsSharable = true,</span>
<span class="term-fg32">+            ExampleResponse = &quot;{\&quot;hash\&quot;:\&quot;0xfd320a4949990929f64b52041c58a74c8ce13289b3d6853bd8073b0580aa031a\&quot;,\&quot;nonce\&quot;:\&quot;0x5b\&quot;,\&quot;blockHash\&quot;:\&quot;0xd779e1a5ce8f34544d66d219bb3e5331a7b280fae89a36d7d52813a23e1ca1e3\&quot;,\&quot;blockNumber\&quot;:\&quot;0x4dfdd8\&quot;,\&quot;transactionIndex\&quot;:\&quot;0x8\&quot;,\&quot;from\&quot;:\&quot;0xadb540569e2db497bd973c141b0b63be98461e40\&quot;,\&quot;to\&quot;:\&quot;0x074b24cef703f17fe123fa1b82081055775b7004\&quot;,\&quot;value\&quot;:\&quot;0x0\&quot;,\&quot;gasPrice\&quot;:\&quot;0x12a05f200\&quot;,\&quot;gas\&quot;:\&quot;0x927c0\&quot;,\&quot;data\&quot;:\&quot;0x428dc451000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000030000000000000000000000005d3c0f4ca5ee99f8e8f59ff9a5fab04f6a7e007f0000000000000000000000009d233a907e065855d2a9c7d4b552ea27fb2e5a36000000000000000000000000cbe56b00d173a26a5978ce90db2e33622fd95a28\&quot;,\&quot;input\&quot;:\&quot;0x428dc451000000000000000000000000000000000000000000000000000000000000002000000000000000000000000000000000000000000000000000000000000000030000000000000000000000005d3c0f4ca5ee99f8e8f59ff9a5fab04f6a7e007f0000000000000000000000009d233a907e065855d2a9c7d4b552ea27fb2e5a36000000000000000000000000cbe56b00d173a26a5978ce90db2e33622fd95a28\&quot;,\&quot;type\&quot;:\&quot;0x0\&quot;,\&quot;v\&quot;:\&quot;0x2e\&quot;,\&quot;s\&quot;:\&quot;0x37b90a929884787df717c87258f0434e2f115ce2fbb4bfc230322112fa9d5bbc\&quot;,\&quot;r\&quot;:\&quot;0x5222eff9e16b5c3e9e8901d9c45fc8e0f9cf774e8a56546a504025ef67ceefec\&quot;}&quot;)]</span>
<span class="term-fg32">+    new ResultWrapper&lt;OptimismTransactionForRpc?&gt; eth_getTransactionByBlockNumberAndIndex(</span>
<span class="term-fg32">+        [JsonRpcParameter(ExampleValue = &quot;[\&quot;5111256\&quot;,\&quot;0x8\&quot;]&quot;)] BlockParameter blockParameter, UInt256 positionIndex);</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-5dd35ebab621f44a573723d3" role="button"
                       aria-expanded="false" aria-controls="id-5dd35ebab621f44a573723d3">
                        <code>src/Nethermind/Nethermind.Optimism/Rpc/OptimismEngineRpcModule.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Rpc/OptimismEngineRpcModule.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+66</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-5dd35ebab621f44a573723d3"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismEngineRpcModule.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismEngineRpcModule.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..9d0bf66a565574258c4a5fc1100411326ff8fbb7</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismEngineRpcModule.cs</span>
<span class="term-fg36">@@ -0,0 +1,66 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System.Threading.Tasks;</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.JsonRpc;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.Data;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismEngineRpcModule : IOptimismEngineRpcModule</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly IEngineRpcModule _engineRpcModule;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public async Task&lt;ResultWrapper&lt;ForkchoiceUpdatedV1Result&gt;&gt; engine_forkchoiceUpdatedV1(ForkchoiceStateV1 forkchoiceState, OptimismPayloadAttributes? payloadAttributes = null)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return await _engineRpcModule.engine_forkchoiceUpdatedV1(forkchoiceState, payloadAttributes);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Task&lt;ResultWrapper&lt;ExecutionPayload?&gt;&gt; engine_getPayloadV1(byte[] payloadId)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return _engineRpcModule.engine_getPayloadV1(payloadId);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Task&lt;ResultWrapper&lt;PayloadStatusV1&gt;&gt; engine_newPayloadV1(ExecutionPayload executionPayload)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return _engineRpcModule.engine_newPayloadV1(executionPayload);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public async Task&lt;ResultWrapper&lt;ForkchoiceUpdatedV1Result&gt;&gt; engine_forkchoiceUpdatedV2(ForkchoiceStateV1 forkchoiceState, OptimismPayloadAttributes? payloadAttributes = null)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return await _engineRpcModule.engine_forkchoiceUpdatedV2(forkchoiceState, payloadAttributes);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Task&lt;ResultWrapper&lt;GetPayloadV2Result?&gt;&gt; engine_getPayloadV2(byte[] payloadId)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return _engineRpcModule.engine_getPayloadV2(payloadId);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Task&lt;ResultWrapper&lt;PayloadStatusV1&gt;&gt; engine_newPayloadV2(ExecutionPayload executionPayload)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return _engineRpcModule.engine_newPayloadV2(executionPayload);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public async Task&lt;ResultWrapper&lt;ForkchoiceUpdatedV1Result&gt;&gt; engine_forkchoiceUpdatedV3(ForkchoiceStateV1 forkchoiceState, OptimismPayloadAttributes? payloadAttributes = null)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return await _engineRpcModule.engine_forkchoiceUpdatedV3(forkchoiceState, payloadAttributes);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public async Task&lt;ResultWrapper&lt;OptimismGetPayloadV3Result?&gt;&gt; engine_getPayloadV3(byte[] payloadId)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        ResultWrapper&lt;GetPayloadV3Result?&gt; result = await _engineRpcModule.engine_getPayloadV3(payloadId);</span>
<span class="term-fg32">+        return ResultWrapper&lt;OptimismGetPayloadV3Result?&gt;.From(result, result.Data is null ? null : new OptimismGetPayloadV3Result(result.Data));</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Task&lt;ResultWrapper&lt;PayloadStatusV1&gt;&gt; engine_newPayloadV3(ExecutionPayloadV3 executionPayload, byte[]?[] blobVersionedHashes, Hash256? parentBeaconBlockRoot)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return _engineRpcModule.engine_newPayloadV3(executionPayload, blobVersionedHashes, parentBeaconBlockRoot);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismEngineRpcModule(IEngineRpcModule engineRpcModule)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _engineRpcModule = engineRpcModule;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6a72638c6b285c4ce7ef154b" role="button"
                       aria-expanded="false" aria-controls="id-6a72638c6b285c4ce7ef154b">
                        <code>src/Nethermind/Nethermind.Optimism/Rpc/OptimismEthModuleFactory.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Rpc/OptimismEthModuleFactory.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+91</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6a72638c6b285c4ce7ef154b"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismEthModuleFactory.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismEthModuleFactory.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..6d575a75d0ce6f31f0c828c38ff363e0ee71aa3d</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismEthModuleFactory.cs</span>
<span class="term-fg36">@@ -0,0 +1,91 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Receipts;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Facade;</span>
<span class="term-fg32">+using Nethermind.Facade.Eth;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules.Eth.GasPrice;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules.Eth.FeeHistory;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+using Nethermind.TxPool;</span>
<span class="term-fg32">+using Nethermind.Wallet;</span>
<span class="term-fg32">+using Nethermind.JsonRpc;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Find;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Crypto;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Client;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismEthModuleFactory(</span>
<span class="term-fg32">+        IJsonRpcConfig rpcConfig,</span>
<span class="term-fg32">+        IBlockchainBridgeFactory blockchainBridgeFactory,</span>
<span class="term-fg32">+        IBlockFinder blockFinder,</span>
<span class="term-fg32">+        IReceiptFinder receiptFinder,</span>
<span class="term-fg32">+        IStateReader stateReader,</span>
<span class="term-fg32">+        ITxPool txPool,</span>
<span class="term-fg32">+        ITxSender txSender,</span>
<span class="term-fg32">+        IWallet wallet,</span>
<span class="term-fg32">+        ILogManager logManager,</span>
<span class="term-fg32">+        ISpecProvider specProvider,</span>
<span class="term-fg32">+        IGasPriceOracle gasPriceOracle,</span>
<span class="term-fg32">+        IEthSyncingInfo ethSyncingInfo,</span>
<span class="term-fg32">+        IFeeHistoryOracle feeHistoryOracle,</span>
<span class="term-fg32">+        ulong? secondsPerSlot,</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        IJsonRpcClient? sequencerRpcClient,</span>
<span class="term-fg32">+        IAccountStateProvider accountStateProvider,</span>
<span class="term-fg32">+        IEthereumEcdsa ecdsa,</span>
<span class="term-fg32">+        ITxSealer sealer,</span>
<span class="term-fg32">+        IOptimismSpecHelper opSpecHelper</span>
<span class="term-fg32">+        )</span>
<span class="term-fg32">+        : ModuleFactoryBase&lt;IOptimismEthRpcModule&gt;</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly ILogManager _logManager = logManager ?? throw new ArgumentNullException(nameof(logManager));</span>
<span class="term-fg32">+    private readonly IStateReader _stateReader = stateReader ?? throw new ArgumentNullException(nameof(stateReader));</span>
<span class="term-fg32">+    private readonly IBlockchainBridgeFactory _blockchainBridgeFactory = blockchainBridgeFactory ?? throw new ArgumentNullException(nameof(blockchainBridgeFactory));</span>
<span class="term-fg32">+    private readonly ITxPool _txPool = txPool ?? throw new ArgumentNullException(nameof(txPool));</span>
<span class="term-fg32">+    private readonly ITxSender _txSender = txSender ?? throw new ArgumentNullException(nameof(txSender));</span>
<span class="term-fg32">+    private readonly IWallet _wallet = wallet ?? throw new ArgumentNullException(nameof(wallet));</span>
<span class="term-fg32">+    private readonly IJsonRpcConfig _rpcConfig = rpcConfig ?? throw new ArgumentNullException(nameof(rpcConfig));</span>
<span class="term-fg32">+    private readonly ISpecProvider _specProvider = specProvider ?? throw new ArgumentNullException(nameof(specProvider));</span>
<span class="term-fg32">+    private readonly IGasPriceOracle _gasPriceOracle = gasPriceOracle ?? throw new ArgumentNullException(nameof(gasPriceOracle));</span>
<span class="term-fg32">+    private readonly IEthSyncingInfo _ethSyncingInfo = ethSyncingInfo ?? throw new ArgumentNullException(nameof(ethSyncingInfo));</span>
<span class="term-fg32">+    private readonly IFeeHistoryOracle _feeHistoryOracle = feeHistoryOracle ?? throw new ArgumentNullException(nameof(feeHistoryOracle));</span>
<span class="term-fg32">+    private readonly IAccountStateProvider _accountStateProvider = accountStateProvider ?? throw new ArgumentNullException(nameof(accountStateProvider));</span>
<span class="term-fg32">+    private readonly IEthereumEcdsa _ecdsa = ecdsa ?? throw new ArgumentNullException(nameof(ecdsa));</span>
<span class="term-fg32">+    private readonly ITxSealer _sealer = sealer ?? throw new ArgumentNullException(nameof(sealer));</span>
<span class="term-fg32">+    private readonly IBlockFinder _blockFinder = blockFinder ?? throw new ArgumentNullException(nameof(blockFinder));</span>
<span class="term-fg32">+    private readonly IReceiptFinder _receiptFinder = receiptFinder ?? throw new ArgumentNullException(nameof(receiptFinder));</span>
<span class="term-fg32">+    private readonly IOptimismSpecHelper _opSpecHelper = opSpecHelper ?? throw new ArgumentNullException(nameof(opSpecHelper));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public override IOptimismEthRpcModule Create()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return new OptimismEthRpcModule(</span>
<span class="term-fg32">+            _rpcConfig,</span>
<span class="term-fg32">+            _blockchainBridgeFactory.CreateBlockchainBridge(),</span>
<span class="term-fg32">+            _blockFinder,</span>
<span class="term-fg32">+            _receiptFinder,</span>
<span class="term-fg32">+            _stateReader,</span>
<span class="term-fg32">+            _txPool,</span>
<span class="term-fg32">+            _txSender,</span>
<span class="term-fg32">+            _wallet,</span>
<span class="term-fg32">+            _logManager,</span>
<span class="term-fg32">+            _specProvider,</span>
<span class="term-fg32">+            _gasPriceOracle,</span>
<span class="term-fg32">+            _ethSyncingInfo,</span>
<span class="term-fg32">+            _feeHistoryOracle,</span>
<span class="term-fg32">+            secondsPerSlot,</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            sequencerRpcClient,</span>
<span class="term-fg32">+            _accountStateProvider,</span>
<span class="term-fg32">+            _ecdsa,</span>
<span class="term-fg32">+            _sealer,</span>
<span class="term-fg32">+            _opSpecHelper</span>
<span class="term-fg32">+            );</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c5276588751848014d4821bd" role="button"
                       aria-expanded="false" aria-controls="id-c5276588751848014d4821bd">
                        <code>src/Nethermind/Nethermind.Optimism/Rpc/OptimismEthRpcModule.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Rpc/OptimismEthRpcModule.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+260</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c5276588751848014d4821bd"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismEthRpcModule.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismEthRpcModule.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..8a3d55863917e9dc667bda699d8390272c1af411</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismEthRpcModule.cs</span>
<span class="term-fg36">@@ -0,0 +1,260 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System.Linq;</span>
<span class="term-fg32">+using System.Threading.Tasks;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Find;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Receipts;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Crypto;</span>
<span class="term-fg32">+using Nethermind.Evm;</span>
<span class="term-fg32">+using Nethermind.Facade;</span>
<span class="term-fg32">+using Nethermind.Facade.Eth;</span>
<span class="term-fg32">+using Nethermind.Int256;</span>
<span class="term-fg32">+using Nethermind.JsonRpc;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Client;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules.Eth;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules.Eth.FeeHistory;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules.Eth.GasPrice;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.Serialization.Rlp;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+using Nethermind.Synchronization.ParallelSync;</span>
<span class="term-fg32">+using Nethermind.TxPool;</span>
<span class="term-fg32">+using Nethermind.Wallet;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismEthRpcModule : EthRpcModule, IOptimismEthRpcModule</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly IJsonRpcClient? _sequencerRpcClient;</span>
<span class="term-fg32">+    private readonly IAccountStateProvider _accountStateProvider;</span>
<span class="term-fg32">+    private readonly IEthereumEcdsa _ecdsa;</span>
<span class="term-fg32">+    private readonly ITxSealer _sealer;</span>
<span class="term-fg32">+    private readonly IOptimismSpecHelper _opSpecHelper;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public OptimismEthRpcModule(</span>
<span class="term-fg32">+        IJsonRpcConfig rpcConfig,</span>
<span class="term-fg32">+        IBlockchainBridge blockchainBridge,</span>
<span class="term-fg32">+        IBlockFinder blockFinder,</span>
<span class="term-fg32">+        IReceiptFinder receiptFinder,</span>
<span class="term-fg32">+        IStateReader stateReader,</span>
<span class="term-fg32">+        ITxPool txPool,</span>
<span class="term-fg32">+        ITxSender txSender,</span>
<span class="term-fg32">+        IWallet wallet,</span>
<span class="term-fg32">+        ILogManager logManager,</span>
<span class="term-fg32">+        ISpecProvider specProvider,</span>
<span class="term-fg32">+        IGasPriceOracle gasPriceOracle,</span>
<span class="term-fg32">+        IEthSyncingInfo ethSyncingInfo,</span>
<span class="term-fg32">+        IFeeHistoryOracle feeHistoryOracle,</span>
<span class="term-fg32">+        ulong? secondsPerSlot,</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        IJsonRpcClient? sequencerRpcClient,</span>
<span class="term-fg32">+        IAccountStateProvider accountStateProvider,</span>
<span class="term-fg32">+        IEthereumEcdsa ecdsa,</span>
<span class="term-fg32">+        ITxSealer sealer,</span>
<span class="term-fg32">+        IOptimismSpecHelper opSpecHelper) : base(</span>
<span class="term-fg32">+       rpcConfig,</span>
<span class="term-fg32">+       blockchainBridge,</span>
<span class="term-fg32">+       blockFinder,</span>
<span class="term-fg32">+       receiptFinder,</span>
<span class="term-fg32">+       stateReader,</span>
<span class="term-fg32">+       txPool,</span>
<span class="term-fg32">+       txSender,</span>
<span class="term-fg32">+       wallet,</span>
<span class="term-fg32">+       logManager,</span>
<span class="term-fg32">+       specProvider,</span>
<span class="term-fg32">+       gasPriceOracle,</span>
<span class="term-fg32">+       ethSyncingInfo,</span>
<span class="term-fg32">+       feeHistoryOracle,</span>
<span class="term-fg32">+       secondsPerSlot)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _sequencerRpcClient = sequencerRpcClient;</span>
<span class="term-fg32">+        _accountStateProvider = accountStateProvider;</span>
<span class="term-fg32">+        _ecdsa = ecdsa;</span>
<span class="term-fg32">+        _sealer = sealer;</span>
<span class="term-fg32">+        _opSpecHelper = opSpecHelper;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public new ResultWrapper&lt;OptimismReceiptForRpc[]?&gt; eth_getBlockReceipts(BlockParameter blockParameter)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        static ResultWrapper&lt;OptimismReceiptForRpc[]?&gt; GetBlockReceipts(IReceiptFinder receiptFinder, BlockParameter blockParameter, IBlockFinder blockFinder, ISpecProvider specProvider, IOptimismSpecHelper opSpecHelper)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            SearchResult&lt;Block&gt; searchResult = blockFinder.SearchForBlock(blockParameter);</span>
<span class="term-fg32">+            if (searchResult.IsError)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                return ResultWrapper&lt;OptimismReceiptForRpc[]?&gt;.Success(null);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            Block? block = searchResult.Object!;</span>
<span class="term-fg32">+            OptimismTxReceipt[] receipts = receiptFinder.Get(block).Cast&lt;OptimismTxReceipt&gt;().ToArray() ?? new OptimismTxReceipt[block.Transactions.Length];</span>
<span class="term-fg32">+            bool isEip1559Enabled = specProvider.GetSpec(block.Header).IsEip1559Enabled;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            L1BlockGasInfo l1BlockGasInfo = new(block, opSpecHelper);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            OptimismReceiptForRpc[]? result = [.. receipts</span>
<span class="term-fg32">+                .Zip(block.Transactions, (r, t) =&gt;</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    return new OptimismReceiptForRpc(t.Hash!, r, t.GetGasInfo(isEip1559Enabled, block.Header), l1BlockGasInfo.GetTxGasInfo(t), receipts.GetBlockLogFirstIndex(r.Index));</span>
<span class="term-fg32">+                })];</span>
<span class="term-fg32">+            return ResultWrapper&lt;OptimismReceiptForRpc[]?&gt;.Success(result);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return GetBlockReceipts(_receiptFinder, blockParameter, _blockFinder, _specProvider, _opSpecHelper);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public override async Task&lt;ResultWrapper&lt;Hash256&gt;&gt; eth_sendTransaction(TransactionForRpc rpcTx)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        Transaction tx = rpcTx.ToTransactionWithDefaults(_blockchainBridge.GetChainId());</span>
<span class="term-fg32">+        tx.SenderAddress ??= _ecdsa.RecoverAddress(tx);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (tx.SenderAddress is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return ResultWrapper&lt;Hash256&gt;.Fail(&quot;Failed to recover sender&quot;);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (rpcTx.Nonce is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            tx.Nonce = _accountStateProvider.GetNonce(tx.SenderAddress);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        await _sealer.Seal(tx, TxHandlingOptions.None);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return await eth_sendRawTransaction(Rlp.Encode(tx, RlpBehaviors.SkipTypedWrapping).Bytes);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public override async Task&lt;ResultWrapper&lt;Hash256&gt;&gt; eth_sendRawTransaction(byte[] transaction)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (_sequencerRpcClient is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return await base.eth_sendRawTransaction(transaction);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Hash256? result = await _sequencerRpcClient.Post&lt;Hash256&gt;(nameof(eth_sendRawTransaction), transaction);</span>
<span class="term-fg32">+        if (result is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return ResultWrapper&lt;Hash256&gt;.Fail(&quot;Failed to forward transaction&quot;);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return ResultWrapper&lt;Hash256&gt;.Success(result);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public new ResultWrapper&lt;OptimismReceiptForRpc?&gt; eth_getTransactionReceipt(Hash256 txHash)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        (TxReceipt? receipt, TxGasInfo? gasInfo, int logIndexStart) = _blockchainBridge.GetReceiptAndGasInfo(txHash);</span>
<span class="term-fg32">+        if (receipt is null || gasInfo is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return ResultWrapper&lt;OptimismReceiptForRpc?&gt;.Success(null);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        SearchResult&lt;Block&gt; foundBlock = _blockFinder.SearchForBlock(new(receipt.BlockHash!));</span>
<span class="term-fg32">+        if (foundBlock.Object is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return ResultWrapper&lt;OptimismReceiptForRpc?&gt;.Success(null);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Block block = foundBlock.Object;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        L1BlockGasInfo l1GasInfo = new(block, _opSpecHelper);</span>
<span class="term-fg32">+        return ResultWrapper&lt;OptimismReceiptForRpc?&gt;.Success(</span>
<span class="term-fg32">+            new(txHash, (OptimismTxReceipt)receipt, gasInfo.Value, l1GasInfo.GetTxGasInfo(block.Transactions.First(tx =&gt; tx.Hash == txHash)), logIndexStart));</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public new ResultWrapper&lt;OptimismTransactionForRpc?&gt; eth_getTransactionByHash(Hash256 transactionHash)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        (TxReceipt? receipt, Transaction? transaction, UInt256? baseFee) = _blockchainBridge.GetTransaction(transactionHash, checkTxnPool: true);</span>
<span class="term-fg32">+        if (transaction is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return ResultWrapper&lt;OptimismTransactionForRpc?&gt;.Success(null);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        RecoverTxSenderIfNeeded(transaction);</span>
<span class="term-fg32">+        OptimismTransactionForRpc transactionModel = new(receipt?.BlockHash, receipt as OptimismTxReceipt, transaction, baseFee);</span>
<span class="term-fg32">+        if (_logger.IsTrace) _logger.Trace($&quot;eth_getTransactionByHash request {transactionHash}, result: {transactionModel.Hash}&quot;);</span>
<span class="term-fg32">+        return ResultWrapper&lt;OptimismTransactionForRpc?&gt;.Success(transactionModel);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public new ResultWrapper&lt;OptimismTransactionForRpc?&gt; eth_getTransactionByBlockHashAndIndex(Hash256 blockHash,</span>
<span class="term-fg32">+        UInt256 positionIndex)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        SearchResult&lt;Block&gt; searchResult = _blockFinder.SearchForBlock(new BlockParameter(blockHash));</span>
<span class="term-fg32">+        if (searchResult.IsError || searchResult.Object is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return GetFailureResult&lt;OptimismTransactionForRpc?, Block&gt;(searchResult, _ethSyncingInfo.SyncMode.HaveNotSyncedBodiesYet());</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Block block = searchResult.Object;</span>
<span class="term-fg32">+        if (positionIndex &lt; 0 || positionIndex &gt; block!.Transactions.Length - 1)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return ResultWrapper&lt;OptimismTransactionForRpc?&gt;.Fail(&quot;Position Index is incorrect&quot;, ErrorCodes.InvalidParams);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        OptimismTxReceipt[] receipts = _receiptFinder.Get(block).Cast&lt;OptimismTxReceipt&gt;().ToArray();</span>
<span class="term-fg32">+        Transaction transaction = block.Transactions[(int)positionIndex];</span>
<span class="term-fg32">+        RecoverTxSenderIfNeeded(transaction);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        OptimismTransactionForRpc transactionModel = new(block.Hash, receipts.FirstOrDefault(r =&gt; r.TxHash == transaction.Hash), transaction, block.BaseFeePerGas);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return ResultWrapper&lt;OptimismTransactionForRpc?&gt;.Success(transactionModel);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public new ResultWrapper&lt;OptimismTransactionForRpc?&gt; eth_getTransactionByBlockNumberAndIndex(BlockParameter blockParameter,</span>
<span class="term-fg32">+        UInt256 positionIndex)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        SearchResult&lt;Block&gt; searchResult = _blockFinder.SearchForBlock(blockParameter);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (searchResult.IsError)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return GetFailureResult&lt;OptimismTransactionForRpc?, Block&gt;(searchResult, _ethSyncingInfo.SyncMode.HaveNotSyncedBodiesYet());</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Block? block = searchResult.Object;</span>
<span class="term-fg32">+        if (positionIndex &lt; 0 || positionIndex &gt; block!.Transactions.Length - 1)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return ResultWrapper&lt;OptimismTransactionForRpc?&gt;.Fail(&quot;Position Index is incorrect&quot;, ErrorCodes.InvalidParams);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        OptimismTxReceipt[] receipts = _receiptFinder.Get(block).Cast&lt;OptimismTxReceipt&gt;().ToArray();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Transaction transaction = block.Transactions[(int)positionIndex];</span>
<span class="term-fg32">+        RecoverTxSenderIfNeeded(transaction);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        OptimismTransactionForRpc transactionModel = new(block.Hash, receipts.FirstOrDefault(r =&gt; r.TxHash == transaction.Hash), transaction, block.BaseFeePerGas);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (_logger.IsDebug)</span>
<span class="term-fg32">+            _logger.Debug(</span>
<span class="term-fg32">+                $&quot;eth_getTransactionByBlockNumberAndIndex request {blockParameter}, index: {positionIndex}, result: {transactionModel.Hash}&quot;);</span>
<span class="term-fg32">+        return ResultWrapper&lt;OptimismTransactionForRpc?&gt;.Success(transactionModel);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override ResultWrapper&lt;BlockForRpc?&gt; GetBlock(BlockParameter blockParameter, bool returnFullTransactionObjects)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        SearchResult&lt;Block&gt; searchResult = _blockFinder.SearchForBlock(blockParameter, true);</span>
<span class="term-fg32">+        if (searchResult.IsError)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return GetFailureResult&lt;BlockForRpc?, Block&gt;(searchResult, _ethSyncingInfo.SyncMode.HaveNotSyncedBodiesYet());</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Block? block = searchResult.Object;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (block is null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            return ResultWrapper&lt;BlockForRpc?&gt;.Success(null);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        BlockForRpc result = new BlockForRpc(block, false, _specProvider);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        OptimismTxReceipt[] receipts = _receiptFinder.Get(block).Cast&lt;OptimismTxReceipt&gt;().ToArray();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (returnFullTransactionObjects)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            _blockchainBridge.RecoverTxSenders(block);</span>
<span class="term-fg32">+            result.Transactions = result.Transactions.Select((hash, index) =&gt; new OptimismTransactionForRpc(block.Hash, receipts.FirstOrDefault(r =&gt; r.TxHash?.Equals(hash) ?? false), block.Transactions[index], block.BaseFeePerGas));</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return ResultWrapper&lt;BlockForRpc?&gt;.Success(result);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8d0355765d6c9bfed604f00e" role="button"
                       aria-expanded="false" aria-controls="id-8d0355765d6c9bfed604f00e">
                        <code>src/Nethermind/Nethermind.Optimism/Rpc/OptimismGetPayloadV3Result.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Rpc/OptimismGetPayloadV3Result.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+32</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8d0355765d6c9bfed604f00e"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismGetPayloadV3Result.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismGetPayloadV3Result.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..5a03afce861ad4194fdb2f7b8c4a97f524b1f368</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismGetPayloadV3Result.cs</span>
<span class="term-fg36">@@ -0,0 +1,32 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.Int256;</span>
<span class="term-fg32">+using Nethermind.Merge.Plugin.Data;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismGetPayloadV3Result</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public OptimismGetPayloadV3Result(GetPayloadV3Result result)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        ExecutionPayload = result.ExecutionPayload;</span>
<span class="term-fg32">+        BlockValue = result.BlockValue;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        BlobsBundle = result.BlobsBundle;</span>
<span class="term-fg32">+        ParentBeaconBlockRoot = result.ExecutionPayload.ParentBeaconBlockRoot!;</span>
<span class="term-fg32">+        ShouldOverrideBuilder = result.ShouldOverrideBuilder;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public UInt256 BlockValue { get; }</span>
<span class="term-fg32">+    public ExecutionPayload ExecutionPayload { get; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public BlobsBundleV1 BlobsBundle { get; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public Hash256 ParentBeaconBlockRoot { get; set; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public bool ShouldOverrideBuilder { get; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public override string ToString() =&gt; $&quot;{{ExecutionPayload: {ExecutionPayload}, Fees: {BlockValue}, BlobsBundle blobs count: {BlobsBundle.Blobs.Length}, ParentBeaconBlockRoot: {ParentBeaconBlockRoot}, ShouldOverrideBuilder {ShouldOverrideBuilder}}}&quot;;</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-8a36686fb12b4ec4f60babce" role="button"
                       aria-expanded="false" aria-controls="id-8a36686fb12b4ec4f60babce">
                        <code>src/Nethermind/Nethermind.Optimism/Rpc/OptimismPayloadAttributes.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Rpc/OptimismPayloadAttributes.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+130</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-8a36686fb12b4ec4f60babce"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismPayloadAttributes.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismPayloadAttributes.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..8db3156fcae1e03301031b63f752efd396e774f7</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismPayloadAttributes.cs</span>
<span class="term-fg36">@@ -0,0 +1,130 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2023 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using System.Buffers.Binary;</span>
<span class="term-fg32">+using System.Diagnostics.CodeAnalysis;</span>
<span class="term-fg32">+using System.Linq;</span>
<span class="term-fg32">+using System.Text;</span>
<span class="term-fg32">+using Nethermind.Consensus.Producers;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Serialization.Rlp;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismPayloadAttributes : PayloadAttributes</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private byte[][]? _encodedTransactions;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public byte[][]? Transactions</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        get { return _encodedTransactions; }</span>
<span class="term-fg32">+        set</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            _encodedTransactions = value;</span>
<span class="term-fg32">+            _transactions = null;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+    public bool NoTxPool { get; set; }</span>
<span class="term-fg32">+    public long GasLimit { get; set; }</span>
<span class="term-fg32">+    public override long? GetGasLimit() =&gt; GasLimit;</span>
<span class="term-fg32">+    private int TransactionsLength =&gt; Transactions?.Length ?? 0;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    private Transaction[]? _transactions;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47;&#47; &lt;summary&gt;</span>
<span class="term-fg32">+    &#47;&#47;&#47; Decodes and returns an array of &lt;see cref=&quot;Transaction&quot;&#47;&gt; from &lt;see cref=&quot;Transactions&quot;&#47;&gt;.</span>
<span class="term-fg32">+    &#47;&#47;&#47; &lt;&#47;summary&gt;</span>
<span class="term-fg32">+    &#47;&#47;&#47; &lt;returns&gt;An RLP-decoded array of &lt;see cref=&quot;Transaction&quot;&#47;&gt;.&lt;&#47;returns&gt;</span>
<span class="term-fg32">+    public Transaction[]? GetTransactions() =&gt; _transactions ??= Transactions?</span>
<span class="term-fg32">+        .Select((t, i) =&gt;</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            try</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                return Rlp.Decode&lt;Transaction&gt;(t, RlpBehaviors.SkipTypedWrapping);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+            catch (RlpException e)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                throw new RlpException($&quot;Transaction {i} is not valid&quot;, e);</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }).ToArray();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47;&#47; &lt;summary&gt;</span>
<span class="term-fg32">+    &#47;&#47;&#47; RLP-encodes and sets the transactions specified to &lt;see cref=&quot;Transactions&quot;&#47;&gt;.</span>
<span class="term-fg32">+    &#47;&#47;&#47; &lt;&#47;summary&gt;</span>
<span class="term-fg32">+    &#47;&#47;&#47; &lt;param name=&quot;transactions&quot;&gt;An array of transactions to encode.&lt;&#47;param&gt;</span>
<span class="term-fg32">+    public void SetTransactions(params Transaction[] transactions)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        Transactions = transactions</span>
<span class="term-fg32">+            .Select(t =&gt; Rlp.Encode(t, RlpBehaviors.SkipTypedWrapping).Bytes)</span>
<span class="term-fg32">+            .ToArray();</span>
<span class="term-fg32">+        _transactions = transactions;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override int ComputePayloadIdMembersSize() =&gt;</span>
<span class="term-fg32">+        &#47;&#47; Add NoTxPool + Txs + GasLimit</span>
<span class="term-fg32">+        base.ComputePayloadIdMembersSize() + sizeof(bool) + Keccak.Size * TransactionsLength + sizeof(long);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override int WritePayloadIdMembers(BlockHeader parentHeader, Span&lt;byte&gt; inputSpan)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        var offset = base.WritePayloadIdMembers(parentHeader, inputSpan);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        inputSpan[offset] = NoTxPool ? (byte)1 : (byte)0;</span>
<span class="term-fg32">+        offset += 1;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Transaction[]? transactions = GetTransactions();</span>
<span class="term-fg32">+        if (transactions is not null)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            foreach (Transaction tx in transactions)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                tx.Hash!.Bytes.CopyTo(inputSpan.Slice(offset, Keccak.Size));</span>
<span class="term-fg32">+                offset += Keccak.Size;</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        BinaryPrimitives.WriteInt64BigEndian(inputSpan.Slice(offset, sizeof(long)), GasLimit);</span>
<span class="term-fg32">+        offset += sizeof(long);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        return offset;</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public override PayloadAttributesValidationResult Validate(ISpecProvider specProvider, int apiVersion,</span>
<span class="term-fg32">+        [NotNullWhen(false)] out string? error)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (GasLimit == 0)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            error = &quot;Gas Limit should not be zero&quot;;</span>
<span class="term-fg32">+            return PayloadAttributesValidationResult.InvalidPayloadAttributes;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        try</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            GetTransactions();</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        catch (RlpException e)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            error = $&quot;Error decoding transactions: {e}&quot;;</span>
<span class="term-fg32">+            return PayloadAttributesValidationResult.InvalidPayloadAttributes;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        return base.Validate(specProvider, apiVersion, out error);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public override string ToString()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        StringBuilder sb = new StringBuilder($&quot;{nameof(PayloadAttributes)} {{&quot;)</span>
<span class="term-fg32">+            .Append($&quot;{nameof(Timestamp)}: {Timestamp}, &quot;)</span>
<span class="term-fg32">+            .Append($&quot;{nameof(PrevRandao)}: {PrevRandao}, &quot;)</span>
<span class="term-fg32">+            .Append($&quot;{nameof(SuggestedFeeRecipient)}: {SuggestedFeeRecipient}, &quot;)</span>
<span class="term-fg32">+            .Append($&quot;{nameof(GasLimit)}: {GasLimit}, &quot;)</span>
<span class="term-fg32">+            .Append($&quot;{nameof(NoTxPool)}: {NoTxPool}, &quot;)</span>
<span class="term-fg32">+            .Append($&quot;{nameof(Transactions)}: {Transactions?.Length ?? 0}&quot;);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (Withdrawals is not null)</span>
<span class="term-fg32">+            sb.Append($&quot;, {nameof(Withdrawals)} count: {Withdrawals.Length}&quot;);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        sb.Append(&#39;}&#39;);</span>
<span class="term-fg32">+        return sb.ToString();</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-c6acc50533caa98ed7d0db74" role="button"
                       aria-expanded="false" aria-controls="id-c6acc50533caa98ed7d0db74">
                        <code>src/Nethermind/Nethermind.Optimism/Rpc/OptimismReceiptForRpc.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Rpc/OptimismReceiptForRpc.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+66</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-c6acc50533caa98ed7d0db74"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismReceiptForRpc.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismReceiptForRpc.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..edaa037432549e08ca10a6c446a7a67e511da130</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismReceiptForRpc.cs</span>
<span class="term-fg36">@@ -0,0 +1,66 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.Evm;</span>
<span class="term-fg32">+using Nethermind.Int256;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Data;</span>
<span class="term-fg32">+using System.Text.Json.Serialization;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismReceiptForRpc : ReceiptForRpc</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public OptimismReceiptForRpc(Hash256 txHash, OptimismTxReceipt receipt, TxGasInfo gasInfo, L1TxGasInfo l1GasInfo, int logIndexStart = 0) : base(</span>
<span class="term-fg32">+        txHash, receipt, gasInfo, logIndexStart)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (receipt.TxType == Core.TxType.DepositTx)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            DepositNonce = receipt.DepositNonce;</span>
<span class="term-fg32">+            DepositReceiptVersion = receipt.DepositReceiptVersion;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+        else</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            L1Fee = l1GasInfo.L1Fee;</span>
<span class="term-fg32">+            L1GasUsed = l1GasInfo.L1GasUsed;</span>
<span class="term-fg32">+            L1GasPrice = l1GasInfo.L1GasPrice;</span>
<span class="term-fg32">+            L1FeeScalar = l1GasInfo.L1FeeScalar;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            L1BaseFeeScalar = l1GasInfo.L1BaseFeeScalar;</span>
<span class="term-fg32">+            L1BlobBaseFee = l1GasInfo.L1BlobBaseFee;</span>
<span class="term-fg32">+            L1BlobBaseFeeScalar = l1GasInfo.L1BlobBaseFeeScalar;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47; DepositTx related fields</span>
<span class="term-fg32">+    [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]</span>
<span class="term-fg32">+    public UInt256? DepositNonce { get; set; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]</span>
<span class="term-fg32">+    public UInt256? DepositReceiptVersion { get; set; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47; Regular tx fields</span>
<span class="term-fg32">+    [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]</span>
<span class="term-fg32">+    public UInt256? L1Fee { get; set; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]</span>
<span class="term-fg32">+    public UInt256? L1GasPrice { get; set; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]</span>
<span class="term-fg32">+    public UInt256? L1GasUsed { get; set; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47; Pre-ecotone field of a regular tx fields</span>
<span class="term-fg32">+    [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]</span>
<span class="term-fg32">+    public string? L1FeeScalar { get; set; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    &#47;&#47; Fjord fields</span>
<span class="term-fg32">+    [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]</span>
<span class="term-fg32">+    public UInt256? L1BaseFeeScalar { get; set; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]</span>
<span class="term-fg32">+    public UInt256? L1BlobBaseFee { get; set; }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]</span>
<span class="term-fg32">+    public UInt256? L1BlobBaseFeeScalar { get; set; }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b065fa579ddcd3a166fb1134" role="button"
                       aria-expanded="false" aria-controls="id-b065fa579ddcd3a166fb1134">
                        <code>src/Nethermind/Nethermind.Optimism/Rpc/OptimismTraceModuleFactory.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Rpc/OptimismTraceModuleFactory.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+61</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b065fa579ddcd3a166fb1134"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismTraceModuleFactory.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismTraceModuleFactory.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..8a1b5da4d2198c797c05375415bf3e47541220bc</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismTraceModuleFactory.cs</span>
<span class="term-fg36">@@ -0,0 +1,61 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2022 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Blockchain;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Receipts;</span>
<span class="term-fg32">+using Nethermind.Consensus;</span>
<span class="term-fg32">+using Nethermind.Consensus.Processing;</span>
<span class="term-fg32">+using Nethermind.Consensus.Rewards;</span>
<span class="term-fg32">+using Nethermind.Consensus.Validators;</span>
<span class="term-fg32">+using Nethermind.Consensus.Withdrawals;</span>
<span class="term-fg32">+using Nethermind.Core.Specs;</span>
<span class="term-fg32">+using Nethermind.Evm.TransactionProcessing;</span>
<span class="term-fg32">+using Nethermind.JsonRpc;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules.Trace;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.State;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismTraceModuleFactory(</span>
<span class="term-fg32">+    IWorldStateManager worldStateManager,</span>
<span class="term-fg32">+    IBlockTree blockTree,</span>
<span class="term-fg32">+    IJsonRpcConfig jsonRpcConfig,</span>
<span class="term-fg32">+    IBlockPreprocessorStep recoveryStep,</span>
<span class="term-fg32">+    IRewardCalculatorSource rewardCalculatorSource,</span>
<span class="term-fg32">+    IReceiptStorage receiptFinder,</span>
<span class="term-fg32">+    ISpecProvider specProvider,</span>
<span class="term-fg32">+    IPoSSwitcher poSSwitcher,</span>
<span class="term-fg32">+    ILogManager logManager,</span>
<span class="term-fg32">+    IL1CostHelper l1CostHelper,</span>
<span class="term-fg32">+    IOptimismSpecHelper opSpecHelper,</span>
<span class="term-fg32">+    Create2DeployerContractRewriter contractRewriter,</span>
<span class="term-fg32">+    IWithdrawalProcessor withdrawalProcessor) : TraceModuleFactory(</span>
<span class="term-fg32">+        worldStateManager,</span>
<span class="term-fg32">+        blockTree,</span>
<span class="term-fg32">+        jsonRpcConfig,</span>
<span class="term-fg32">+        recoveryStep,</span>
<span class="term-fg32">+        rewardCalculatorSource,</span>
<span class="term-fg32">+        receiptFinder,</span>
<span class="term-fg32">+        specProvider,</span>
<span class="term-fg32">+        poSSwitcher,</span>
<span class="term-fg32">+        logManager)</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    protected override ReadOnlyTxProcessingEnv CreateTxProcessingEnv() =&gt;</span>
<span class="term-fg32">+        new OptimismReadOnlyTxProcessingEnv(_worldStateManager, _blockTree, _specProvider, _logManager, l1CostHelper, opSpecHelper);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override ReadOnlyChainProcessingEnv CreateChainProcessingEnv(IBlockProcessor.IBlockTransactionsExecutor transactionsExecutor, IReadOnlyTxProcessingScope scope, IRewardCalculator rewardCalculator) =&gt; new OptimismReadOnlyChainProcessingEnv(</span>
<span class="term-fg32">+                scope,</span>
<span class="term-fg32">+                Always.Valid,</span>
<span class="term-fg32">+                _recoveryStep,</span>
<span class="term-fg32">+                rewardCalculator,</span>
<span class="term-fg32">+                _receiptStorage,</span>
<span class="term-fg32">+                _specProvider,</span>
<span class="term-fg32">+                _blockTree,</span>
<span class="term-fg32">+                _worldStateManager.GlobalStateReader,</span>
<span class="term-fg32">+                _logManager,</span>
<span class="term-fg32">+                opSpecHelper,</span>
<span class="term-fg32">+                contractRewriter,</span>
<span class="term-fg32">+                withdrawalProcessor,</span>
<span class="term-fg32">+                transactionsExecutor);</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-6a64fea0ab16d92aad3c3d7f" role="button"
                       aria-expanded="false" aria-controls="id-6a64fea0ab16d92aad3c3d7f">
                        <code>src/Nethermind/Nethermind.Optimism/Rpc/OptimismTransactionForRpc.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Rpc/OptimismTransactionForRpc.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+29</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-6a64fea0ab16d92aad3c3d7f"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismTransactionForRpc.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismTransactionForRpc.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..cb28429f3f6266c4335dd965e0747bbb0b52ef8c</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;OptimismTransactionForRpc.cs</span>
<span class="term-fg36">@@ -0,0 +1,29 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using Nethermind.Core.Crypto;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Facade.Eth;</span>
<span class="term-fg32">+using Nethermind.Int256;</span>
<span class="term-fg32">+using System.Text.Json.Serialization;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismTransactionForRpc : TransactionForRpc</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public OptimismTransactionForRpc(Hash256? blockHash, OptimismTxReceipt? receipt, Transaction transaction, UInt256? baseFee = null)</span>
<span class="term-fg32">+       : base(blockHash, receipt?.BlockNumber, receipt?.Index, transaction, baseFee)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        if (transaction.Type == TxType.DepositTx)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            SourceHash = transaction.SourceHash;</span>
<span class="term-fg32">+            Mint = transaction.Mint;</span>
<span class="term-fg32">+            IsSystemTx = transaction.IsOPSystemTransaction ? true : null;</span>
<span class="term-fg32">+            Nonce = receipt?.DepositNonce;</span>
<span class="term-fg32">+            DepositReceiptVersion = receipt?.DepositReceiptVersion;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    [JsonIgnore(Condition = JsonIgnoreCondition.WhenWritingNull)]</span>
<span class="term-fg32">+    public UInt256? DepositReceiptVersion { get; set; }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-cdff7e9b415302c6f3ddfb8d" role="button"
                       aria-expanded="false" aria-controls="id-cdff7e9b415302c6f3ddfb8d">
                        <code>src/Nethermind/Nethermind.Optimism/Rpc/RegisterOptimismRpcModules.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism/Rpc/RegisterOptimismRpcModules.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+122</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-cdff7e9b415302c6f3ddfb8d"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;RegisterOptimismRpcModules.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;RegisterOptimismRpcModules.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..04da5fca22e5cf5bf99d2396ef69badb1ab6597c</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism&#47;Rpc&#47;RegisterOptimismRpcModules.cs</span>
<span class="term-fg36">@@ -0,0 +1,122 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System;</span>
<span class="term-fg32">+using Nethermind.Api;</span>
<span class="term-fg32">+using Nethermind.Blockchain;</span>
<span class="term-fg32">+using Nethermind.Config;</span>
<span class="term-fg32">+using Nethermind.Consensus.Withdrawals;</span>
<span class="term-fg32">+using Nethermind.Init.Steps;</span>
<span class="term-fg32">+using Nethermind.JsonRpc;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Client;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules.Eth;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules.Eth.FeeHistory;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.TxPool;</span>
<span class="term-fg32">+using Nethermind.Wallet;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class RegisterOptimismRpcModules : RegisterRpcModules</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    private readonly OptimismNethermindApi _api;</span>
<span class="term-fg32">+    private readonly ILogger _logger;</span>
<span class="term-fg32">+    private readonly IOptimismConfig _config;</span>
<span class="term-fg32">+    private readonly IJsonRpcConfig _jsonRpcConfig;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public RegisterOptimismRpcModules(INethermindApi api) : base(api)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        _api = (OptimismNethermindApi)api;</span>
<span class="term-fg32">+        _config = _api.Config&lt;IOptimismConfig&gt;();</span>
<span class="term-fg32">+        _logger = _api.LogManager.GetClassLogger();</span>
<span class="term-fg32">+        _jsonRpcConfig = _api.Config&lt;IJsonRpcConfig&gt;();</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override void RegisterEthRpcModule(IRpcModuleProvider rpcModuleProvider)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.BlockTree);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.ReceiptStorage);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.StateReader);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.TxPool);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.TxSender);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.Wallet);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.EthSyncingInfo);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.GasPriceOracle);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.SpecHelper);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.SpecProvider);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.WorldState);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.EthereumEcdsa);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.Sealer);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        if (_config.SequencerUrl is null &amp;&amp; _logger.IsWarn)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            _logger.Warn($&quot;SequencerUrl is not set. Nethermind will behave as a Sequencer&quot;);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        BasicJsonRpcClient? sequencerJsonRpcClient = _config.SequencerUrl is null</span>
<span class="term-fg32">+            ? null</span>
<span class="term-fg32">+            : new(new Uri(_config.SequencerUrl), _api.EthereumJsonSerializer, _api.LogManager);</span>
<span class="term-fg32">+        ModuleFactoryBase&lt;IEthRpcModule&gt; ethModuleFactory = CreateEthModuleFactory();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        ITxSigner txSigner = new WalletTxSigner(_api.Wallet, _api.SpecProvider.ChainId);</span>
<span class="term-fg32">+        TxSealer sealer = new(txSigner, _api.Timestamper);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        var feeHistoryOracle = new FeeHistoryOracle(_api.BlockTree, _api.ReceiptStorage, _api.SpecProvider);</span>
<span class="term-fg32">+        _api.DisposeStack.Push(feeHistoryOracle);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        ModuleFactoryBase&lt;IOptimismEthRpcModule&gt; optimismEthModuleFactory = new OptimismEthModuleFactory(</span>
<span class="term-fg32">+            _jsonRpcConfig,</span>
<span class="term-fg32">+            _api,</span>
<span class="term-fg32">+            _api.BlockTree.AsReadOnly(),</span>
<span class="term-fg32">+            _api.ReceiptStorage,</span>
<span class="term-fg32">+            _api.StateReader,</span>
<span class="term-fg32">+            _api.TxPool,</span>
<span class="term-fg32">+            _api.TxSender,</span>
<span class="term-fg32">+            _api.Wallet,</span>
<span class="term-fg32">+            _api.LogManager,</span>
<span class="term-fg32">+            _api.SpecProvider,</span>
<span class="term-fg32">+            _api.GasPriceOracle,</span>
<span class="term-fg32">+            _api.EthSyncingInfo,</span>
<span class="term-fg32">+            feeHistoryOracle,</span>
<span class="term-fg32">+            _api.ConfigProvider.GetConfig&lt;IBlocksConfig&gt;().SecondsPerSlot,</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        sequencerJsonRpcClient,</span>
<span class="term-fg32">+            _api.WorldState,</span>
<span class="term-fg32">+            _api.EthereumEcdsa,</span>
<span class="term-fg32">+            sealer,</span>
<span class="term-fg32">+            _api.SpecHelper);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        rpcModuleProvider.RegisterBounded(optimismEthModuleFactory,</span>
<span class="term-fg32">+            _jsonRpcConfig.EthModuleConcurrentInstances ?? Environment.ProcessorCount, _jsonRpcConfig.Timeout);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    protected override void RegisterTraceRpcModule(IRpcModuleProvider rpcModuleProvider)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.WorldStateManager);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.BlockTree);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.ReceiptStorage);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.RewardCalculatorSource);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.SpecProvider);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.WorldState);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.L1CostHelper);</span>
<span class="term-fg32">+        StepDependencyException.ThrowIfNull(_api.SpecHelper);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        OptimismTraceModuleFactory traceModuleFactory = new(</span>
<span class="term-fg32">+            _api.WorldStateManager,</span>
<span class="term-fg32">+            _api.BlockTree,</span>
<span class="term-fg32">+            _jsonRpcConfig,</span>
<span class="term-fg32">+            _api.BlockPreprocessor,</span>
<span class="term-fg32">+            _api.RewardCalculatorSource,</span>
<span class="term-fg32">+            _api.ReceiptStorage,</span>
<span class="term-fg32">+            _api.SpecProvider,</span>
<span class="term-fg32">+            _api.PoSSwitcher,</span>
<span class="term-fg32">+            _api.LogManager,</span>
<span class="term-fg32">+            _api.L1CostHelper,</span>
<span class="term-fg32">+            _api.SpecHelper,</span>
<span class="term-fg32">+            new Create2DeployerContractRewriter(_api.SpecHelper, _api.SpecProvider, _api.BlockTree),</span>
<span class="term-fg32">+            new BlockProductionWithdrawalProcessor(new NullWithdrawalProcessor()));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        rpcModuleProvider.RegisterBoundedByCpuCount(traceModuleFactory, _jsonRpcConfig.Timeout);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-5a3b81f0843e46c250a694a6"role="button" aria-expanded="false" aria-controls="id-5a3b81f0843e46c250a694a6">
        
            <div class="col-12 col-md-12 col-lg-6 col-xl-6 text-start"><h2>Tests for the Optimism Plugin</h2></div>
        

        <div class="col-6 col-md-3 col-xl-2 ms-auto mt-2">
            <div class="row line-stat">
                
                
            </div>
        </div>
        <div class="col-6 col-md-3 col-xl-2 ms-auto mt-2 ">
            <div class="row line-stat">
                
                    <div class="text-end"><span class="text-success">+295</span></div>
                    <div class="text-start"><span class="text-danger">-0</span></div>
                
                
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-5a3b81f0843e46c250a694a6">
        <div><p>This section shows the addition of the Nethermind.Optimism.Test directory and its contents.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-1956249d6637f3f37e0778a4" role="button"
                       aria-expanded="false" aria-controls="id-1956249d6637f3f37e0778a4">
                        <code>src/Nethermind/Nethermind.Optimism.Test/GasCostTests.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism.Test/GasCostTests.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+37</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-1956249d6637f3f37e0778a4"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;GasCostTests.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;GasCostTests.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..2ba9f8160bada2c30639f58acebab989ed3f975f</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;GasCostTests.cs</span>
<span class="term-fg36">@@ -0,0 +1,37 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2022 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System.Collections;</span>
<span class="term-fg32">+using Nethermind.Int256;</span>
<span class="term-fg32">+using NUnit.Framework;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Test;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class GasCostTests</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    [TestCaseSource(nameof(FjordL1CostCalculationTestCases))]</span>
<span class="term-fg32">+    public UInt256 Fjord_l1cost_should_match(UInt256 fastLzSize, UInt256 l1BaseFee, UInt256 blobBaseFee, UInt256 l1BaseFeeScalar, UInt256 l1BlobBaseFeeScalar) =&gt;</span>
<span class="term-fg32">+        OPL1CostHelper.ComputeL1CostFjord(fastLzSize, l1BaseFee, blobBaseFee, l1BaseFeeScalar, l1BlobBaseFeeScalar, out _);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public static IEnumerable FjordL1CostCalculationTestCases</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        get</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            static TestCaseData MakeTestCase(string testCase, ulong result, ulong fastLzSize, ulong l1BaseFee, ulong blobBaseFee, ulong l1BaseFeeScalar, ulong l1BlobBaseFeeScalar)</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                return new TestCaseData(new UInt256(fastLzSize), new UInt256(l1BaseFee), new UInt256(blobBaseFee), new UInt256(l1BaseFeeScalar), new UInt256(l1BlobBaseFeeScalar))</span>
<span class="term-fg32">+                {</span>
<span class="term-fg32">+                    ExpectedResult = new UInt256(result),</span>
<span class="term-fg32">+                    TestName = testCase</span>
<span class="term-fg32">+                };</span>
<span class="term-fg32">+            }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            yield return MakeTestCase(&quot;Low compressed size&quot;, 3203000, 50, 1000000000, 10000000, 2, 3);</span>
<span class="term-fg32">+            yield return MakeTestCase(&quot;Below minimal #1&quot;, 3203000, 150, 1000000000, 10000000, 2, 3);</span>
<span class="term-fg32">+            yield return MakeTestCase(&quot;Below minimal #2&quot;, 3203000, 170, 1000000000, 10000000, 2, 3);</span>
<span class="term-fg32">+            yield return MakeTestCase(&quot;Above minimal #1&quot;, 3217602, 171, 1000000000, 10000000, 2, 3);</span>
<span class="term-fg32">+            yield return MakeTestCase(&quot;Above minimal #2&quot;, 3994602, 200, 1000000000, 10000000, 2, 3);</span>
<span class="term-fg32">+            yield return MakeTestCase(&quot;Regular block #1&quot;, 2883950646753, 1044, 28549556977, 1, 7600, 862000);</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-12410d163692d396f5e036ce" role="button"
                       aria-expanded="false" aria-controls="id-12410d163692d396f5e036ce">
                        <code>src/Nethermind/Nethermind.Optimism.Test/Nethermind.Optimism.Test.csproj</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism.Test/Nethermind.Optimism.Test.csproj" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+28</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-12410d163692d396f5e036ce"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;Nethermind.Optimism.Test.csproj NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;Nethermind.Optimism.Test.csproj</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..bf83b032cc63c8002fa86e4f28e95426cbc009d2</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;Nethermind.Optimism.Test.csproj</span>
<span class="term-fg36">@@ -0,0 +1,28 @@</span>
<span class="term-fg32">+&lt;Project Sdk=&quot;Microsoft.NET.Sdk&quot;&gt;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+  &lt;PropertyGroup&gt;</span>
<span class="term-fg32">+    &lt;Nullable&gt;enable&lt;&#47;Nullable&gt;</span>
<span class="term-fg32">+    &lt;NoWarn&gt;$(NoWarn);NUnit1032&lt;&#47;NoWarn&gt;</span>
<span class="term-fg32">+  &lt;&#47;PropertyGroup&gt;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+  &lt;ItemGroup&gt;</span>
<span class="term-fg32">+    &lt;PackageReference Include=&quot;coverlet.collector&quot;&gt;</span>
<span class="term-fg32">+      &lt;IncludeAssets&gt;runtime; build; native; contentfiles; analyzers; buildtransitive&lt;&#47;IncludeAssets&gt;</span>
<span class="term-fg32">+      &lt;PrivateAssets&gt;all&lt;&#47;PrivateAssets&gt;</span>
<span class="term-fg32">+    &lt;&#47;PackageReference&gt;</span>
<span class="term-fg32">+    &lt;PackageReference Include=&quot;NSubstitute&quot; &#47;&gt;</span>
<span class="term-fg32">+    &lt;PackageReference Include=&quot;NUnit&quot; &#47;&gt;</span>
<span class="term-fg32">+    &lt;PackageReference Include=&quot;NUnit.Analyzers&quot;&gt;</span>
<span class="term-fg32">+      &lt;PrivateAssets&gt;all&lt;&#47;PrivateAssets&gt;</span>
<span class="term-fg32">+      &lt;IncludeAssets&gt;runtime; build; native; contentfiles; analyzers; buildtransitive&lt;&#47;IncludeAssets&gt;</span>
<span class="term-fg32">+    &lt;&#47;PackageReference&gt;</span>
<span class="term-fg32">+    &lt;PackageReference Include=&quot;NUnit3TestAdapter&quot; &#47;&gt;</span>
<span class="term-fg32">+    &lt;PackageReference Include=&quot;Microsoft.NET.Test.Sdk&quot; &#47;&gt;</span>
<span class="term-fg32">+    &lt;PackageReference Include=&quot;RichardSzalay.MockHttp&quot; &#47;&gt;</span>
<span class="term-fg32">+  &lt;&#47;ItemGroup&gt;</span>
<span class="term-fg32">+  &lt;ItemGroup&gt;</span>
<span class="term-fg32">+    &lt;ProjectReference Include=&quot;..\Nethermind.JsonRpc.Test\Nethermind.JsonRpc.Test.csproj&quot; &#47;&gt;</span>
<span class="term-fg32">+    &lt;ProjectReference Include=&quot;..\Nethermind.Optimism\Nethermind.Optimism.csproj&quot; &#47;&gt;</span>
<span class="term-fg32">+  &lt;&#47;ItemGroup&gt;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+&lt;&#47;Project&gt;</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-083e0c9202a4c238cb43499d" role="button"
                       aria-expanded="false" aria-controls="id-083e0c9202a4c238cb43499d">
                        <code>src/Nethermind/Nethermind.Optimism.Test/ReceiptDecoderTests.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism.Test/ReceiptDecoderTests.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+140</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-083e0c9202a4c238cb43499d"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;ReceiptDecoderTests.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;ReceiptDecoderTests.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..37e1a5e4df79337b43bf265c315a0db0cf5a4ecb</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;ReceiptDecoderTests.cs</span>
<span class="term-fg36">@@ -0,0 +1,140 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2022 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System.Collections;</span>
<span class="term-fg32">+using Nethermind.Core.Extensions;</span>
<span class="term-fg32">+using Nethermind.Serialization.Rlp;</span>
<span class="term-fg32">+using NUnit.Framework;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Test;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class ReceiptDecoderTests</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    [TestCaseSource(nameof(DepositTxReceiptsSerializationTestCases))]</span>
<span class="term-fg32">+    public void Test_tx_network_form_receipts_properly_encoded_for_trie(byte[] rlp, bool includesNonce, bool includesVersion, bool shouldIncludeNonceAndVersionForTxTrie)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        static OptimismTxReceipt TestNetworkEncodingRoundTrip(byte[] rlp, bool includesNonce, bool includesVersion)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            OptimismReceiptMessageDecoder decoder = new();</span>
<span class="term-fg32">+            OptimismTxReceipt decodedReceipt = decoder.Decode(new RlpStream(rlp), RlpBehaviors.SkipTypedWrapping);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            RlpStream encodedRlp = new(decoder.GetLength(decodedReceipt, RlpBehaviors.SkipTypedWrapping));</span>
<span class="term-fg32">+            decoder.Encode(encodedRlp, decodedReceipt, RlpBehaviors.SkipTypedWrapping);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            Assert.Multiple(() =&gt;</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                Assert.That(decodedReceipt.DepositNonce, includesNonce ? Is.Not.Null : Is.Null);</span>
<span class="term-fg32">+                Assert.That(decodedReceipt.DepositReceiptVersion, includesVersion ? Is.Not.Null : Is.Null);</span>
<span class="term-fg32">+                Assert.That(rlp, Is.EqualTo(encodedRlp.Data.ToArray()));</span>
<span class="term-fg32">+            });</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            return decodedReceipt;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        static OptimismTxReceipt TestStorageEncodingRoundTrip(OptimismTxReceipt decodedReceipt, bool includesNonce, bool includesVersion)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            OptimismCompactReceiptStorageDecoder decoder = new();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            RlpStream encodedRlp = new(decoder.GetLength(decodedReceipt, RlpBehaviors.SkipTypedWrapping));</span>
<span class="term-fg32">+            decoder.Encode(encodedRlp, decodedReceipt, RlpBehaviors.SkipTypedWrapping);</span>
<span class="term-fg32">+            encodedRlp.Position = 0;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            OptimismTxReceipt decodedStorageReceipt = decoder.Decode(encodedRlp, RlpBehaviors.SkipTypedWrapping);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            Assert.Multiple(() =&gt;</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                Assert.That(decodedStorageReceipt.DepositNonce, includesNonce ? Is.Not.Null : Is.Null);</span>
<span class="term-fg32">+                Assert.That(decodedStorageReceipt.DepositReceiptVersion, includesVersion ? Is.Not.Null : Is.Null);</span>
<span class="term-fg32">+            });</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            Rlp.ValueDecoderContext valueDecoderCtx = new(encodedRlp.Data);</span>
<span class="term-fg32">+            decodedStorageReceipt = decoder.Decode(ref valueDecoderCtx, RlpBehaviors.SkipTypedWrapping);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            Assert.Multiple(() =&gt;</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                Assert.That(decodedStorageReceipt.DepositNonce, includesNonce ? Is.Not.Null : Is.Null);</span>
<span class="term-fg32">+                Assert.That(decodedStorageReceipt.DepositReceiptVersion, includesVersion ? Is.Not.Null : Is.Null);</span>
<span class="term-fg32">+            });</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            return decodedReceipt;</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        static void TestTrieEncoding(OptimismTxReceipt decodedReceipt, bool shouldIncludeNonceAndVersionForTxTrie)</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            OptimismReceiptTrieDecoder trieDecoder = new();</span>
<span class="term-fg32">+            RlpStream encodedTrieRlp = new(trieDecoder.GetLength(decodedReceipt, RlpBehaviors.SkipTypedWrapping));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            trieDecoder.Encode(encodedTrieRlp, decodedReceipt, RlpBehaviors.SkipTypedWrapping);</span>
<span class="term-fg32">+            encodedTrieRlp.Position = 0;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            OptimismTxReceipt decodedTrieReceipt = trieDecoder.Decode(encodedTrieRlp, RlpBehaviors.SkipTypedWrapping);</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            Assert.Multiple(() =&gt;</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                Assert.That(decodedTrieReceipt.DepositNonce, shouldIncludeNonceAndVersionForTxTrie ? Is.Not.Null : Is.Null);</span>
<span class="term-fg32">+                Assert.That(decodedTrieReceipt.DepositReceiptVersion, shouldIncludeNonceAndVersionForTxTrie ? Is.Not.Null : Is.Null);</span>
<span class="term-fg32">+            });</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        OptimismTxReceipt decodedReceipt = TestNetworkEncodingRoundTrip(rlp, includesNonce, includesVersion);</span>
<span class="term-fg32">+        TestStorageEncodingRoundTrip(decodedReceipt, includesNonce, includesVersion);</span>
<span class="term-fg32">+        TestTrieEncoding(decodedReceipt, shouldIncludeNonceAndVersionForTxTrie);</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+    public static IEnumerable DepositTxReceiptsSerializationTestCases</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        get</span>
<span class="term-fg32">+        {</span>
<span class="term-fg32">+            yield return new TestCaseData(</span>
<span class="term-fg32">+                Bytes.FromHexString(&quot;7ef901090182f9f5b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c080&quot;),</span>
<span class="term-fg32">+                true,</span>
<span class="term-fg32">+                false,</span>
<span class="term-fg32">+                false</span>
<span class="term-fg32">+                )</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                TestName = &quot;1st OP Sepolia block receipt&quot;</span>
<span class="term-fg32">+            };</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            yield return new TestCaseData(</span>
<span class="term-fg32">+                Bytes.FromHexString(&quot;0x7ef9010c0182b729b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0830154f4&quot;),</span>
<span class="term-fg32">+                true,</span>
<span class="term-fg32">+                false,</span>
<span class="term-fg32">+                false</span>
<span class="term-fg32">+                )</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                TestName = &quot;Regolith receipt&quot;</span>
<span class="term-fg32">+            };</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            yield return new TestCaseData(</span>
<span class="term-fg32">+               Bytes.FromHexString(&quot;0x7ef903660183023676b9010000000000000000000000000000000000000000000000000000000000001000000000000000000080000000000000000001000000000000000000000000000204000200000004000000000000000000000000000000000000000000000000000100000000020000400000000000020800000000000000000000000008000000000000000000004000400000020000000001800000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000100000000000002100000000000000000000020001000100000040000000000000000000000000000000000000000000008000000f9025af9011d944200000000000000000000000000000000000010f884a0b0444523268717a02698be47d0803aa7468c00acbed2f8bd93a0459cde61dd89a00000000000000000000000000000000000000000000000000000000000000000a0000000000000000000000000deaddeaddeaddeaddeaddeaddeaddeaddead0000a000000000000000000000000072fb15f502af58765015972a85f2c58551ef3fa1b88000000000000000000000000072fb15f502af58765015972a85f2c58551ef3fa1000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000000000600000000000000000000000000000000000000000000000000000000000000000f8dc944200000000000000000000000000000000000010f863a031b2166ff604fc5672ea5df08a78081d2bc6d746cadce880747f3643d819e83da000000000000000000000000072fb15f502af58765015972a85f2c58551ef3fa1a000000000000000000000000072fb15f502af58765015972a85f2c58551ef3fa1b860000000000000000000000000000000000000000000000000016345785d8a000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000f85a944200000000000000000000000000000000000007f842a04641df4a962071e12719d8c8c8e5ac7fc4d97b927346a3d7a335b1f7517e133ca0c056e47e441542720e5a953ab9fcf1cc3de86fb1d3078293fb9708e6e77816938080&quot;),</span>
<span class="term-fg32">+               true,</span>
<span class="term-fg32">+               false,</span>
<span class="term-fg32">+               false</span>
<span class="term-fg32">+               )</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                TestName = &quot;Regolith receipt 2&quot;</span>
<span class="term-fg32">+            };</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            yield return new TestCaseData(</span>
<span class="term-fg32">+                Bytes.FromHexString(&quot;0xf901090183011711b9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c0&quot;),</span>
<span class="term-fg32">+                false,</span>
<span class="term-fg32">+                false,</span>
<span class="term-fg32">+                false</span>
<span class="term-fg32">+                )</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                TestName = &quot;Regolith receipt of a regular tx&quot;</span>
<span class="term-fg32">+            };</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            yield return new TestCaseData(</span>
<span class="term-fg32">+                Bytes.FromHexString(&quot;7ef9010d0182ab7bb9010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000c083b2557501&quot;),</span>
<span class="term-fg32">+                true,</span>
<span class="term-fg32">+                true,</span>
<span class="term-fg32">+                true</span>
<span class="term-fg32">+                )</span>
<span class="term-fg32">+            {</span>
<span class="term-fg32">+                TestName = &quot;Canyon receipt&quot;</span>
<span class="term-fg32">+            };</span>
<span class="term-fg32">+        }</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-daf4e05a8391141c41d9dde4" role="button"
                       aria-expanded="false" aria-controls="id-daf4e05a8391141c41d9dde4">
                        <code>src/Nethermind/Nethermind.Optimism.Test/Rpc/OptimismEthRpcModuleTest.cs</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <span class="text-muted">(new)</span>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.Optimism.Test/Rpc/OptimismEthRpcModuleTest.cs" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+90</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-daf4e05a8391141c41d9dde4"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;Rpc&#47;OptimismEthRpcModuleTest.cs NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;Rpc&#47;OptimismEthRpcModuleTest.cs</span>
<span class="term-fg1">new file mode 100644</span>
<span class="term-fg1">index 0000000000000000000000000000000000000000..ac1a02e3452527a4b0668e22187f217a296a8362</span>
<span class="term-fg1">--- &#47;dev&#47;null</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.Optimism.Test&#47;Rpc&#47;OptimismEthRpcModuleTest.cs</span>
<span class="term-fg36">@@ -0,0 +1,90 @@</span>
<span class="term-fg32">+&#47;&#47; SPDX-FileCopyrightText: 2024 Demerzel Solutions Limited</span>
<span class="term-fg32">+&#47;&#47; SPDX-License-Identifier: LGPL-3.0-only</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+using System.Threading.Tasks;</span>
<span class="term-fg32">+using Nethermind.Blockchain.Synchronization;</span>
<span class="term-fg32">+using Nethermind.Config;</span>
<span class="term-fg32">+using Nethermind.Core;</span>
<span class="term-fg32">+using Nethermind.Core.Extensions;</span>
<span class="term-fg32">+using Nethermind.Core.Test.Builders;</span>
<span class="term-fg32">+using Nethermind.Crypto;</span>
<span class="term-fg32">+using Nethermind.Facade;</span>
<span class="term-fg32">+using Nethermind.Facade.Eth;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Client;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Modules.Eth.FeeHistory;</span>
<span class="term-fg32">+using Nethermind.JsonRpc.Test.Modules;</span>
<span class="term-fg32">+using Nethermind.Logging;</span>
<span class="term-fg32">+using Nethermind.Optimism.Rpc;</span>
<span class="term-fg32">+using Nethermind.Serialization.Rlp;</span>
<span class="term-fg32">+using Nethermind.Synchronization.ParallelSync;</span>
<span class="term-fg32">+using Nethermind.TxPool;</span>
<span class="term-fg32">+using NSubstitute;</span>
<span class="term-fg32">+using NUnit.Framework;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+namespace Nethermind.Optimism.Test.Rpc;</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+public class OptimismEthRpcModuleTest</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    [Test]</span>
<span class="term-fg32">+    public async Task Sequencer_send_transaction_with_signature_will_not_try_to_sign()</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        IBlockchainBridge bridge = Substitute.For&lt;IBlockchainBridge&gt;();</span>
<span class="term-fg32">+        ITxSender txSender = Substitute.For&lt;ITxSender&gt;();</span>
<span class="term-fg32">+        txSender.SendTransaction(tx: Arg.Any&lt;Transaction&gt;(), txHandlingOptions: TxHandlingOptions.PersistentBroadcast)</span>
<span class="term-fg32">+            .Returns(returnThis: (TestItem.KeccakA, AcceptTxResult.Accepted));</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        EthereumEcdsa ethereumEcdsa = new EthereumEcdsa(chainId: TestBlockchainIds.ChainId);</span>
<span class="term-fg32">+        TestRpcBlockchain rpcBlockchain = await TestRpcBlockchain</span>
<span class="term-fg32">+            .ForTest(sealEngineType: SealEngineType.Optimism)</span>
<span class="term-fg32">+            .WithBlockchainBridge(bridge)</span>
<span class="term-fg32">+            .WithTxSender(txSender)</span>
<span class="term-fg32">+            .WithOptimismEthRpcModule(</span>
<span class="term-fg32">+                sequencerRpcClient: null &#47;* explicitly using null to behave as Sequencer *&#47;,</span>
<span class="term-fg32">+                accountStateProvider: Substitute.For&lt;IAccountStateProvider&gt;(),</span>
<span class="term-fg32">+                ecdsa: new OptimismEthereumEcdsa(ethereumEcdsa),</span>
<span class="term-fg32">+                sealer: Substitute.For&lt;ITxSealer&gt;(),</span>
<span class="term-fg32">+                opSpecHelper: Substitute.For&lt;IOptimismSpecHelper&gt;())</span>
<span class="term-fg32">+            .Build();</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        Transaction tx = Build.A.Transaction</span>
<span class="term-fg32">+            .Signed(ecdsa: ethereumEcdsa, privateKey: TestItem.PrivateKeyA)</span>
<span class="term-fg32">+            .TestObject;</span>
<span class="term-fg32">+        string serialized = await rpcBlockchain.TestEthRpc(&quot;eth_sendRawTransaction&quot;, Rlp.Encode(item: tx, behaviors: RlpBehaviors.None).Bytes.ToHexString());</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+        await txSender.Received().SendTransaction(tx: Arg.Any&lt;Transaction&gt;(), txHandlingOptions: TxHandlingOptions.PersistentBroadcast);</span>
<span class="term-fg32">+        Assert.That(actual: serialized, expression: Is.EqualTo(expected: $$&quot;&quot;&quot;{&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:&quot;{{TestItem.KeccakA.Bytes.ToHexString(withZeroX: true)}}&quot;,&quot;id&quot;:67}&quot;&quot;&quot;));</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+internal static class TestRpcBlockchainExt</span>
<span class="term-fg32">+{</span>
<span class="term-fg32">+    public static TestRpcBlockchain.Builder&lt;TestRpcBlockchain&gt; WithOptimismEthRpcModule(</span>
<span class="term-fg32">+        this TestRpcBlockchain.Builder&lt;TestRpcBlockchain&gt; @this,</span>
<span class="term-fg32">+        IJsonRpcClient? sequencerRpcClient,</span>
<span class="term-fg32">+        IAccountStateProvider accountStateProvider,</span>
<span class="term-fg32">+        IEthereumEcdsa ecdsa,</span>
<span class="term-fg32">+        ITxSealer sealer,</span>
<span class="term-fg32">+        IOptimismSpecHelper opSpecHelper)</span>
<span class="term-fg32">+    {</span>
<span class="term-fg32">+        return @this.WithEthRpcModule(blockchain =&gt; new OptimismEthRpcModule(</span>
<span class="term-fg32">+            blockchain.RpcConfig,</span>
<span class="term-fg32">+            blockchain.Bridge,</span>
<span class="term-fg32">+            blockchain.BlockFinder,</span>
<span class="term-fg32">+            blockchain.ReceiptFinder,</span>
<span class="term-fg32">+            blockchain.StateReader,</span>
<span class="term-fg32">+            blockchain.TxPool,</span>
<span class="term-fg32">+            blockchain.TxSender,</span>
<span class="term-fg32">+            blockchain.TestWallet,</span>
<span class="term-fg32">+            LimboLogs.Instance,</span>
<span class="term-fg32">+            blockchain.SpecProvider,</span>
<span class="term-fg32">+            blockchain.GasPriceOracle,</span>
<span class="term-fg32">+            new EthSyncingInfo(blockchain.BlockTree, blockchain.ReceiptStorage, new SyncConfig(),</span>
<span class="term-fg32">+                new StaticSelector(SyncMode.All), Substitute.For&lt;ISyncProgressResolver&gt;(), blockchain.LogManager),</span>
<span class="term-fg32">+            blockchain.FeeHistoryOracle ??</span>
<span class="term-fg32">+            new FeeHistoryOracle(blockchain.BlockTree, blockchain.ReceiptStorage, blockchain.SpecProvider),</span>
<span class="term-fg32">+            new BlocksConfig().SecondsPerSlot,</span>
<span class="term-fg32">+</span>
<span class="term-fg32">+            sequencerRpcClient, accountStateProvider, ecdsa, sealer, opSpecHelper</span>
<span class="term-fg32">+        ));</span>
<span class="term-fg32">+    }</span>
<span class="term-fg32">+}</span></div>
    </div>

            
            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
                <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-54ee6d7c1dbee77ee56f0c16"role="button" aria-expanded="false" aria-controls="id-54ee6d7c1dbee77ee56f0c16">
        
            <div class="col-12 col-md-12 col-lg-6 col-xl-6 text-start"><h2>Changes to Nethermind.sln</h2></div>
        

        <div class="col-6 col-md-3 col-xl-2 ms-auto mt-2">
            <div class="row line-stat">
                
                
            </div>
        </div>
        <div class="col-6 col-md-3 col-xl-2 ms-auto mt-2 ">
            <div class="row line-stat">
                
                    <div class="text-end"><span class="text-success">+2</span></div>
                    <div class="text-start"><span class="text-danger">-0</span></div>
                
                
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-54ee6d7c1dbee77ee56f0c16">
        <div><p>This section shows the changes made to the Nethermind solution file to add references to Optimism projects.</p>
</div>
        <div>
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-decoration-none" data-bs-toggle="collapse" href="#id-b5a8e2f21fe67406b477e5b8" role="button"
                       aria-expanded="false" aria-controls="id-b5a8e2f21fe67406b477e5b8">
                        <code>src/Nethermind/Nethermind.sln</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/d5af22c4e3dd7fe685aba33121915d4df27e7c7f/src/Nethermind/Nethermind.sln" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/ae3d5e0d1259ef3ab3049cabe3941b002d7193c7/src/Nethermind/Nethermind.sln" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-success">+2</span></div>
                            <div class="text-start"><span class="text-danger">-0</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-b5a8e2f21fe67406b477e5b8"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.sln NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.sln</span>
<span class="term-fg1">index 3a52e920b6c8f352dcbe39d3bec37698679764e7..a0ac7f0e84ca8fb2d0fe49d0e8950c0047ab770f 100644</span>
<span class="term-fg1">--- NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.sln</span>
<span class="term-fg1">+++ NethermindEth&#47;nethermind&#47;src&#47;Nethermind&#47;Nethermind.sln</span>
<span class="term-fg36">@@ -201,6 +201,7 @@</span> Project(&quot;{9A19103F-16F7-4668-BE54-9A1E7A4F7556}&quot;) = &quot;Nethermind.Serialization.Ssz&quot;, &quot;Nethermind.Serialization.Ssz\Nethermind.Serialization.Ssz.csproj&quot;, &quot;{FD9E69EA-75DB-495B-A8DD-139D7A9D8C6D}&quot;
 EndProject
 Project(&quot;{9A19103F-16F7-4668-BE54-9A1E7A4F7556}&quot;) = &quot;Nethermind.Network.Contract&quot;, &quot;Nethermind.Network.Contract\Nethermind.Network.Contract.csproj&quot;, &quot;{AD151E35-4BBC-4A83-8F57-CC8665F6E007}&quot;
 EndProject
<span class="term-fg32">+Project(&quot;{9A19103F-16F7-4668-BE54-9A1E7A4F7556}&quot;) = &quot;Nethermind.Optimism&quot;, &quot;Nethermind.Optimism\Nethermind.Optimism.csproj&quot;, &quot;{32E5D15A-F6A6-40EA-9F31-05FE9251F958}&quot;</span>
 EndProject
 Project(&quot;{9A19103F-16F7-4668-BE54-9A1E7A4F7556}&quot;) = &quot;Nethermind.Init.Snapshot&quot;, &quot;Nethermind.Init.Snapshot\Nethermind.Init.Snapshot.csproj&quot;, &quot;{AD09FBCB-5496-499B-9129-B6D139A65B6F}&quot;
 EndProject
<span class="term-fg36">@@ -211,6 +212,7 @@</span> 		Directory.Packages.props = Directory.Packages.props
 		nuget.config = nuget.config
 	EndProjectSection
 EndProject
<span class="term-fg32">+Project(&quot;{9A19103F-16F7-4668-BE54-9A1E7A4F7556}&quot;) = &quot;Nethermind.Optimism.Test&quot;, &quot;Nethermind.Optimism.Test\Nethermind.Optimism.Test.csproj&quot;, &quot;{2438958D-46EA-4A7E-B89F-29E069DA0CCA}&quot;</span>
 EndProject
 Project(&quot;{2150E333-8FDC-42A3-9474-1A3956D46DE8}&quot;) = &quot;Signer&quot;, &quot;Signer&quot;, &quot;{89311B58-AF36-4956-883D-54531BC1D5A3}&quot;
 EndProject</div>
    </div>

            
            
        </div>
        <div>
            
        </div>
    </div>
</div>

            
        </div>
    </div>
</div>

                
                    <div class="ps-1 py-2 my-1"><div class="row border-bottom border-1"data-bs-toggle="collapse" data-bs-target="#id-a8970e24a34135146373a797"role="button" aria-expanded="false" aria-controls="id-a8970e24a34135146373a797">
        
            <div class="col-12 col-md-12 col-lg-6 col-xl-6 text-start"><h4>Ignored changes</h4></div>
        

        <div class="col-6 col-md-3 col-xl-2 ms-auto mt-2">
            <div class="row line-stat">
                
                
            </div>
        </div>
        <div class="col-6 col-md-3 col-xl-2 ms-auto mt-2 ">
            <div class="row line-stat">
                
                
                    <div class="text-end"><span class="text-add-ignored">+0</span></div>
                    <div class="text-start"><span class="text-delete-ignored">-38</span></div>
                
            </div>
        </div>
    </div>

    <div class="row forkdef-content collapse  border-1 ps-3 my-3" id="id-a8970e24a34135146373a797">
        <div></div>
        <div>
            
            
                <div class="border-bottom"><div class="row">
            <div class="col-12 col-md-4 text-start pe-2">
                
                    <a class="text-muted" data-bs-toggle="collapse" href="#id-73ba4e499933bd80ee075611" role="button"
                       aria-expanded="false" aria-controls="id-73ba4e499933bd80ee075611">
                        <code>.github/workflows/update-no-op-plugin.yml</code>
                    </a>
                
            </div>

            <div class="col-12 col-sm-8 col-md-4 text-start px-2">
                <div class="row">
                    <div class="col-6">
                        
                            <a href="https://github.com/NethermindEth/nethermind/blob/d5af22c4e3dd7fe685aba33121915d4df27e7c7f/.github/workflows/update-no-op-plugin.yml" target="_blank">NethermindEth/nethermind <i class="bi bi-github"></i></a>
                        
                    </div>

                    <div class="col-6">
                        
                            <span class="text-muted">(deleted)</span>
                        
                    </div>
                </div>
            </div>

            <div class="col-12 col-sm-4 ms-auto ps-2">
                
                    <div class="row line-stat">
                        
                            <div class="text-end"><span class="text-add-ignored">+0</span></div>
                            <div class="text-start"><span class="text-delete-ignored">-38</span></div>
                        
                    </div>
                
            </div>
        </div>
        <div class="collapse patch-content term-container" id="id-73ba4e499933bd80ee075611"><span class="term-fg1">diff --git NethermindEth&#47;nethermind&#47;.github&#47;workflows&#47;update-no-op-plugin.yml NethermindEth&#47;nethermind&#47;.github&#47;workflows&#47;update-no-op-plugin.yml</span>
<span class="term-fg1">deleted file mode 100644</span>
<span class="term-fg1">index eb2d61b091210cc0388a128a38ccbcace131afd5..0000000000000000000000000000000000000000</span>
<span class="term-fg1">--- NethermindEth&#47;nethermind&#47;.github&#47;workflows&#47;update-no-op-plugin.yml</span>
<span class="term-fg1">+++ &#47;dev&#47;null</span>
<span class="term-fg36">@@ -1,38 +0,0 @@</span>
<span class="term-fg31">-name: Remove OP Plugin</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-on:</span>
<span class="term-fg31">-  push:</span>
<span class="term-fg31">-    branches:</span>
<span class="term-fg31">-      - master</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-jobs:</span>
<span class="term-fg31">-  remove-op-plugin:</span>
<span class="term-fg31">-    runs-on: ubuntu-latest</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-    steps:</span>
<span class="term-fg31">-      - name: Checkout repository</span>
<span class="term-fg31">-        uses: actions&#47;checkout@v3</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-      - name: Create or checkout no-op-plugin branch</span>
<span class="term-fg31">-        run: git checkout -b no-op-plugin || git checkout no-op-plugin</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-      - name: Remove Nethermind.Optimism directory</span>
<span class="term-fg31">-        run: rm -rf src&#47;Nethermind&#47;Nethermind.Optimism</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-      - name: Remove Nethermind.Optimism.Test directory</span>
<span class="term-fg31">-        run: rm -rf src&#47;Nethermind&#47;Nethermind.Optimism.Test</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-      - name: Remove references from Nethermind.sln</span>
<span class="term-fg31">-        run: |</span>
<span class="term-fg31">-          sed -i &#39;&#47;Nethermind.Optimism&#47;d&#39; src&#47;Nethermind&#47;Nethermind.sln</span>
<span class="term-fg31">-          sed -i &#39;&#47;Nethermind.Optimism.Test&#47;d&#39; src&#47;Nethermind&#47;Nethermind.sln</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-      - name: Commit changes</span>
<span class="term-fg31">-        run: |</span>
<span class="term-fg31">-          git config --global user.name &#39;github-actions[bot]&#39;</span>
<span class="term-fg31">-          git config --global user.email &#39;github-actions[bot]@users.noreply.github.com&#39;</span>
<span class="term-fg31">-          git add .</span>
<span class="term-fg31">-          git commit -m &#39;Remove Nethermind.Optimism and Nethermind.Optimism.Test directories and references from solution file&#39; || echo &quot;No changes to commit&quot;</span>
<span class="term-fg31">-</span>
<span class="term-fg31">-      - name: Push changes</span>
<span class="term-fg31">-        run: git push origin no-op-plugin || echo &quot;Nothing to push&quot;</span></div>
    </div>

            
        </div>
        <div>
            
        </div>
    </div>
</div>

                
            </div>
        </main>
    </div>

    <footer class="col-xl-10 col-xxl-8 mx-auto px-3 pt-5 my-5 text-muted border-top">
        <p><a href="https://github.com/NethermindEth/nethermind">Nethermind</a> Optimism Plugin Integration overview &amp;middot; created with <a href="https://github.com/protolambda/forkdiff">Forkdiff</a></p>

    </footer>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD" crossorigin="anonymous"></script>
    <script type="text/javascript">
        const storedTheme = localStorage.getItem('theme')

        // Get the preferred theme from the user's OS
        const getPreferredTheme = () => {
            if (storedTheme) {
                return storedTheme
            }

            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
        }

        // Set the bootstrap theme
        const setTheme = function (theme) {
            document.documentElement.setAttribute('data-bs-theme', theme)
            if (theme === 'dark') {
                document.getElementById('dark-mode-toggle').setAttribute('checked', true)
                document.getElementById('dark-mode-icon').classList.replace('bi-brightness-high-fill', 'bi-brightness-low')
            } else {
                document.getElementById('dark-mode-toggle').setAttribute('checked', false)
                document.getElementById('dark-mode-icon').classList.replace('bi-brightness-low', 'bi-brightness-high-fill')
            }
        }

        // Returns true if the current theme is dark
        const isDark = () => {
            return document.documentElement.getAttribute('data-bs-theme') === 'dark'
        }

        // Toggles dark mode
        const toggleDarkMode = () => {
            const newTheme = isDark() ? 'light' : 'dark'
            setTheme(newTheme)
            localStorage.setItem('theme', newTheme)
        }

        // Set the preferred theme on page load
        window.onload = () => {
            // Set preferred theme
            setTheme(getPreferredTheme());
            // Initialize tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
            const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
        }

        // Toggle dark mode when the toggle button is clicked
        addEventListener("click", (event) => {
            if (event.target.id === 'dark-mode-toggle') {
                toggleDarkMode();
                // De-focus the toggle
                document.activeElement.blur()
            }
        });
    </script>
</body>
</html>
